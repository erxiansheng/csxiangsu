class PixelBackground{constructor(){this.canvas=document.getElementById("pixel-canvas"),this.ctx=this.canvas.getContext("2d"),this.time=0,this.lastTime=0,this.running=!0,this.fov=500,this.centerX=0,this.centerY=0,this.stars=[],this.gridLines=[],this.floatingWeapons=[],this.explosions=[],this.bullets=[],this.scene3d=null,this.camera3d=null,this.renderer3d=null,this.ctModel=null,this.tModel=null,this.colors={neon:["#00ffff","#ff00ff","#ffff00","#00ff00","#ff6600","#ff0066"],ct:["#4a9eff","#00ccff","#0088ff","#1e3a5f"],t:["#ff6600","#ff9900","#ffcc00","#5c4033"],explosion:["#ff0000","#ff6600","#ffff00","#ffffff"],metal:["#3a3a3a","#5a5a5a","#7a7a7a"],wood:["#5c4033","#7a5a43","#8b6914"]},this.resize(),window.addEventListener("resize",()=>this.resize()),this.init(),this.init3DScene(),this.animate()}resize(){this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight,this.centerX=this.canvas.width/2,this.centerY=this.canvas.height/2,this.renderer3d&&this.camera3d&&(this.renderer3d.setSize(window.innerWidth,window.innerHeight),this.camera3d.aspect=window.innerWidth/window.innerHeight,this.camera3d.updateProjectionMatrix())}init(){for(let t=0;t<150;t++)this.stars.push({x:2e3*(Math.random()-.5),y:2e3*(Math.random()-.5),z:2e3*Math.random(),size:2*Math.random()+.5,color:this.colors.neon[Math.floor(Math.random()*this.colors.neon.length)],speed:2*Math.random()+1});for(let t=0;t<30;t++)this.gridLines.push({z:100*t,alpha:1});this.createFloatingWeapon("ak47"),this.createFloatingWeapon("ak47"),this.createFloatingWeapon("m4a1"),this.createFloatingWeapon("m4a1"),this.createFloatingWeapon("awp"),this.createFloatingWeapon("awp"),this.createFloatingWeapon("pistol"),this.createFloatingWeapon("pistol"),this.createFloatingWeapon("ak47"),this.createFloatingWeapon("m4a1")}init3DScene(){if("undefined"==typeof THREE||"undefined"==typeof PlayerModel)return void console.warn("Three.js or PlayerModel not loaded, skipping 3D scene");this.scene3d=new THREE.Scene,this.camera3d=new THREE.PerspectiveCamera(50,window.innerWidth/window.innerHeight,.1,1e3),this.camera3d.position.set(0,12,50),this.camera3d.lookAt(0,8,0),this.renderer3d=new THREE.WebGLRenderer({alpha:!0,antialias:!0}),this.renderer3d.setSize(window.innerWidth,window.innerHeight),this.renderer3d.setClearColor(0,0),this.renderer3d.domElement.style.position="fixed",this.renderer3d.domElement.style.top="0",this.renderer3d.domElement.style.left="0",this.renderer3d.domElement.style.pointerEvents="none",this.renderer3d.domElement.style.zIndex="0";const t=document.getElementById("pixel-canvas");t&&t.parentNode?t.parentNode.insertBefore(this.renderer3d.domElement,t.nextSibling):document.body.appendChild(this.renderer3d.domElement);const i=new THREE.AmbientLight(16777215,.6);this.scene3d.add(i);const s=new THREE.DirectionalLight(16777215,.8);s.position.set(10,20,10),this.scene3d.add(s);const h=new THREE.PointLight(4890367,1,50);h.position.set(-25,15,0),this.scene3d.add(h);const a=new THREE.PointLight(16737792,1,50);a.position.set(25,15,0),this.scene3d.add(a),this.ctModel=PlayerModel.create("ct",!1,"m4a1"),this.ctModel.position.set(-25,0,0),this.ctModel.rotation.y=Math.PI/4,this.scene3d.add(this.ctModel),this.tModel=PlayerModel.create("t",!1,"ak47"),this.tModel.position.set(25,0,0),this.tModel.rotation.y=-Math.PI/4,this.scene3d.add(this.tModel),this.addGroundGlow(-25,4890367),this.addGroundGlow(25,16737792)}addGroundGlow(t,i){const s=new THREE.RingGeometry(8,10,32),h=new THREE.MeshBasicMaterial({color:i,transparent:!0,opacity:.3,side:THREE.DoubleSide}),a=new THREE.Mesh(s,h);a.rotation.x=-Math.PI/2,a.position.set(t,.1,0),this.scene3d.add(a)}createFloatingWeapon(t){const i=Math.random()>.3;this.floatingWeapons.push({x:i?-400-200*Math.random():400+200*Math.random(),y:100+150*Math.random(),z:150+300*Math.random(),vx:i?2+1.5*Math.random():-(2+1.5*Math.random()),vy:-(1.5+1*Math.random()),gravity:.02,rotX:Math.random()*Math.PI*2,rotY:Math.random()*Math.PI*2,rotZ:Math.random()*Math.PI*2,rotSpeedX:.04*(Math.random()-.5),rotSpeedY:.05*(Math.random()-.5),rotSpeedZ:.03*(Math.random()-.5),type:t,glowPhase:Math.random()*Math.PI*2})}createBullet(){const t=Math.random()>.5;this.bullets.push({x:t?0:this.canvas.width,y:.3*this.canvas.height+Math.random()*this.canvas.height*.4,vx:t?15+10*Math.random():-(15+10*Math.random()),vy:2*(Math.random()-.5),life:1,color:t?this.colors.ct[0]:this.colors.t[0]})}createExplosion(t,i){const s=[];for(let t=0;t<15;t++){const i=t/15*Math.PI*2,h=2+3*Math.random();s.push({x:0,y:0,vx:Math.cos(i)*h,vy:Math.sin(i)*h,size:2+3*Math.random(),life:1})}this.explosions.push({x:t,y:i,particles:s,time:0})}project(t,i,s){const h=this.fov/(this.fov+s);return{x:this.centerX+t*h,y:this.centerY+i*h,scale:h}}drawWeapon(t){const i=this.project(t.x,t.y,t.z);if(i.x<-100||i.x>this.canvas.width+100)return;const s=2*i.scale,h=.3*Math.sin(t.glowPhase)+.7;switch(this.ctx.save(),this.ctx.translate(i.x,i.y),this.ctx.rotate(t.rotY),this.ctx.scale(s,s),t.type){case"ak47":this.drawAK47(h);break;case"m4a1":this.drawM4A1(h);break;case"awp":this.drawAWP(h);break;case"pistol":this.drawPistol(h)}this.ctx.restore()}drawAK47(t){this.ctx.shadowColor="#ff6600",this.ctx.shadowBlur=15*t,this.ctx.fillStyle="#5c4033",this.ctx.fillRect(-40,-5,80,12),this.ctx.fillStyle="#3a3a3a",this.ctx.fillRect(40,-3,35,6),this.ctx.fillStyle="#4a3a2a",this.ctx.fillRect(-5,7,8,20),this.ctx.fillStyle="#5c4033",this.ctx.fillRect(-60,-3,20,8),this.ctx.fillStyle=`rgba(255, 102, 0, ${.3*t})`,this.ctx.fillRect(-40,-5,80,3),this.ctx.shadowBlur=0}drawM4A1(t){this.ctx.shadowColor="#4a9eff",this.ctx.shadowBlur=15*t,this.ctx.fillStyle="#1a1a1a",this.ctx.fillRect(-35,-5,70,10),this.ctx.fillStyle="#2a2a2a",this.ctx.fillRect(35,-3,30,6),this.ctx.fillStyle="#333333",this.ctx.fillRect(65,-4,20,8),this.ctx.fillStyle="#1a1a1a",this.ctx.fillRect(-5,5,6,18),this.ctx.fillStyle="#1a1a1a",this.ctx.fillRect(-55,-3,20,6),this.ctx.fillStyle=`rgba(74, 158, 255, ${.3*t})`,this.ctx.fillRect(-35,-5,70,2),this.ctx.shadowBlur=0}drawAWP(t){this.ctx.shadowColor="#00ff00",this.ctx.shadowBlur=15*t,this.ctx.fillStyle="#2d4a2d",this.ctx.fillRect(-45,-6,90,12),this.ctx.fillStyle="#2a2a2a",this.ctx.fillRect(45,-3,45,6),this.ctx.fillStyle="#3a3a3a",this.ctx.fillRect(-10,-15,30,8),this.ctx.fillStyle="#1a1a1a",this.ctx.beginPath(),this.ctx.arc(5,-11,4,0,2*Math.PI),this.ctx.fill(),this.ctx.fillStyle="#2d4a2d",this.ctx.fillRect(-5,6,8,15),this.ctx.fillStyle="#2d4a2d",this.ctx.fillRect(-65,-4,20,8),this.ctx.fillStyle=`rgba(0, 255, 0, ${.3*t})`,this.ctx.fillRect(-45,-6,90,2),this.ctx.shadowBlur=0}drawPistol(t){this.ctx.shadowColor="#ffff00",this.ctx.shadowBlur=12*t,this.ctx.fillStyle="#1a1a1a",this.ctx.fillRect(-15,-4,30,10),this.ctx.fillStyle="#2a2a2a",this.ctx.fillRect(15,-2,15,5),this.ctx.fillStyle="#3d2817",this.ctx.fillRect(-10,6,12,15),this.ctx.fillStyle=`rgba(255, 255, 0, ${.3*t})`,this.ctx.fillRect(-15,-4,30,2),this.ctx.shadowBlur=0}update(t){this.time+=.01*t,this.stars.forEach(t=>{t.z-=2*t.speed,t.z<1&&(t.z=2e3,t.x=2e3*(Math.random()-.5),t.y=2e3*(Math.random()-.5))}),this.gridLines.forEach(t=>{t.z-=3,t.z<0&&(t.z=3e3)});const i=t/16.67;this.floatingWeapons.forEach((t,s)=>{t.rotX+=3*t.rotSpeedX*i,t.rotY+=3*t.rotSpeedY*i,t.rotZ+=3*t.rotSpeedZ*i,t.glowPhase+=.12*i,t.x+=3*t.vx*i,t.vy+=t.gravity*i,t.y+=3*t.vy*i,t.z-=3.5*i;const h=this.project(t.x,t.y,t.z);if(h.x<-150||h.x>this.canvas.width+150||h.y<-150||h.y>this.canvas.height+150||t.z<20){const i=Math.random()>.3;t.z=500+200*Math.random(),t.x=i?-400-200*Math.random():400+200*Math.random(),t.y=100+150*Math.random(),t.vx=i?2+1.5*Math.random():-(2+1.5*Math.random()),t.vy=-(1.5+1*Math.random())}});const s=t/1e3*1.8;this.ctModel&&(this.ctModel.rotation.y+=s),this.tModel&&(this.tModel.rotation.y+=s),Math.random()<.03&&this.createBullet(),this.bullets.forEach((t,i)=>{t.x+=t.vx,t.y+=t.vy,t.life-=.01,(t.life<=0||t.x<-50||t.x>this.canvas.width+50)&&this.bullets.splice(i,1)}),Math.random()<.003&&this.createExplosion(.3*this.canvas.width+Math.random()*this.canvas.width*.4,.3*this.canvas.height+Math.random()*this.canvas.height*.4),this.explosions.forEach((t,i)=>{t.time+=.02,t.particles.forEach(t=>{t.x+=t.vx,t.y+=t.vy,t.vx*=.98,t.vy*=.98,t.life-=.02}),t.time>1&&this.explosions.splice(i,1)})}draw(){const t=this.ctx.createRadialGradient(this.centerX,this.centerY,0,this.centerX,this.centerY,Math.max(this.canvas.width,this.canvas.height));t.addColorStop(0,"#1a0a2e"),t.addColorStop(.5,"#0d0d1a"),t.addColorStop(1,"#000008"),this.ctx.fillStyle=t,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.strokeStyle="#00ffff20",this.ctx.lineWidth=1,this.gridLines.forEach(t=>{if(t.z>0){const i=this.project(-1500,300,t.z),s=this.project(1500,300,t.z),h=Math.max(0,1-t.z/3e3);this.ctx.strokeStyle=`rgba(0, 255, 255, ${.3*h})`,this.ctx.beginPath(),this.ctx.moveTo(i.x,i.y),this.ctx.lineTo(s.x,s.y),this.ctx.stroke()}});for(let t=-10;t<=10;t++){const i=150*t,s=this.project(i,300,100),h=this.project(i,300,3e3);this.ctx.strokeStyle="rgba(0, 255, 255, 0.15)",this.ctx.beginPath(),this.ctx.moveTo(s.x,s.y),this.ctx.lineTo(h.x,h.y),this.ctx.stroke()}this.stars.forEach(t=>{const i=this.project(t.x,t.y,t.z);if(i.x>0&&i.x<this.canvas.width&&i.y>0&&i.y<this.canvas.height){const s=t.size*i.scale*3,h=Math.min(1,(2e3-t.z)/1e3);if(this.ctx.fillStyle=t.color,this.ctx.globalAlpha=h,this.ctx.shadowColor=t.color,this.ctx.shadowBlur=2*s,this.ctx.beginPath(),this.ctx.arc(i.x,i.y,s,0,2*Math.PI),this.ctx.fill(),t.speed>2){this.ctx.globalAlpha=.3*h,this.ctx.beginPath(),this.ctx.moveTo(i.x,i.y);const a=this.project(t.x,t.y,t.z+50);this.ctx.lineTo(a.x,a.y),this.ctx.strokeStyle=t.color,this.ctx.lineWidth=.5*s,this.ctx.stroke()}}}),this.ctx.globalAlpha=1,this.ctx.shadowBlur=0,[...this.floatingWeapons].sort((t,i)=>i.z-t.z).forEach(t=>this.drawWeapon(t)),this.bullets.forEach(t=>{this.ctx.strokeStyle=t.color,this.ctx.lineWidth=2,this.ctx.shadowColor=t.color,this.ctx.shadowBlur=10,this.ctx.globalAlpha=t.life,this.ctx.beginPath(),this.ctx.moveTo(t.x,t.y),this.ctx.lineTo(t.x-3*t.vx,t.y-3*t.vy),this.ctx.stroke()}),this.ctx.globalAlpha=1,this.ctx.shadowBlur=0,this.renderer3d&&this.scene3d&&this.camera3d&&this.renderer3d.render(this.scene3d,this.camera3d),this.explosions.forEach(t=>{t.particles.forEach(i=>{if(i.life>0){const s=Math.floor((1-i.life)*this.colors.explosion.length);this.ctx.fillStyle=this.colors.explosion[Math.min(s,this.colors.explosion.length-1)],this.ctx.globalAlpha=i.life,this.ctx.shadowColor=this.ctx.fillStyle,this.ctx.shadowBlur=10,this.ctx.beginPath(),this.ctx.arc(t.x+i.x,t.y+i.y,i.size*i.life,0,2*Math.PI),this.ctx.fill()}})}),this.ctx.globalAlpha=1,this.ctx.shadowBlur=0;const i=this.ctx.createRadialGradient(this.centerX,this.centerY,0,this.centerX,this.centerY,300);i.addColorStop(0,"rgba(233, 69, 96, 0.1)"),i.addColorStop(.5,"rgba(83, 52, 131, 0.05)"),i.addColorStop(1,"transparent"),this.ctx.fillStyle=i,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.fillStyle="rgba(0, 0, 0, 0.03)";for(let t=0;t<this.canvas.height;t+=3)this.ctx.fillRect(0,t,this.canvas.width,1);const s=this.ctx.createRadialGradient(this.centerX,this.centerY,.3*Math.min(this.canvas.width,this.canvas.height),this.centerX,this.centerY,.7*Math.max(this.canvas.width,this.canvas.height));s.addColorStop(0,"transparent"),s.addColorStop(1,"rgba(0, 0, 0, 0.5)"),this.ctx.fillStyle=s,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)}animate(){if(!this.running)return;const t=performance.now(),i=t-this.lastTime;this.lastTime=t,this.update(i),this.draw(),requestAnimationFrame(()=>this.animate())}stop(){this.running=!1,this.renderer3d&&(this.renderer3d.domElement&&this.renderer3d.domElement.parentNode&&this.renderer3d.domElement.parentNode.removeChild(this.renderer3d.domElement),this.renderer3d.dispose(),this.renderer3d=null),this.scene3d&&(this.scene3d.traverse(t=>{t.geometry&&t.geometry.dispose(),t.material&&(Array.isArray(t.material)?t.material.forEach(t=>t.dispose()):t.material.dispose())}),this.scene3d=null),this.ctModel=null,this.tModel=null,this.camera3d=null}start(){this.running||(this.running=!0,this.lastTime=performance.now(),this.animate())}}class PixelMusic{constructor(){this.audioCtx=null,this.isPlaying=!1,this.isMuted=!1,this.masterGain=null,this.tempo=128,this.nextNoteTime=0,this.schedulerTimer=null,this.currentBeat=0,this.melodyIndex=0,this.bassIndex=0,this.arpIndex=0,this.melodies=[[{note:"E4",duration:.5},{note:"G4",duration:.25},{note:"A4",duration:.25},{note:"B4",duration:.5},{note:"A4",duration:.25},{note:"G4",duration:.25},{note:"E4",duration:.5},{note:"D4",duration:.25},{note:"E4",duration:.25},{note:"G4",duration:.75},{note:null,duration:.25}],[{note:"C5",duration:.25},{note:"B4",duration:.25},{note:"A4",duration:.25},{note:"G4",duration:.25},{note:"A4",duration:.5},{note:"E4",duration:.5},{note:"G4",duration:.25},{note:"A4",duration:.25},{note:"B4",duration:.5},{note:"A4",duration:.75},{note:null,duration:.25}]],this.bassLines=[[{note:"E2",duration:.5},{note:"E2",duration:.25},{note:"E3",duration:.25},{note:"E2",duration:.5},{note:"G2",duration:.5}],[{note:"A2",duration:.5},{note:"A2",duration:.25},{note:"A3",duration:.25},{note:"G2",duration:.5},{note:"E2",duration:.5}]],this.arpeggios=[[{note:"E3",duration:.125},{note:"G3",duration:.125},{note:"B3",duration:.125},{note:"E4",duration:.125},{note:"B3",duration:.125},{note:"G3",duration:.125},{note:"E3",duration:.125},{note:"G3",duration:.125}],[{note:"A3",duration:.125},{note:"C4",duration:.125},{note:"E4",duration:.125},{note:"A4",duration:.125},{note:"E4",duration:.125},{note:"C4",duration:.125},{note:"A3",duration:.125},{note:"C4",duration:.125}],[{note:"G3",duration:.125},{note:"B3",duration:.125},{note:"D4",duration:.125},{note:"G4",duration:.125},{note:"D4",duration:.125},{note:"B3",duration:.125},{note:"G3",duration:.125},{note:"B3",duration:.125}]],this.padChords=[["E3","G3","B3"],["A3","C4","E4"],["G3","B3","D4"],["D3","F#3","A3"]],this.setupControls()}setupControls(){const t=document.getElementById("music-toggle");t&&t.addEventListener("click",()=>this.toggle())}init(){this.audioCtx||(this.audioCtx=new(window.AudioContext||window.webkitAudioContext),this.masterGain=this.audioCtx.createGain(),this.masterGain.gain.value=.25,this.compressor=this.audioCtx.createDynamicsCompressor(),this.compressor.threshold.value=-24,this.compressor.ratio.value=12,this.reverb=this.createReverb(),this.reverbGain=this.audioCtx.createGain(),this.reverbGain.gain.value=.2,this.masterGain.connect(this.compressor),this.compressor.connect(this.audioCtx.destination),this.masterGain.connect(this.reverb),this.reverb.connect(this.reverbGain),this.reverbGain.connect(this.audioCtx.destination))}createReverb(){const t=this.audioCtx.createConvolver(),i=this.audioCtx.sampleRate,s=1.5*i,h=this.audioCtx.createBuffer(2,s,i);for(let t=0;t<2;t++){const i=h.getChannelData(t);for(let t=0;t<s;t++)i[t]=(2*Math.random()-1)*Math.pow(1-t/s,2)}return t.buffer=h,t}noteToFreq(t){if(!t)return 0;const i=t.match(/([A-G]#?)(\d)/);return i?440*Math.pow(2,({C:0,"C#":1,D:2,"D#":3,E:4,F:5,"F#":6,G:7,"G#":8,A:9,"A#":10,B:11}[i[1]]-9)/12+(parseInt(i[2])-4)):0}createMelodyOsc(t,i,s){const h=this.audioCtx.createOscillator(),a=this.audioCtx.createGain(),n=this.audioCtx.createBiquadFilter();h.type="square",h.frequency.value=t,n.type="lowpass",n.frequency.value=2e3,n.Q.value=2,a.gain.setValueAtTime(0,i),a.gain.linearRampToValueAtTime(.25,i+.02),a.gain.linearRampToValueAtTime(0,i+s),h.connect(n),n.connect(a),a.connect(this.masterGain),h.start(i),h.stop(i+s+.1)}createBassOsc(t,i,s){const h=this.audioCtx.createOscillator(),a=this.audioCtx.createOscillator(),n=this.audioCtx.createGain();h.type="triangle",h.frequency.value=t,a.type="sine",a.frequency.value=t,n.gain.setValueAtTime(0,i),n.gain.linearRampToValueAtTime(.35,i+.01),n.gain.linearRampToValueAtTime(0,i+s),h.connect(n),a.connect(n),n.connect(this.masterGain),h.start(i),h.stop(i+s+.1),a.start(i),a.stop(i+s+.1)}createArpOsc(t,i,s){const h=this.audioCtx.createOscillator(),a=this.audioCtx.createGain(),n=this.audioCtx.createBiquadFilter();h.type="sawtooth",h.frequency.value=t,n.type="lowpass",n.frequency.value=3e3,a.gain.setValueAtTime(0,i),a.gain.linearRampToValueAtTime(.12,i+.005),a.gain.linearRampToValueAtTime(0,i+s),h.connect(n),n.connect(a),a.connect(this.masterGain),h.start(i),h.stop(i+s+.1)}createPadOsc(t,i,s){t.forEach(t=>{const h=this.noteToFreq(t);if(0===h)return;const a=this.audioCtx.createOscillator(),n=this.audioCtx.createGain();a.type="sine",a.frequency.value=h,n.gain.setValueAtTime(0,i),n.gain.linearRampToValueAtTime(.06,i+.3),n.gain.linearRampToValueAtTime(0,i+s),a.connect(n),n.connect(this.masterGain),a.start(i),a.stop(i+s+.2)})}createKick(t){const i=this.audioCtx.createOscillator(),s=this.audioCtx.createGain();i.frequency.setValueAtTime(150,t),i.frequency.exponentialRampToValueAtTime(40,t+.15),s.gain.setValueAtTime(.6,t),s.gain.exponentialRampToValueAtTime(.01,t+.3),i.connect(s),s.connect(this.masterGain),i.start(t),i.stop(t+.3)}createSnare(t){const i=this.audioCtx.createOscillator(),s=this.audioCtx.createGain();i.frequency.value=200,s.gain.setValueAtTime(.3,t),s.gain.exponentialRampToValueAtTime(.01,t+.1),i.connect(s),s.connect(this.masterGain),i.start(t),i.stop(t+.1);const h=.15*this.audioCtx.sampleRate,a=this.audioCtx.createBuffer(1,h,this.audioCtx.sampleRate),n=a.getChannelData(0);for(let t=0;t<h;t++)n[t]=2*Math.random()-1;const o=this.audioCtx.createBufferSource();o.buffer=a;const e=this.audioCtx.createBiquadFilter();e.type="highpass",e.frequency.value=1e3;const r=this.audioCtx.createGain();r.gain.setValueAtTime(.35,t),r.gain.exponentialRampToValueAtTime(.01,t+.15),o.connect(e),e.connect(r),r.connect(this.masterGain),o.start(t)}createHihat(t,i=!1){const s=i?.15:.05,h=this.audioCtx.sampleRate*s,a=this.audioCtx.createBuffer(1,h,this.audioCtx.sampleRate),n=a.getChannelData(0);for(let t=0;t<h;t++)n[t]=2*Math.random()-1;const o=this.audioCtx.createBufferSource();o.buffer=a;const e=this.audioCtx.createBiquadFilter();e.type="highpass",e.frequency.value=7e3;const r=this.audioCtx.createGain();r.gain.setValueAtTime(i?.12:.08,t),r.gain.exponentialRampToValueAtTime(.01,t+s),o.connect(e),e.connect(r),r.connect(this.masterGain),o.start(t)}scheduleNote(){const t=60/this.tempo,i=t/4;for(;this.nextNoteTime<this.audioCtx.currentTime+.1;){const s=this.currentBeat%16,h=Math.floor(this.currentBeat/16)%4,a=Math.floor(this.currentBeat/64)%2,n=this.melodies[a],o=this.bassLines[a%this.bassLines.length],e=this.arpeggios[h%this.arpeggios.length];if(s%2==0&&this.melodyIndex<n.length){const i=n[this.melodyIndex%n.length];i.note&&this.createMelodyOsc(this.noteToFreq(i.note),this.nextNoteTime,i.duration*t),this.melodyIndex++}if(s%4==0){const i=o[this.bassIndex%o.length];i.note&&this.createBassOsc(this.noteToFreq(i.note),this.nextNoteTime,i.duration*t),this.bassIndex++}const r=e[this.arpIndex%e.length];r.note&&this.createArpOsc(this.noteToFreq(r.note),this.nextNoteTime,.9*i),this.arpIndex++,0===s&&this.createPadOsc(this.padChords[h%this.padChords.length],this.nextNoteTime,4*t),0!==s&&4!==s&&8!==s&&12!==s||this.createKick(this.nextNoteTime),6!==s&&14!==s||this.createKick(this.nextNoteTime),4!==s&&12!==s||this.createSnare(this.nextNoteTime),s%2==0&&this.createHihat(this.nextNoteTime,s%8==6),this.nextNoteTime+=i,this.currentBeat++}}play(){this.isPlaying||(this.init(),"suspended"===this.audioCtx.state?this.audioCtx.resume().then(()=>{this.startPlayback()}).catch(()=>{console.log("éŸ³é¢‘æ’­æ”¾éœ€è¦ç”¨æˆ·äº¤äº’")}):this.startPlayback())}startPlayback(){this.isPlaying=!0,this.isMuted=!1,this.nextNoteTime=this.audioCtx.currentTime,this.currentBeat=0,this.melodyIndex=0,this.bassIndex=0,this.arpIndex=0,this.schedulerTimer=setInterval(()=>{this.isPlaying&&!this.isMuted&&this.scheduleNote()},25),this.updateButton()}stop(){this.isPlaying=!1,this.schedulerTimer&&(clearInterval(this.schedulerTimer),this.schedulerTimer=null),this.updateButton()}toggle(){this.audioCtx||this.init(),this.isPlaying?(this.isMuted=!0,this.stop()):this.play()}updateButton(){const t=document.getElementById("music-toggle");t&&(t.textContent=this.isMuted||!this.isPlaying?"ðŸ”‡":"ðŸ”Š",t.classList.toggle("muted",this.isMuted||!this.isPlaying))}setVolume(t){this.masterGain&&(this.masterGain.gain.value=.25*t)}}let pixelBg=null,pixelMusic=null;document.addEventListener("DOMContentLoaded",()=>{pixelBg=new PixelBackground,pixelMusic=new PixelMusic;const t=()=>{!pixelMusic||pixelMusic.isPlaying||pixelMusic.isMuted||pixelMusic.play(),document.removeEventListener("click",t),document.removeEventListener("keydown",t),document.removeEventListener("touchstart",t),document.removeEventListener("mousedown",t)};document.addEventListener("click",t),document.addEventListener("keydown",t),document.addEventListener("touchstart",t),document.addEventListener("mousedown",t),"function"==typeof initMapSelect&&initMapSelect()});