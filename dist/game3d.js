const DEFAULT_WS_SERVER_URL="wss://cs16xs.188np.cn";let WS_SERVER_URL=localStorage.getItem("cs_server_url")||DEFAULT_WS_SERVER_URL;class PixelCS3D{constructor(){this.scene=null,this.camera=null,this.renderer=null,this.ws=null,this.playerId=null,this.players={},this.playerMeshes={},this.walls=[],this.keys={},this.velocity=new THREE.Vector3,this.isLocked=0,this.canJump=1,this.pitch=0,this.yaw=0,this.targetKills=20,this.selectedTeam="ct",this.selectedMap="indoor",this.selectedGameMode="deathmatch",this.isCreating=0,this.gameOver=0,this.ctKills=0,this.tKills=0,this.remainingTime=-1,this.pendingMouseX=0,this.pendingMouseY=0,this.isCrouching=0,this.standingHeight=10,this.crouchingHeight=6,this.currentHeight=10,this.currentStandingHeight=0,this.targetCameraHeight=10,this.primaryWeapon="ak47",this.secondaryWeapon="pistol",this.currentWeapon="ak47",this.previousWeapon="pistol",this.grenadeCount=1,this.gunModel=null,this.gunBasePosition=null,this.gunBaseRotation=null,this.gunRecoil=0,this.recoilAccumulator=0,this.weaponRecoil=.08,this.isReloading=0,this.ammo=30,this.maxAmmo=30,this.fireRate=100,this.lastShot=0,this.lastShotReleaseTime=0,this.isFiring=0,this.shotsFired=0,this.screenShake=0,this.reloadAnimProgress=0,this.isSwitchingWeapon=0,this.switchAnimProgress=0,this.crosshairOffset=0,this.isScoped=0,this.scopeLevel=0,this.normalFOV=75,this.scopedFOV1=20,this.scopedFOV2=8,this.buyMenuOpen=0,this.settingsMenuOpen=0,this.respawnTimer=null,this.respawnCountdown=3,this.baseSensitivity=.002,this.sensitivityMultiplier=1,this.scopeSensitivityMultiplier=.6,this.scopeSensitivityMultiplier2=.3,this.masterVolume=1,this.killStreak=0,this.lastKillTime=0,this.killStreakTimeout=5e3,this.targetFPS=120,this.frameInterval=1e3/this.targetFPS,this.lastFrameTime=0,this.fpsFrameCount=0,this.fpsLastTime=0,this.currentFPS=0,this.lastNetworkSend=0,this.networkSendInterval=33,this.minimap=null,this.isDefuseMode=0,this.hasC4=0,this.c4Planted=0,this.c4Position=null,this.c4Site=null,this.isPlanting=0,this.isDefusing=0,this.plantProgress=0,this.defuseProgress=0,this.plantInterval=null,this.c4Model=null,this.c4Light=null,this.c4Glow=null,this.c4Beam=null,this.customMapData=null,this.isSpectating=0,this.spectatingPlayerId=null,this.spectatorTargets=[],this.reconnectAttempts=0,this.maxReconnectAttempts=5,this.reconnectDelay=1e3,this.isReconnecting=0,this.connectionInfo=null,this.audio=new AudioSystem,this.weaponBuilder=null,this.setupEventListeners(),this.setupVisibilityHandler()}setupVisibilityHandler(){document.addEventListener("visibilitychange",()=>{"visible"===document.visibilityState&&this.ws&&this.ws.readyState!==WebSocket.OPEN&&this.connectionInfo&&(console.log("é¡µé¢æ¢å¤å¯è§ï¼Œæ£€æµ‹åˆ°è¿æ¥æ–­å¼€ï¼Œå°è¯•é‡è¿..."),this.attemptReconnect())}),window.addEventListener("online",()=>{this.ws&&this.ws.readyState!==WebSocket.OPEN&&this.connectionInfo&&(console.log("ç½‘ç»œæ¢å¤ï¼Œå°è¯•é‡è¿..."),this.attemptReconnect())})}setupEventListeners(){document.getElementById("joinBtn").addEventListener("click",()=>this.joinGame()),document.getElementById("createBtn").addEventListener("click",()=>this.createGame()),document.getElementById("teamCT").addEventListener("click",()=>this.selectTeam("ct")),document.getElementById("teamT").addEventListener("click",()=>this.selectTeam("t")),document.getElementById("tabJoin").addEventListener("click",()=>this.switchTab(0)),document.getElementById("tabCreate").addEventListener("click",()=>this.switchTab(1)),document.getElementById("gameMode").addEventListener("change",t=>this.onGameModeChange(t.target.value)),document.querySelectorAll(".buy-btn").forEach(t=>{t.addEventListener("click",()=>this.buyPrimaryWeapon(t.dataset.weapon))}),document.addEventListener("keydown",t=>this.onKeyDown(t),{capture:1}),document.addEventListener("keyup",t=>this.onKeyUp(t),{capture:1}),document.addEventListener("mousedown",t=>this.onMouseDown(t)),document.addEventListener("mouseup",t=>this.onMouseUp(t)),document.addEventListener("contextmenu",t=>t.preventDefault()),document.addEventListener("pointerlockchange",()=>{this.isMobile?this.isLocked=1:(this.isLocked=null!==document.pointerLockElement,this.isLocked||(this.isFiring=0))}),this.preloadMaps(),this.loadAnnouncement(),this.initCustomMapImport(),this.initServerConfig(),this.initMobileControls()}initMobileControls(){if(this.isMobile=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)||"ontouchstart"in window||navigator.maxTouchPoints>0,!this.isMobile)return;const t=document.getElementById("mobile-controls");t&&(t.style.display="block",this.isLocked=1,this.setupJoystick(),this.setupMobileButtons(),this.setupTouchLook(),this.lockLandscape())}lockLandscape(){screen.orientation&&screen.orientation.lock&&screen.orientation.lock("landscape").catch(()=>{console.log("æ— æ³•é”å®šå±å¹•æ–¹å‘")})}setupJoystick(){const t=document.getElementById("joystick-base"),s=document.getElementById("joystick-stick");if(!t||!s)return;let i=0,e=null,h={x:0,y:0};const n=(t,e)=>{if(!i)return;const n=t-h.x,o=e-h.y,c=Math.sqrt(n*n+o*o),a=Math.min(c,35),r=Math.atan2(o,n),u=Math.cos(r)*a,l=Math.sin(r)*a;s.style.transform=`translate(${u}px, ${l}px)`,this.keys.KeyW=o<-10,this.keys.KeyS=o>10,this.keys.KeyA=n<-10,this.keys.KeyD=n>10};t.addEventListener("touchstart",s=>{s.preventDefault(),s.stopPropagation();const o=s.changedTouches[0];i=1,e=o.identifier;const c=t.getBoundingClientRect();h={x:c.left+c.width/2,y:c.top+c.height/2},n(o.clientX,o.clientY)},{passive:0}),document.addEventListener("touchmove",t=>{if(i)for(let s=0;s<t.touches.length;s++)if(t.touches[s].identifier===e){n(t.touches[s].clientX,t.touches[s].clientY);break}},{passive:1}),document.addEventListener("touchend",t=>{for(let h=0;h<t.changedTouches.length;h++)if(t.changedTouches[h].identifier===e){i=0,e=null,s.style.transform="translate(0, 0)",this.keys.KeyW=0,this.keys.KeyS=0,this.keys.KeyA=0,this.keys.KeyD=0;break}})}setupMobileButtons(){const t=document.getElementById("mobile-shoot");if(t){let s=null,i=0,e=0,h=0;const n=this;t.addEventListener("touchstart",t=>{t.preventDefault(),t.stopPropagation();const o=t.changedTouches[0];s=o.identifier,i=o.clientX,e=o.clientY,h=0,n.isDefuseMode&&"c4"===n.currentWeapon&&n.hasC4&&!n.c4Planted&&n.isInBombSite()?n.startPlantingC4():"awp"===n.currentWeapon&&n.isScoped||"c4"!==n.currentWeapon&&(n.isFiring=1,n.shoot())},{passive:0}),document.addEventListener("touchmove",t=>{if(null!==s)for(let o=0;o<t.touches.length;o++)if(t.touches[o].identifier===s){const s=t.touches[o],c=s.clientX-i,a=s.clientY-e;(Math.abs(c)>3||Math.abs(a)>3)&&(h=1);const r=.006*n.sensitivityMultiplier;n.yaw-=c*r,n.pitch-=a*r,n.pitch=Math.max(-Math.PI/2+.1,Math.min(Math.PI/2-.1,n.pitch)),!n.isSpectating&&n.camera&&(n.camera.rotation.order="YXZ",n.camera.rotation.y=n.yaw,n.camera.rotation.x=n.pitch),i=s.clientX,e=s.clientY;break}},{passive:1}),document.addEventListener("touchend",t=>{if(null!==s)for(let i=0;i<t.changedTouches.length;i++)if(t.changedTouches[i].identifier===s){n.isPlanting&&n.cancelPlanting(),"awp"===n.currentWeapon&&n.isScoped&&n.shoot(),n.isFiring=0,s=null,h=0;break}}),document.addEventListener("touchcancel",t=>{null!==s&&(n.isPlanting&&n.cancelPlanting(),"awp"===n.currentWeapon&&n.isScoped&&n.shoot(),n.isFiring=0,s=null,h=0)})}const s=document.getElementById("mobile-reload");s&&s.addEventListener("touchstart",t=>{t.preventDefault(),t.stopPropagation(),this.reload()},{passive:0});const i=document.getElementById("mobile-jump");i&&(i.addEventListener("touchstart",t=>{t.preventDefault(),t.stopPropagation(),this.keys.Space=1},{passive:0}),i.addEventListener("touchend",()=>{this.keys.Space=0}));const e=document.getElementById("mobile-crouch");if(e){let t=null;e.addEventListener("touchstart",s=>{s.preventDefault(),s.stopPropagation(),t=s.changedTouches[0].identifier,this.camera?this.setCrouch(1):this.isCrouching=1},{passive:0}),e.addEventListener("touchend",s=>{for(let i=0;i<s.changedTouches.length;i++)if(s.changedTouches[i].identifier===t){t=null,this.camera?this.setCrouch(0):this.isCrouching=0;break}}),e.addEventListener("touchcancel",()=>{t=null,this.camera?this.setCrouch(0):this.isCrouching=0})}const h=document.getElementById("mobile-switch");h&&h.addEventListener("touchstart",t=>{t.preventDefault(),t.stopPropagation(),this.switchToPrevious()},{passive:0});const n=document.getElementById("mobile-buy");n&&n.addEventListener("touchstart",t=>{t.preventDefault(),t.stopPropagation(),this.toggleBuyMenu()},{passive:0});const o=document.getElementById("mobile-settings");o&&o.addEventListener("touchstart",t=>{t.preventDefault(),t.stopPropagation(),this.toggleSettingsMenu()},{passive:0});const c=document.getElementById("mobile-scope");c&&c.addEventListener("touchstart",t=>{t.preventDefault(),t.stopPropagation(),"awp"===this.currentWeapon&&this.toggleScope()},{passive:0}),document.querySelectorAll(".weapon-slot").forEach(t=>{t.addEventListener("touchstart",s=>{s.preventDefault(),s.stopPropagation();const i=parseInt(t.dataset.slot);this.switchToSlot(i)},{passive:0})});const a=document.getElementById("mobile-defuse");if(a){let t=null;const s=this;a.addEventListener("touchstart",i=>{i.preventDefault(),i.stopPropagation(),t=i.changedTouches[0].identifier,s.tryDefuse(),s.keys.KeyE=1},{passive:0}),a.addEventListener("touchend",i=>{for(let e=0;e<i.changedTouches.length;e++)if(i.changedTouches[e].identifier===t){t=null,s.keys.KeyE=0,s.cancelDefuse();break}}),a.addEventListener("touchcancel",()=>{t=null,s.keys.KeyE=0,s.cancelDefuse()})}}updateMobileDefuseButton(){if(!this.isMobile)return;const t=document.getElementById("mobile-defuse");t&&(this.isDefuseMode&&this.c4Planted&&"ct"===this.selectedTeam&&this.isNearC4()?t.style.display="block":t.style.display="none")}setupTouchLook(){const t=document.getElementById("game");if(!t)return;let s=0,i=0,e=0,h=null;t.addEventListener("touchstart",t=>{for(let n=0;n<t.changedTouches.length;n++){const o=t.changedTouches[n];if(o.clientX>window.innerWidth/3&&!e){e=1,h=o.identifier,s=o.clientX,i=o.clientY;break}}},{passive:1}),t.addEventListener("touchmove",t=>{if(!e)return;let n=null;for(let s=0;s<t.touches.length;s++)if(t.touches[s].identifier===h){n=t.touches[s];break}if(!n)return;const o=n.clientX-s,c=n.clientY-i,a=.008*this.sensitivityMultiplier;this.yaw-=o*a,this.pitch-=c*a,this.pitch=Math.max(-Math.PI/2+.1,Math.min(Math.PI/2-.1,this.pitch)),this.isSpectating||(this.camera.rotation.order="YXZ",this.camera.rotation.y=this.yaw,this.camera.rotation.x=this.pitch),s=n.clientX,i=n.clientY},{passive:1}),t.addEventListener("touchend",t=>{for(let s=0;s<t.changedTouches.length;s++)if(t.changedTouches[s].identifier===h){e=0,h=null;break}})}initServerConfig(){const t=document.getElementById("serverUrl"),s=document.getElementById("saveServerBtn"),i=document.getElementById("currentServer");if(!t||!s)return;const e=localStorage.getItem("cs_server_url");e?(t.value=e,i.textContent="å½“å‰: "+e):i.textContent="å½“å‰: é»˜è®¤æœåŠ¡å™¨",s.addEventListener("click",()=>{const s=t.value.trim();if(s){if(!s.startsWith("ws://")&&!s.startsWith("wss://"))return void alert("æœåŠ¡å™¨åœ°å€å¿…é¡»ä»¥ ws:// æˆ– wss:// å¼€å¤´");localStorage.setItem("cs_server_url",s),WS_SERVER_URL=s,i.textContent="å½“å‰: "+s,alert("æœåŠ¡å™¨åœ°å€å·²ä¿å­˜")}else localStorage.removeItem("cs_server_url"),WS_SERVER_URL=DEFAULT_WS_SERVER_URL,i.textContent="å½“å‰: é»˜è®¤æœåŠ¡å™¨",alert("å·²æ¢å¤é»˜è®¤æœåŠ¡å™¨")})}async loadAnnouncement(){if(document.getElementById("announcement-content"))try{const t=new WebSocket(WS_SERVER_URL);t.onopen=()=>{t.send(JSON.stringify({action:"get_announcement"}))},t.onmessage=s=>{try{const t=JSON.parse(s.data);"announcement"===t.action&&this.displayAnnouncement(t)}catch(t){console.log("è§£æå…¬å‘Šå¤±è´¥")}t.close()},t.onerror=()=>{this.displayDefaultAnnouncement()},setTimeout(()=>{t.readyState!==WebSocket.OPEN&&t.readyState!==WebSocket.CONNECTING||(t.close(),this.displayDefaultAnnouncement())},3e3)}catch(t){this.displayDefaultAnnouncement()}}displayAnnouncement(t){const s=document.getElementById("announcement-content");if(!s)return;let i="";t.announcements&&t.announcements.length>0?(t.announcements.forEach(t=>{i+=`<div class="announcement-item"><span class="announcement-date">${t.date||""}</span><p class="announcement-text">${t.content}</p></div>`}),s.innerHTML=i):this.displayDefaultAnnouncement()}displayDefaultAnnouncement(){const t=document.getElementById("announcement-content");t&&(t.innerHTML='\n            <div class="announcement-item"><span class="announcement-date">2024-12-28</span><p class="announcement-text">ğŸ‰ æ¬¢è¿æ¥åˆ° CS 1.6 åƒç´ ç‰ˆï¼</p></div>\n            <div class="announcement-item"><span class="announcement-date">2024-12-28</span><p class="announcement-text">ğŸ”« æ–°å¢æ­¦å™¨ï¼šAK47ã€M4A1ã€AWP</p></div>\n            <div class="announcement-item"><span class="announcement-date">2024-12-28</span><p class="announcement-text">ğŸ—ºï¸ å¤šå¼ ç»å…¸åœ°å›¾å¯é€‰</p></div>\n            <div class="announcement-item"><span class="announcement-date">2024-12-28</span><p class="announcement-text">âš¡ æ”¯æŒä¸‹è¹²è·³è·ƒæ“ä½œ</p></div>\n        ')}preloadMaps(){const t=document.createElement("div");t.id="preload-status",t.style.cssText="position:fixed;bottom:10px;left:10px;color:#0f0;font-size:12px;font-family:monospace;z-index:9999;",t.textContent="æ­£åœ¨é¢„åŠ è½½åœ°å›¾èµ„æº...",document.body.appendChild(t);const s=()=>{preloadAllMaps((s,i)=>{t.textContent=`é¢„åŠ è½½åœ°å›¾: ${i} (${s}%)`},()=>{t.textContent="âœ“ åœ°å›¾èµ„æºåŠ è½½å®Œæˆ",setTimeout(()=>t.remove(),2e3)})};window.requestIdleCallback?requestIdleCallback(s,{timeout:1e3}):setTimeout(s,100)}onKeyDown(t){if(this.isLocked&&((t.ctrlKey||"ControlLeft"===t.code||"ControlRight"===t.code)&&(t.preventDefault(),t.stopPropagation()),["KeyW","KeyA","KeyS","KeyD","Space","KeyR","KeyQ","KeyB"].includes(t.code)&&(t.preventDefault(),t.stopPropagation())),this.keys[t.code]=1,"KeyR"===t.code&&!this.isReloading&&"knife"!==this.currentWeapon&&"grenade"!==this.currentWeapon){const t=WeaponConfigs[this.currentWeapon];this.ammo<t.ammo&&this.reload()}"ControlLeft"!==t.code&&"ControlRight"!==t.code||(t.preventDefault(),this.setCrouch(1)),this.buyMenuOpen||this.settingsMenuOpen||("Digit1"===t.code&&this.switchToSlot(1),"Digit2"===t.code&&this.switchToSlot(2),"Digit3"===t.code&&this.switchToSlot(3),"Digit4"===t.code&&this.switchToSlot(4),"Digit5"===t.code&&this.switchToC4()),"KeyQ"===t.code&&this.switchToPrevious(),"KeyB"===t.code&&this.toggleBuyMenu(),"Escape"===t.code&&this.toggleSettingsMenu(),"KeyE"===t.code&&this.isDefuseMode&&!t.repeat&&(this.hasC4&&"t"===this.selectedTeam?this.startPlantingC4():this.c4Planted&&"ct"===this.selectedTeam&&this.tryDefuse()),this.buyMenuOpen&&("Digit1"===t.code&&(this.buyPrimaryWeapon("ak47"),t.preventDefault()),"Digit2"===t.code&&(this.buyPrimaryWeapon("m4a1"),t.preventDefault()),"Digit3"===t.code&&(this.buyPrimaryWeapon("awp"),t.preventDefault()))}switchToC4(){this.isDefuseMode&&this.hasC4&&(this.isReloading||this.isSwitchingWeapon||"c4"!==this.currentWeapon&&this.startWeaponSwitch("c4"))}onKeyUp(t){this.keys[t.code]=0,"ControlLeft"!==t.code&&"ControlRight"!==t.code||this.setCrouch(0),"KeyE"===t.code&&(this.isDefusing&&this.cancelDefuse(),this.isPlanting&&this.cancelPlanting())}onMouseDown(t){if(!this.buyMenuOpen&&this.isLocked){if(0===t.button){if(this.isSpectating)return void this.switchSpectatorTarget();if(this.isDefuseMode&&"c4"===this.currentWeapon&&this.hasC4&&!this.c4Planted&&this.isInBombSite())return void this.startPlantingC4();if("c4"!==this.currentWeapon){this.isFiring=1;const t=WeaponConfigs[this.currentWeapon];t&&t.auto||this.shoot()}}2===t.button&&this.toggleScope()}}onMouseUp(t){0===t.button&&(this.isFiring=0,this.lastShotReleaseTime=Date.now(),this.isPlanting&&this.cancelPlanting())}onMouseMove(t){if(!this.isLocked||this.buyMenuOpen||this.settingsMenuOpen)return;const s=t.movementX||0,i=t.movementY||0;Math.abs(s)>200||Math.abs(i)>200||(this.pendingMouseX+=s,this.pendingMouseY+=i)}processMouseMovement(){if(0===this.pendingMouseX&&0===this.pendingMouseY)return;const t=this.baseSensitivity*this.sensitivityMultiplier;let s=t;1===this.scopeLevel?s=t*this.scopeSensitivityMultiplier:2===this.scopeLevel&&(s=t*this.scopeSensitivityMultiplier2),this.yaw-=this.pendingMouseX*s,this.pitch-=this.pendingMouseY*s,this.pitch=Math.max(-Math.PI/2+.1,Math.min(Math.PI/2-.1,this.pitch)),this.camera.rotation.order="YXZ",this.camera.rotation.y=this.yaw,this.camera.rotation.x=this.pitch,this.pendingMouseX=0,this.pendingMouseY=0}switchTab(t){this.isCreating=t,document.getElementById("tabJoin").classList.toggle("active",!t),document.getElementById("tabCreate").classList.toggle("active",t),document.getElementById("createOptions").style.display=t?"block":"none",document.getElementById("joinBtn").style.display=t?"none":"block",document.getElementById("createBtn").style.display=t?"block":"none"}selectTeam(t){this.selectedTeam=t,document.getElementById("teamCT").classList.toggle("active","ct"===t),document.getElementById("teamT").classList.toggle("active","t"===t)}onGameModeChange(t){const s=document.getElementById("targetKillsGroup"),i=document.getElementById("mapSelectGroup"),e=document.getElementById("customMapGroup");document.getElementById("mapSelect"),updateMapSelect("custom"===t?"deathmatch":t),"defuse"===t?(s.style.display="none",i.style.display="block",e.style.display="none"):"custom"===t?(i.style.display="none",e.style.display="block",s.style.display="none"):(s.style.display="block",i.style.display="block",e.style.display="none")}initCustomMapImport(){const t=document.getElementById("customMapFile"),s=document.getElementById("importMapBtn"),i=document.getElementById("cloudMapBtn");if(!t||!s)return;s.addEventListener("click",()=>t.click()),t.addEventListener("change",s=>{const i=s.target.files[0];if(!i)return;const e=new FileReader;e.onload=s=>{try{const e=JSON.parse(s.target.result),h=this.validateCustomMap(e);if(!h.valid)return alert("åœ°å›¾æ–‡ä»¶æ ¼å¼é”™è¯¯: "+h.error),t.value="",void(document.getElementById("customMapName").textContent="æœªé€‰æ‹©åœ°å›¾");this.loadCustomMap(e),document.getElementById("customMapName").textContent="ğŸ“ "+(e.displayName||i.name)}catch(s){alert("åœ°å›¾æ–‡ä»¶è§£æå¤±è´¥: JSONæ ¼å¼é”™è¯¯"),t.value="",document.getElementById("customMapName").textContent="æœªé€‰æ‹©åœ°å›¾",console.error("åœ°å›¾åŠ è½½å¤±è´¥:",s)}},e.readAsText(i)}),i&&i.addEventListener("click",()=>this.showCloudMapModal());const e=document.getElementById("cloud-map-close"),h=document.getElementById("cloud-map-refresh");e&&e.addEventListener("click",()=>this.hideCloudMapModal()),h&&h.addEventListener("click",()=>this.loadCloudMapList())}showCloudMapModal(){const t=document.getElementById("cloud-map-modal");t&&(t.style.display="flex",this.loadCloudMapList())}hideCloudMapModal(){const t=document.getElementById("cloud-map-modal");t&&(t.style.display="none")}async loadCloudMapList(){const t=document.getElementById("cloud-map-loading"),s=document.getElementById("cloud-map-error"),i=document.getElementById("cloud-map-empty"),e=document.getElementById("cloud-map-list");if(t&&e){t.style.display="block",s.style.display="none",i.style.display="none",e.innerHTML="";try{const s=await MapCloudService.listMaps();if(t.style.display="none",0===s.length)return void(i.style.display="block");s.forEach(t=>{const s=document.createElement("div");s.className="cloud-map-item";const i=t.likes||0,h=t.thumbnail||"";s.innerHTML=`\n                    ${h?`<div class="cloud-map-thumb" data-thumb="${h}"><img src="${h}" alt=""></div>`:'<div class="cloud-map-thumb no-thumb">æ— é¢„è§ˆ</div>'}\n                    <div class="cloud-map-item-info">\n                        <div class="cloud-map-item-name">${this.escapeHtml(t.displayName||t.name)}</div>\n                        <div class="cloud-map-item-id">${this.escapeHtml(t.id)}</div>\n                    </div>\n                    <div class="cloud-map-item-actions">\n                        <button class="pixel-btn small cloud-like-btn ${this.hasLikedMap(t.id)?"liked":""}" data-id="${this.escapeHtml(t.id)}" ${this.hasLikedMap(t.id)?"disabled":""}>ğŸ‘ <span class="like-count">${i}</span></button>\n                        <button class="pixel-btn small primary cloud-select-btn">é€‰æ‹©</button>\n                    </div>\n                `;const n=s.querySelector(".cloud-map-thumb[data-thumb]");n&&(n.style.cursor="pointer",n.addEventListener("click",t=>{t.stopPropagation(),this.showThumbnailPreview(h)})),s.querySelector(".cloud-map-item-info").addEventListener("click",()=>this.selectCloudMap(t.id)),s.querySelector(".cloud-select-btn").addEventListener("click",()=>this.selectCloudMap(t.id)),s.querySelector(".cloud-like-btn").addEventListener("click",async s=>{s.stopPropagation();const i=s.currentTarget,e=t.id;if(!this.hasLikedMap(e)){i.disabled=1;try{const t=await MapCloudService.likeMap(e);i.querySelector(".like-count").textContent=t.likes,this.markMapAsLiked(e),i.classList.add("liked")}catch(t){console.error("ç‚¹èµå¤±è´¥:",t),i.disabled=0}}}),e.appendChild(s)})}catch(i){t.style.display="none",s.textContent=i.message,s.style.display="block"}}}async selectCloudMap(t){try{const s=await MapCloudService.getMap(t),i=this.validateCustomMap(s);if(!i.valid)return void alert("äº‘ç«¯åœ°å›¾æ ¼å¼é”™è¯¯: "+i.error);this.loadCustomMap(s),document.getElementById("customMapName").textContent="â˜ï¸ "+(s.displayName||t),this.hideCloudMapModal()}catch(t){alert("åŠ è½½äº‘ç«¯åœ°å›¾å¤±è´¥: "+t.message)}}escapeHtml(t){const s=document.createElement("div");return s.textContent=t||"",s.innerHTML}hasLikedMap(t){try{return JSON.parse(localStorage.getItem("likedMaps")||"[]").includes(t)}catch{return 0}}markMapAsLiked(t){try{const s=JSON.parse(localStorage.getItem("likedMaps")||"[]");s.includes(t)||(s.push(t),localStorage.setItem("likedMaps",JSON.stringify(s)))}catch{}}showThumbnailPreview(t){let s=document.getElementById("thumbnail-preview");s||(s=document.createElement("div"),s.id="thumbnail-preview",s.innerHTML='\n                <div class="thumb-preview-content">\n                    <img src="" alt="åœ°å›¾é¢„è§ˆ">\n                    <button class="thumb-preview-close">âœ•</button>\n                </div>\n            ',s.addEventListener("click",t=>{(t.target===s||t.target.classList.contains("thumb-preview-close"))&&s.classList.remove("active")}),document.body.appendChild(s)),s.querySelector("img").src=t,s.classList.add("active")}validateCustomMap(t){if(!t||"object"!=typeof t)return{valid:0,error:"æ— æ•ˆçš„åœ°å›¾æ•°æ®"};if(!t.name||"string"!=typeof t.name||""===t.name.trim())return{valid:0,error:"ç¼ºå°‘åœ°å›¾åç§°(name)"};if(void 0!==t.mapSize&&("number"!=typeof t.mapSize||t.mapSize<50||t.mapSize>1e3))return{valid:0,error:"åœ°å›¾å¤§å°(mapSize)å¿…é¡»åœ¨50-1000ä¹‹é—´"};if(void 0!==t.gameMode){if(!Array.isArray(t.gameMode))return{valid:0,error:"æ¸¸æˆæ¨¡å¼(gameMode)å¿…é¡»æ˜¯æ•°ç»„"};const s=["deathmatch","defuse"];for(const i of t.gameMode)if(!s.includes(i))return{valid:0,error:"æ— æ•ˆçš„æ¸¸æˆæ¨¡å¼: "+i}}if(void 0!==t.objects){if(!Array.isArray(t.objects))return{valid:0,error:"ç‰©ä½“åˆ—è¡¨(objects)å¿…é¡»æ˜¯æ•°ç»„"};for(let s=0;s<t.objects.length;s++){const i=t.objects[s];if(!i||"object"!=typeof i)return{valid:0,error:`ç‰©ä½“[${s}]æ ¼å¼æ— æ•ˆ`};if("number"!=typeof i.x||"number"!=typeof i.z)return{valid:0,error:`ç‰©ä½“[${s}]ç¼ºå°‘æœ‰æ•ˆåæ ‡(x,z)`}}}if(t.gameMode&&t.gameMode.includes("defuse")){if(!t.bombSites||"object"!=typeof t.bombSites)return{valid:0,error:"çˆ†ç ´æ¨¡å¼éœ€è¦åŒ…ç‚¹é…ç½®(bombSites)"};if(!t.spawnPoints||"object"!=typeof t.spawnPoints)return{valid:0,error:"çˆ†ç ´æ¨¡å¼éœ€è¦å‡ºç”Ÿç‚¹é…ç½®(spawnPoints)"}}return{valid:1}}loadCustomMap(t){this.customMapData=t;const s=document.getElementById("targetKillsGroup"),i=t.gameMode||["deathmatch"];i.includes("defuse")?(this.selectedGameMode="defuse",s.style.display="none"):(this.selectedGameMode="deathmatch",s.style.display="block");const e=t.name||"custom_imported";let h=7058393;void 0!==t.skyColor&&(h="string"==typeof t.skyColor?parseInt(t.skyColor.replace("0x",""),16)||7058393:t.skyColor),MapConfigs[e]={displayName:t.displayName||"è‡ªå®šä¹‰åœ°å›¾",gameMode:i,floorColor1:t.floorColor1||"#c4a574",floorColor2:t.floorColor2||"#a68b5b",wallColor1:t.wallColor1||"#95a5a6",wallColor2:t.wallColor2||"#7f8c8d",skyColor:h,mapSize:t.mapSize||300,obstacles:this.convertObjectsToObstacles(t.objects||[]),bombSites:t.bombSites||{},spawnPoints:t.spawnPoints||{}},this.selectedMap=e,console.log("è‡ªå®šä¹‰åœ°å›¾å·²åŠ è½½:",e,MapConfigs[e])}convertObjectsToObstacles(t){const s=[];return t.forEach(t=>{"floor"!==t.type&&"bombsite_a"!==t.type&&"bombsite_b"!==t.type&&"spawn_ct"!==t.type&&"spawn_t"!==t.type&&s.push({x:t.x,y:t.y,z:t.z,w:t.w,h:t.h,d:t.d,color:t.color,rotation:t.rotation,textureType:t.textureType,type:t.type})}),s}toggleBuyMenu(){this.settingsMenuOpen||(this.buyMenuOpen=!this.buyMenuOpen,document.getElementById("buy-menu").style.display=this.buyMenuOpen?"flex":"none",this.buyMenuOpen?document.exitPointerLock():document.body.requestPointerLock())}toggleSettingsMenu(){this.buyMenuOpen||(this.settingsMenuOpen=!this.settingsMenuOpen,document.getElementById("settings-menu").style.display=this.settingsMenuOpen?"block":"none",this.settingsMenuOpen?(document.exitPointerLock(),this.setupSettingsListeners()):document.body.requestPointerLock())}setupSettingsListeners(){const t=document.getElementById("sensitivity-slider"),s=document.getElementById("scope-sensitivity-slider"),i=document.getElementById("volume-slider"),e=document.getElementById("resumeGame"),h=document.getElementById("toggleFullscreen"),n=document.getElementById("exitGame");t&&!t.hasListener&&(t.hasListener=1,t.value=5*this.sensitivityMultiplier,document.getElementById("sens-value").textContent=t.value,t.addEventListener("input",t=>{const s=parseFloat(t.target.value);this.sensitivityMultiplier=s/5,document.getElementById("sens-value").textContent=s})),s&&!s.hasListener&&(s.hasListener=1,s.value=10*this.scopeSensitivityMultiplier,document.getElementById("scope-sens-value").textContent=s.value,s.addEventListener("input",t=>{const s=parseFloat(t.target.value);this.scopeSensitivityMultiplier=s/10,document.getElementById("scope-sens-value").textContent=s})),i&&!i.hasListener&&(i.hasListener=1,i.value=100*this.masterVolume,document.getElementById("volume-value").textContent=i.value,i.addEventListener("input",t=>{const s=parseInt(t.target.value);this.masterVolume=s/100,this.audio.setVolume(this.masterVolume),document.getElementById("volume-value").textContent=s})),e&&!e.hasListener&&(e.hasListener=1,e.addEventListener("click",()=>this.toggleSettingsMenu())),h&&!h.hasListener&&(h.hasListener=1,h.addEventListener("click",()=>{document.fullscreenElement?(document.exitFullscreen(),h.textContent="è¿›å…¥å…¨å±"):(document.documentElement.requestFullscreen().catch(()=>{}),h.textContent="é€€å‡ºå…¨å±"),this.settingsMenuOpen=0,document.getElementById("settings-menu").style.display="none",setTimeout(()=>document.body.requestPointerLock(),100)})),n&&!n.hasListener&&(n.hasListener=1,n.addEventListener("click",()=>this.backToMenu()))}updateAmmoDisplay(){const t=WeaponConfigs[this.currentWeapon],s=t?t.name:"AK-47";"knife"===this.currentWeapon||"c4"===this.currentWeapon?document.getElementById("weapon").textContent=s:"grenade"===this.currentWeapon?document.getElementById("weapon").textContent=`${s} x${this.grenadeCount}`:document.getElementById("weapon").textContent=`${s} ${this.ammo}/${this.maxAmmo}`}updateTeamScores(){this.isDefuseMode?(document.getElementById("ct-score").textContent=`åæç²¾è‹±: ${this.ctScore}`,document.getElementById("t-score").textContent=`ææ€–åˆ†å­: ${this.tScore}`):(document.getElementById("ct-score").textContent=`åæç²¾è‹±: ${this.ctKills}`,document.getElementById("t-score").textContent=`ææ€–åˆ†å­: ${this.tKills}`)}updateHUD(t){document.getElementById("health").textContent=`HP: ${t.health}`,this.isReloading||this.updateAmmoDisplay(),document.getElementById("score").textContent=`K: ${t.kills} / D: ${t.deaths}`,t.is_alive||this.gameOver||(this.isDefuseMode?this.isSpectating||(this.getAliveTeammates().length>0?(document.getElementById("death-screen").style.display="none",document.getElementById("game").classList.remove("dead-effect"),document.getElementById("death-overlay").classList.remove("active"),this.startSpectating()):(document.getElementById("death-screen").style.display="block",document.getElementById("game").classList.add("dead-effect"),document.getElementById("death-overlay").classList.add("active"),document.getElementById("respawn-info").textContent="ç­‰å¾…ä¸‹å›åˆå¤æ´»")):(document.getElementById("death-screen").style.display="block",document.getElementById("game").classList.add("dead-effect"),document.getElementById("death-overlay").classList.add("active"),document.getElementById("respawn-info").innerHTML='<span id="respawn-countdown">3</span> ç§’åè‡ªåŠ¨å¤æ´»',this.startRespawnTimer()))}updateCrosshair(){document.getElementById("crosshair").style.transform="translate(-50%, -50%)"}addKillFeed(t,s="system"){const i=document.getElementById("killfeed"),e=document.createElement("div");for(e.className="kill-msg","kill"===s?e.classList.add("kill-event"):"headshot"===s?e.classList.add("headshot-event"):"bomb"===s?e.classList.add("bomb-event"):e.classList.add("system-event"),e.innerHTML=t,i.appendChild(e);i.children.length>6;)i.removeChild(i.firstChild);setTimeout(()=>e.remove(),3500)}formatKillMessage(t,s,i,e){const h="t"===t.team?"t-team":"",n="t"===s.team?"t-team":"";return`${i?'<span class="hs-icon">ğŸ’€</span>':""}<span class="killer-name ${h}">${t.name}</span><span class="weapon-text">å‡»æ€</span><span class="victim-name ${n}">${s.name}</span>`}checkCrosshairTarget(){if(!this.camera||this.isSpectating||this.buyMenuOpen||this.settingsMenuOpen)return void this.hideCrosshairTarget();const t=new THREE.Raycaster;t.setFromCamera(new THREE.Vector2(0,0),this.camera),t.far=500;let s=null,i=1/0;for(const e in this.playerMeshes){if(e===this.playerId)continue;const h=this.playerMeshes[e];if(!h||h.userData.isDead)continue;const n=t.intersectObject(h,1);n.length>0&&n[0].distance<i&&(i=n[0].distance,s=this.players[e])}s&&i<200?this.showCrosshairTarget(s):this.hideCrosshairTarget()}showCrosshairTarget(t){const s=document.getElementById("crosshair-target");if(!s)return;const i=this.selectedTeam,e=t.team!==i;s.textContent=t.name,s.className="visible "+(e?"enemy":"friendly")}hideCrosshairTarget(){const t=document.getElementById("crosshair-target");t&&(t.className="")}showKillFeedback(t,s,i){const e=document.getElementById("kill-icon"),h=document.getElementById("kill-streak-icon");if(e.className="",h.className="",t?(e.className="headshot",e.textContent="HEADSHOT"):s?(e.className="knife",e.textContent="KNIFE KILL"):(e.className="kill",e.textContent="KILL"),i>=2){const t={2:"DOUBLE KILL",3:"TRIPLE KILL",4:"ULTRA KILL",5:"RAMPAGE",6:"GODLIKE",7:"UNSTOPPABLE",8:"LEGENDARY"};h.textContent=t[Math.min(i,8)],h.className="active",i>=6?h.classList.add("streak-6"):i>=5?h.classList.add("streak-5"):i>=4?h.classList.add("streak-4"):i>=3&&h.classList.add("streak-3")}setTimeout(()=>{e.className="",e.textContent=""},2e3),setTimeout(()=>{h.className="",h.textContent=""},2500)}playDeathAnimation(){if(!this.camera)return;const t=this.pitch,s=this.camera.position.y,i=Date.now(),e=document.createElement("div");e.style.cssText="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,0,0,0.5);pointer-events:none;z-index:999;",document.body.appendChild(e);let h=.5;const n=setInterval(()=>{h-=.05,h<=0?(clearInterval(n),e.remove()):e.style.background=`rgba(255,0,0,${h})`},50),o=()=>{const e=Date.now()-i,h=Math.min(e/800,1),n=1-Math.pow(1-h,3);if(this.pitch=t+Math.PI/3*n,this.camera.rotation.x=this.pitch,this.camera.position.y=s-(s-1.5)*n,h<.7){const t=Math.sin(20*h)*(1-h)*.05;this.camera.rotation.z=t}else this.camera.rotation.z=0;h<1?requestAnimationFrame(o):this.camera.rotation.z=.1};o()}resetDeathAnimation(){this.camera&&(this.camera.rotation.z=0,this.pitch=0,this.camera.rotation.x=0)}startRespawnTimer(){this.respawnTimer||(this.respawnCountdown=3,document.getElementById("respawn-countdown").textContent=this.respawnCountdown,this.respawnTimer=setInterval(()=>{this.respawnCountdown--,document.getElementById("respawn-countdown").textContent=this.respawnCountdown,this.respawnCountdown<=0&&(this.clearRespawnTimer(),this.respawn())},1e3))}clearRespawnTimer(){this.respawnTimer&&(clearInterval(this.respawnTimer),this.respawnTimer=null)}showGameOver(t,s,i,e="kills"){let h;this.gameOver=1,this.clearRespawnTimer(),document.getElementById("death-screen").style.display="none",document.getElementById("game-over").style.display="block",h="draw"===t?"å¹³å±€!":"ct"===t?"åæç²¾è‹±è·èƒœ!":"ææ€–åˆ†å­è·èƒœ!";let n="";"time"===e?n=" (æ—¶é—´ç»“æŸ)":"match_won"===e&&(n=" (æ¯”èµ›èƒœåˆ©)"),document.getElementById("winner-text").textContent=h+n,this.isDefuseMode?document.getElementById("final-score").textContent=`æœ€ç»ˆæ¯”åˆ† - åæç²¾è‹±: ${s} å›åˆ | ææ€–åˆ†å­: ${i} å›åˆ`:document.getElementById("final-score").textContent=`æœ€ç»ˆæ¯”åˆ† - åæç²¾è‹±: ${s} | ææ€–åˆ†å­: ${i}`,document.exitPointerLock()}updateGunModel(){this.camera&&(this.gunModel&&this.camera.remove(this.gunModel),this.weaponBuilder=new WeaponModelBuilder(this.selectedTeam),this.gunModel=this.weaponBuilder.createModel(this.currentWeapon),this.gunBasePosition=this.gunModel.position.clone(),this.gunBaseRotation=this.gunModel.rotation.clone(),this.camera.add(this.gunModel),this.gunRecoil=0)}createGunModel(){this.weaponBuilder=new WeaponModelBuilder(this.selectedTeam),this.gunModel=this.weaponBuilder.createModel("ak47"),this.gunBasePosition=this.gunModel.position.clone(),this.gunBaseRotation=this.gunModel.rotation.clone(),this.camera.add(this.gunModel),this.scene.add(this.camera),this.isSwitchingWeapon=0,this.isReloading=0,this.switchAnimProgress=0,this.reloadAnimProgress=0,this.gunRecoil=0}buyPrimaryWeapon(t){this.primaryWeapon=t,this.switchToSlot(1),this.buyMenuOpen&&this.toggleBuyMenu()}switchToSlot(t){if(this.isReloading||this.isSwitchingWeapon)return;let s;switch(t){case 1:s=this.primaryWeapon;break;case 2:s=this.secondaryWeapon;break;case 3:s="knife";break;case 4:s="grenade";break;case 5:if(!this.isDefuseMode||!this.hasC4)return;s="c4";break;default:return}s!==this.currentWeapon&&("grenade"===s&&this.grenadeCount<=0||this.startWeaponSwitch(s))}switchToPrevious(){if(this.isReloading||this.isSwitchingWeapon)return;const t=t=>"ak47"===t||"m4a1"===t||"awp"===t;let s;s=t(this.currentWeapon)?this.secondaryWeapon:"pistol"===this.currentWeapon?this.primaryWeapon:"knife"===this.currentWeapon?t(this.previousWeapon)?this.previousWeapon:this.primaryWeapon:"grenade"!==this.currentWeapon&&"c4"!==this.currentWeapon||!t(this.previousWeapon)?this.primaryWeapon:this.previousWeapon,s!==this.currentWeapon&&this.startWeaponSwitch(s)}startWeaponSwitch(t){this.isScoped&&this.closeScope(),this.previousWeapon=this.currentWeapon,this.isSwitchingWeapon=1,this.switchAnimProgress=0,this.audio.playWeaponSwitchSound();const s=this;setTimeout(function(){s.currentWeapon=t;const i=WeaponConfigs[t];i&&(s.maxAmmo=i.ammo,s.ammo=i.ammo,s.fireRate=i.fireRate,s.weaponRecoil=i.recoil),s.shotsFired=0,s.recoilAccumulator=0,s.updateGunModel(),s.updateAmmoDisplay(),setTimeout(function(){s.isSwitchingWeapon=0,s.switchAnimProgress=0},200)},300),this.ws&&this.ws.readyState===WebSocket.OPEN&&this.ws.send(JSON.stringify({action:"switch_weapon",weapon:t}))}reload(){"knife"!==this.currentWeapon&&"grenade"!==this.currentWeapon&&"c4"!==this.currentWeapon&&(this.isReloading=1,this.reloadAnimProgress=0,this.audio.playReloadSound(this.currentWeapon),document.getElementById("weapon").textContent="æ¢å¼¹ä¸­...",setTimeout(()=>{this.ammo=this.maxAmmo,this.isReloading=0,this.reloadAnimProgress=0,this.updateAmmoDisplay()},1800))}toggleScope(){"awp"===this.currentWeapon&&(this.scopeLevel=(this.scopeLevel+1)%3,this.isScoped=this.scopeLevel>0,document.getElementById("scope").style.display=this.isScoped?"block":"none",document.getElementById("crosshair").style.display=this.isScoped?"none":"block",this.camera&&(0===this.scopeLevel?this.camera.fov=this.normalFOV:1===this.scopeLevel?this.camera.fov=this.scopedFOV1:this.camera.fov=this.scopedFOV2,this.camera.updateProjectionMatrix()),this.gunModel&&(this.gunModel.visible=!this.isScoped))}closeScope(){this.isScoped&&(this.isScoped=0,this.scopeLevel=0,document.getElementById("scope").style.display="none",document.getElementById("crosshair").style.display="block",this.camera&&(this.camera.fov=this.normalFOV,this.camera.updateProjectionMatrix()),this.gunModel&&(this.gunModel.visible=1))}setCrouch(t){if(this.isCrouching===t)return;if(!t&&this.camera&&!this.canStandAt(this.camera.position.x,this.camera.position.z))return;this.isCrouching=t;const s=t?this.crouchingHeight:this.standingHeight;this.targetCameraHeight=s+(this.currentStandingHeight||0),this.ws&&this.ws.readyState===WebSocket.OPEN&&this.ws.send(JSON.stringify({action:"crouch",crouching:t}))}shoot(){if(this.isReloading||this.isSwitchingWeapon||this.gameOver||this.buyMenuOpen)return;if(!this.isLocked)return;const t=Date.now();if(t-this.lastShot<this.fireRate)return;if("knife"===this.currentWeapon)return this.knifeAttack(),void(this.lastShot=t);if("grenade"===this.currentWeapon)return this.throwGrenade(),void(this.lastShot=t);if("c4"===this.currentWeapon)return;if(this.ammo<=0)return void this.reload();this.lastShot=t,this.ammo--,this.shotsFired++,this.audio.playGunSound(this.currentWeapon);const s=WeaponConfigs[this.currentWeapon];let i=0;if(this.shotsFired>2){const t=Math.min(this.shotsFired-2,8),e=s.recoil+t*s.recoilIncrease;i=Math.min(e,s.maxRecoil)}this.recoilAccumulator+=i,this.crosshairOffset=Math.min(1.5*this.recoilAccumulator,.6),this.gunRecoil=.5+2*s.recoil,this.screenShake=.02+.1*s.recoil;const e=.008*s.recoil*(1+Math.min(.1*this.shotsFired,.5)),h=(Math.random()-.5)*s.recoil*.02;this.pitch+=e,this.yaw+=h,this.pitch=Math.max(-Math.PI/2+.1,Math.min(Math.PI/2-.1,this.pitch)),this.camera.rotation.order="YXZ",this.camera.rotation.x=this.pitch,this.camera.rotation.y=this.yaw;const n=this.isScoped;"awp"===this.currentWeapon&&this.isScoped&&this.closeScope(),this.raycastShoot(n),this.updateAmmoDisplay(),this.ws&&this.ws.readyState===WebSocket.OPEN&&this.ws.send(JSON.stringify({action:"shoot"}))}knifeAttack(){this.audio.playKnifeSound(),this.gunRecoil=1,this.gunModel&&(this.gunModel.rotation.z=-.5,setTimeout(()=>{this.gunModel&&(this.gunModel.rotation.z=.5)},100),setTimeout(()=>{this.gunModel&&(this.gunModel.rotation.z=0)},200));const t=new THREE.Raycaster;t.setFromCamera(new THREE.Vector2(0,0),this.camera),t.far=3;for(const[s,i]of Object.entries(this.playerMeshes)){if(s===this.playerId)continue;const e=[];i.traverse(t=>{t.isMesh&&e.push(t)});const h=t.intersectObjects(e);if(h.length>0){const t=h[0].point;if(this.createHitMarker(t),this.createBloodEffect(t),this.audio.playHitSound(),this.ws&&this.ws.readyState===WebSocket.OPEN){const i=this.playerMeshes[s],e=i?i.position.y:0,h=t.y-e;this.ws.send(JSON.stringify({action:"hit_player",target_id:s,hit_height:h}))}break}}}throwGrenade(){if(this.grenadeCount<=0)return;this.grenadeCount--,this.audio.playGrenadeThrowSound(),this.gunRecoil=.5;const t=new THREE.Vector3;this.camera.getWorldDirection(t);const s=this.camera.position.clone();this.ws&&this.ws.readyState===WebSocket.OPEN&&this.ws.send(JSON.stringify({action:"throw_grenade",start:{x:s.x,y:s.y,z:s.z},direction:{x:t.x,y:t.y,z:t.z}})),this.createLocalGrenade(s,t),this.updateAmmoDisplay(),this.grenadeCount,this.switchToSlot(1)}createLocalGrenade(t,s,i=0){const e=new THREE.SphereGeometry(.3,8,8),h=new THREE.MeshLambertMaterial({color:2968109}),n=new THREE.Mesh(e,h);n.position.copy(t),this.scene.add(n);let o=new THREE.Vector3(s.x,s.y,s.z).normalize().multiplyScalar(85);o.y+=15;const c=.7;let a=0,r=performance.now();const u=this.walls,l=.5;i&&this.audio.playGrenadeThrowSound();const d=()=>{const t=performance.now(),s=Math.min((t-r)/1e3,.05);r=t,o.y-=55*s;const e=n.position.clone(),h=e.clone().add(o.clone().multiplyScalar(s));((t,s,i)=>{let e=0;for(const h of u){const n=h.x,o=h.z,a=h.w,r=h.d,u=h.h||20;if(t.y>u+l)continue;const d=n-l,m=n+a+l,p=o-l,f=o+r+l;if(s.x>=d&&s.x<=m&&s.z>=p&&s.z<=f&&s.y<=u+l){const t=s.x-d,h=m-s.x,n=s.z-p,o=f-s.z,a=Math.min(t,h,n,o);a===t||a===h?(i.x*=-.5,s.x=a===t?d-.01:m+.01):(i.z*=-.5,s.z=a===n?p-.01:f+.01),i.x*=c,i.z*=c,e=1;break}}})(e,h,o),n.position.copy(h),n.position.y<.5&&(n.position.y=.5,o.y*=-.5,o.x*=c,o.z*=c,a++);const m=MapConfigs[this.selectedMap],p=(m&&m.mapSize||125)-5;Math.abs(n.position.x)>p&&(o.x*=-.5,n.position.x=Math.sign(n.position.x)*p),Math.abs(n.position.z)>p&&(o.z*=-.5,n.position.z=Math.sign(n.position.z)*p),a<5&&o.length()>1?requestAnimationFrame(d):setTimeout(()=>{this.createExplosion(n.position,i),this.scene.remove(n)},500)};d()}createExplosion(t,s=0){this.audio.playExplosionSound();const i=new THREE.SphereGeometry(2,16,16),e=new THREE.MeshBasicMaterial({color:16737792,transparent:1,opacity:.9}),h=new THREE.Mesh(i,e);h.position.copy(t),this.scene.add(h);const n=new THREE.SphereGeometry(1.5,12,12),o=new THREE.MeshBasicMaterial({color:16777164,transparent:1,opacity:1}),c=new THREE.Mesh(n,o);c.position.copy(t),this.scene.add(c);const a=new THREE.TorusGeometry(3,1,8,16),r=new THREE.MeshBasicMaterial({color:4473924,transparent:1,opacity:.6}),u=new THREE.Mesh(a,r);u.position.copy(t),u.rotation.x=Math.PI/2,this.scene.add(u);const l=[];for(let s=0;s<20;s++){const s=new THREE.BoxGeometry(.3,.3,.3),i=Math.random()>.5?16729088:16755200,e=new THREE.MeshBasicMaterial({color:i,transparent:1,opacity:1}),h=new THREE.Mesh(s,e);h.position.copy(t),h.velocity=new THREE.Vector3(2*(Math.random()-.5),1.5*Math.random()+.5,2*(Math.random()-.5)),this.scene.add(h),l.push({mesh:h,mat:e,vel:h.velocity})}const d=this.camera.position.clone(),m=this.camera.position.distanceTo(t),p=.5*Math.max(0,1-m/30);let f=0,M=1,b=1;const v=()=>{f++,M+=.4,h.scale.set(M,M,M),e.opacity-=.08,o.opacity-=.15,c.scale.set(.8*M,.8*M,.8*M),b+=.3,u.scale.set(b,b,b),u.position.y+=.2,r.opacity-=.04,l.forEach(t=>{t.mesh.position.add(t.vel),t.vel.y-=.08,t.mat.opacity-=.05}),f<10&&p>0&&(this.camera.position.x=d.x+(Math.random()-.5)*p,this.camera.position.y=d.y+(Math.random()-.5)*p),e.opacity>0?requestAnimationFrame(v):(this.scene.remove(h),this.scene.remove(c),this.scene.remove(u),l.forEach(t=>this.scene.remove(t.mesh)))};if(v(),!s)for(const[s,i]of Object.entries(this.playerMeshes)){if(s===this.playerId)continue;const e=i.position.distanceTo(t);e<20&&this.ws&&this.ws.readyState===WebSocket.OPEN&&this.ws.send(JSON.stringify({action:"grenade_hit",target_id:s,distance:e}))}}raycastShoot(t=0){const s=new THREE.Raycaster,i=WeaponConfigs[this.currentWeapon];let e=0,h=0;if("awp"!==this.currentWeapon||t){if(this.shotsFired>2)if(this.shotsFired>=10){const t=(i.spread||.02)+.08;e=(Math.random()-.5)*t,h=(Math.random()-.5)*t*.8+.04}else{const t=Math.min((this.shotsFired-2)/8,1),s=(i.spread||.02)*t+.03*this.recoilAccumulator*t;e=(Math.random()-.5)*s,h=Math.random()*s*.8+.012*this.recoilAccumulator}}else{const t=.15;e=(Math.random()-.5)*t,h=(Math.random()-.5)*t}const n=this.camera.position.clone(),o=new THREE.Vector3;if(this.camera.getWorldDirection(o),0!==e||0!==h){const t=new THREE.Vector3,s=new THREE.Vector3;this.camera.getWorldDirection(o),t.crossVectors(o,this.camera.up).normalize(),s.crossVectors(t,o).normalize(),o.add(t.multiplyScalar(e)),o.add(s.multiplyScalar(h)),o.normalize()}s.set(n,o);let c=n.clone().add(o.clone().multiplyScalar(100)),a=1/0,r=null,u=null,l=0;if(o.y<0){const t=new THREE.Plane(new THREE.Vector3(0,1,0),0),i=new THREE.Vector3;if(s.ray.intersectPlane(t,i)&&i.clone().sub(n).dot(o)>0){const t=i.distanceTo(n);t<a&&t<100&&t>.5&&(a=t,c=i.clone(),l=1)}}const d=this.walls.map(t=>t.mesh),m=s.intersectObjects(d);if(m.length>0&&m[0].distance<a){a=m[0].distance,c=m[0].point.clone(),l=0;const t=m[0].face?m[0].face.normal.clone():null;t&&t.transformDirection(m[0].object.matrixWorld),this.createBulletHole(m[0].point,t,0)}else l&&this.createFloorBulletHole(c);for(const[t,i]of Object.entries(this.playerMeshes)){if(t===this.playerId)continue;const e=[];i.traverse(t=>{t.isMesh&&e.push(t)});const h=s.intersectObjects(e);h.length>0&&h[0].distance<a&&(r=t,u=h[0].point.clone(),c=u)}if(r&&u&&(this.createHitMarker(u),this.createBloodEffect(u),this.audio.playHitSound(),this.ws&&this.ws.readyState===WebSocket.OPEN)){const t=this.playerMeshes[r],s=t?t.position.y:0,i=u.y-s;this.ws.send(JSON.stringify({action:"hit_player",target_id:r,hit_height:i}))}this.createBulletTracer(n,c)}createHitMarker(t=null){const s=document.createElement("div");if(s.className="hit-marker",s.innerHTML="Ã—",t&&this.camera){const i=t.clone().project(this.camera),e=document.getElementById("game").getBoundingClientRect(),h=(.5*i.x+.5)*e.width,n=(.5*-i.y+.5)*e.height;h>=0&&h<=e.width&&n>=0&&n<=e.height&&i.z<1&&(s.style.left=`${h}px`,s.style.top=`${n}px`,s.style.transform="translate(-50%, -50%)")}document.getElementById("game").appendChild(s),setTimeout(()=>s.remove(),200)}createBulletHole(t,s=null,i=0){const e=document.createElement("canvas");e.width=32,e.height=32;const h=e.getContext("2d");h.clearRect(0,0,32,32);const n=h.createRadialGradient(16,16,0,16,16,14);n.addColorStop(0,"rgba(20, 20, 20, 0.9)"),n.addColorStop(.3,"rgba(40, 35, 30, 0.85)"),n.addColorStop(.6,"rgba(60, 50, 40, 0.6)"),n.addColorStop(.8,"rgba(80, 70, 60, 0.3)"),n.addColorStop(1,"rgba(100, 90, 80, 0)"),h.fillStyle=n,h.beginPath(),h.arc(16,16,14,0,2*Math.PI),h.fill();const o=h.createRadialGradient(16,16,0,16,16,5);o.addColorStop(0,"rgba(0, 0, 0, 1)"),o.addColorStop(.5,"rgba(10, 10, 10, 0.95)"),o.addColorStop(1,"rgba(30, 25, 20, 0.8)"),h.fillStyle=o,h.beginPath(),h.arc(16,16,5,0,2*Math.PI),h.fill(),h.strokeStyle="rgba(30, 25, 20, 0.5)",h.lineWidth=1;for(let t=0;t<4;t++){const s=2*Math.PI/4*t+.5*Math.random(),i=6+4*Math.random();h.beginPath(),h.moveTo(16+5*Math.cos(s),16+5*Math.sin(s)),h.lineTo(16+Math.cos(s)*i,16+Math.sin(s)*i),h.stroke()}const c=new THREE.CanvasTexture(e),a=new THREE.Mesh(new THREE.CircleGeometry(.4,16),new THREE.MeshBasicMaterial({map:c,transparent:1,opacity:.9,side:THREE.DoubleSide,depthWrite:0}));a.position.copy(t),i?(a.rotation.x=-Math.PI/2,a.position.y=.02):s?a.lookAt(t.clone().add(s)):a.lookAt(this.camera.position),this.scene.add(a),setTimeout(()=>{const t=()=>{a.material.opacity-=.05,a.material.opacity>0?requestAnimationFrame(t):this.scene.remove(a)};t()},5e3)}createFloorBulletHole(t){this.createBulletHole(t,null,1)}createBloodEffect(t){for(let s=0;s<5;s++){const s=new THREE.Mesh(new THREE.BoxGeometry(.3,.3,.3),new THREE.MeshBasicMaterial({color:13369344}));s.position.copy(t),s.position.x+=2*(Math.random()-.5),s.position.y+=2*Math.random(),s.position.z+=2*(Math.random()-.5),this.scene.add(s),setTimeout(()=>this.scene.remove(s),300)}}createBulletTracer(t,s){const i=t.distanceTo(s),e=new THREE.SphereGeometry(.06,4,4),h=new THREE.MeshBasicMaterial({color:16776960,transparent:1,opacity:1}),n=new THREE.Mesh(e,h);n.position.copy(t),this.scene.add(n);let o=0;const c=()=>{o+=16,o>=i?this.scene.remove(n):(n.position.lerpVectors(t,s,o/i),h.opacity=1-o/i*.5,requestAnimationFrame(c))};c()}validateInput(t,s){return t.length<2||t.length>8?(this.showMenuError("ç©å®¶åç§°å¿…é¡»åœ¨2-8ä¸ªå­—ç¬¦ä¹‹é—´"),0):8!==s.length?(this.showMenuError("æˆ¿é—´å·å¿…é¡»æ˜¯8ä¸ªå­—ç¬¦"),0):/^[a-zA-Z0-9]+$/.test(s)?1:(this.showMenuError("æˆ¿é—´å·åªèƒ½åŒ…å«å­—æ¯å’Œæ•°å­—"),0)}joinGame(){const t=document.getElementById("playerName").value.trim(),s=document.getElementById("roomId").value.trim();this.validateInput(t,s)&&this.checkRoomInfo(s).then(i=>{i.exists?(this.selectedMap=i.map||"dust2",this.selectedGameMode=i.game_mode||"deathmatch",this.targetKills=i.target_kills||20,i.has_custom_map&&console.log("åŠ å…¥è‡ªå®šä¹‰åœ°å›¾æˆ¿é—´ï¼Œåœ°å›¾å°†åœ¨è¿æ¥ååŒæ­¥"),this.startGame(t,s,0)):this.showMenuError("æˆ¿é—´ä¸å­˜åœ¨ï¼Œè¯·åˆ›å»ºæˆ¿é—´æˆ–è¾“å…¥æ­£ç¡®çš„æˆ¿é—´å·")}).catch(()=>{this.startGame(t,s,0)})}checkRoomInfo(t){return new Promise((s,i)=>{const e=new WebSocket(WS_SERVER_URL);let h=0;e.onopen=()=>{e.send(JSON.stringify({action:"check_room",room_id:t}))},e.onmessage=t=>{try{const i=JSON.parse(t.data);"room_check"===i.action&&(h=1,e.close(),s({exists:i.exists,map:i.map,game_mode:i.game_mode,target_kills:i.target_kills,has_custom_map:i.has_custom_map||0}))}catch(t){e.close(),i(t)}},e.onerror=()=>{h||i(new Error("è¿æ¥å¤±è´¥"))},setTimeout(()=>{h||(e.close(),i(new Error("è¶…æ—¶")))},2e3)})}showMenuError(t){const s=document.querySelector(".menu-error");s&&s.remove();const i=document.createElement("div");i.className="menu-error",i.textContent=t,i.style.cssText="color: #ff4444; background: rgba(255,0,0,0.1); padding: 10px 20px; border-radius: 5px; margin-top: 10px; text-align: center; border: 1px solid #ff4444;";const e=document.getElementById("joinBtn"),h=document.getElementById("createBtn"),n="none"!==e.style.display?e:h;n.parentNode.insertBefore(i,n.nextSibling),setTimeout(()=>i.remove(),3e3)}createGame(){const t=document.getElementById("playerName").value.trim();let s=document.getElementById("roomId").value.trim();if(s||(s=Math.random().toString(36).substr(2,8),document.getElementById("roomId").value=s),!this.validateInput(t,s))return;this.targetKills=parseInt(document.getElementById("targetKills").value)||20;const i=document.getElementById("gameMode").value||"deathmatch";if("custom"===i){if(!this.customMapData)return void alert("è¯·å…ˆå¯¼å…¥åœ°å›¾æ–‡ä»¶")}else this.selectedMap=document.getElementById("mapSelect").value||"dust2",this.selectedGameMode=i;this.startGame(t,s,1)}startGame(t,s,i){if(this.isMobile&&window.innerHeight>window.innerWidth)return this.pendingGameStart={name:t,roomId:s,isCreating:i},void this.showRotateHint();this.actualStartGame(t,s,i)}showRotateHint(){const t=document.getElementById("rotate-screen-hint");t&&(t.style.display="flex",t.innerHTML='\n                <div class="rotate-icon">ğŸ“±</div>\n                <div>è¯·å°†æ‰‹æœºæ¨ªå±</div>\n                <div style="font-size: 16px; margin-top: 10px; opacity: 0.7;">æ¨ªå±åè‡ªåŠ¨è¿›å…¥æ¸¸æˆ</div>\n            ');const s=()=>{if(window.innerWidth>window.innerHeight&&(window.removeEventListener("resize",s),screen.orientation&&screen.orientation.removeEventListener("change",s),t&&(t.style.display="none"),this.pendingGameStart)){const{name:t,roomId:s,isCreating:i}=this.pendingGameStart;this.pendingGameStart=null;const e=document.documentElement;e.requestFullscreen?e.requestFullscreen().then(()=>{this.actualStartGame(t,s,i)}).catch(()=>{this.actualStartGame(t,s,i)}):this.actualStartGame(t,s,i)}};window.addEventListener("resize",s),screen.orientation&&screen.orientation.addEventListener("change",s),setTimeout(s,100)}actualStartGame(t,s,i){this.showConnectingOverlay();const e=new WebSocket(WS_SERVER_URL),h=setTimeout(()=>{e.close(),this.hideConnectingOverlay(),this.showMenuError("æœåŠ¡å™¨è¿æ¥è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–æœåŠ¡å™¨åœ°å€")},5e3);e.onopen=()=>{clearTimeout(h),e.close(),this.hideConnectingOverlay(),this.doStartGame(t,s,i)},e.onerror=()=>{clearTimeout(h),this.hideConnectingOverlay(),this.showMenuError("æœåŠ¡å™¨è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–æœåŠ¡å™¨åœ°å€")}}showConnectingOverlay(){let t=document.getElementById("connecting-overlay");t||(t=document.createElement("div"),t.id="connecting-overlay",t.innerHTML='\n                <div class="connecting-content">\n                    <div class="connecting-spinner"></div>\n                    <div class="connecting-text">æ­£åœ¨è¿æ¥æœåŠ¡å™¨...</div>\n                </div>\n            ',document.body.appendChild(t)),t.style.display="flex"}hideConnectingOverlay(){const t=document.getElementById("connecting-overlay");t&&(t.style.display="none")}showMenuError(t){let s=document.getElementById("menu-error");if(!s){s=document.createElement("div"),s.id="menu-error";const t=document.querySelector(".menu-container");t&&t.appendChild(s)}s.textContent=t,s.style.display="block",setTimeout(()=>{s.style.display="none"},4e3)}doStartGame(t,s,i){document.body.classList.add("in-game"),document.getElementById("menu").style.display="none",document.getElementById("game").style.display="block",document.getElementById("target-kills").textContent=this.targetKills,document.getElementById("map-name").textContent=MapNames[this.selectedMap]||"æ²™æ¼ 2";const e="deathmatch"===this.selectedGameMode?"å›¢é˜Ÿç«æŠ€":"çˆ†ç ´æ¨¡å¼";document.getElementById("game-mode-text").textContent=e+" | ","deathmatch"===this.selectedGameMode&&(document.getElementById("game-timer").style.display="inline",document.getElementById("game-timer").textContent="10:00 | "),"undefined"!=typeof pixelMusic&&pixelMusic&&pixelMusic.stop(),document.getElementById("music-control").style.display="none";const h=document.getElementById("editor-link");h&&(h.style.display="none"),"undefined"!=typeof pixelBg&&pixelBg&&pixelBg.stop();const n=document.documentElement;this.isMobile?screen.orientation&&screen.orientation.lock&&screen.orientation.lock("landscape").catch(()=>{}):n.requestFullscreen&&n.requestFullscreen().catch(()=>{}),this.audio.init(),this.initThree(),this.renderer.compile(this.scene,this.camera),this.renderer.render(this.scene,this.camera),this.connect(t,s,i),this.isMobile||setTimeout(()=>{document.body.requestPointerLock()},100),document.getElementById("backToMenu").addEventListener("click",()=>this.backToMenu())}backToMenu(){document.body.classList.remove("in-game"),this.ws&&this.ws.close(),document.exitPointerLock(),document.fullscreenElement&&document.exitFullscreen(),screen.orientation&&screen.orientation.unlock&&screen.orientation.unlock(),location.reload()}initThree(){this.scene=new THREE.Scene,this.scene.background=new THREE.Color(7058393),this.scene.fog=null,this.camera=new THREE.PerspectiveCamera(this.normalFOV,window.innerWidth/window.innerHeight,.1,2e3),this.camera.position.set(0,this.standingHeight,0),this.renderer=new THREE.WebGLRenderer({antialias:0,powerPreference:"high-performance"}),this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.setPixelRatio(Math.min(window.devicePixelRatio,2));const t=this.renderer.getContext(),s=t.getExtension("WEBGL_debug_renderer_info");if(s){const i=t.getParameter(s.UNMASKED_RENDERER_WEBGL);console.log("ğŸ® GPUåŠ é€Ÿå·²å¯ç”¨:",i)}document.getElementById("game").insertBefore(this.renderer.domElement,document.getElementById("game").firstChild);const i=new THREE.AmbientLight(16777215,.6);this.scene.add(i);const e=new THREE.DirectionalLight(16777215,.8);e.position.set(50,100,50),this.scene.add(e);const h=new MapBuilder(this.scene);this.walls=h.createMap(this.selectedMap),this.createGunModel(),this.minimap=new Minimap(this),document.addEventListener("mousemove",t=>this.onMouseMove(t)),document.addEventListener("click",()=>{this.isLocked||this.buyMenuOpen||document.body.requestPointerLock()}),window.addEventListener("resize",()=>{this.camera.aspect=window.innerWidth/window.innerHeight,this.camera.updateProjectionMatrix(),this.renderer.setSize(window.innerWidth,window.innerHeight)}),this.animate()}connect(t,s,i){this.connectionInfo={name:t,roomId:s,isCreating:i},this.reconnectAttempts=0,this.isReconnecting=0,this.establishConnection(t,s,i)}establishConnection(t,s,i){this.ws&&(this.ws.onclose=null,this.ws.onerror=null,this.ws.close()),this.ws=new WebSocket(WS_SERVER_URL),this.ws.onopen=()=>{console.log("WebSocketè¿æ¥æˆåŠŸ"),this.reconnectAttempts=0,this.isReconnecting=0,this.hideReconnectOverlay();const e={action:"join",name:t,room_id:s,team:this.selectedTeam};if(i){e.target_kills=this.targetKills,e.map=this.selectedMap,e.game_mode=this.selectedGameMode,e.is_creating=1;const t=MapConfigs[this.selectedMap];t&&(e.map_size=t.mapSize||125,t.bombSites&&(e.bomb_sites=t.bombSites),t.spawnPoints&&(e.spawn_points=t.spawnPoints),this.customMapData&&(e.custom_map_config=this.customMapData))}this.ws.send(JSON.stringify(e))},this.ws.onmessage=t=>{const s=JSON.parse(t.data);this.handleMessage(s)},this.ws.onclose=t=>{console.log("WebSocketè¿æ¥å…³é—­",t.code,t.reason),this.connectionInfo&&!this.gameOver&&this.attemptReconnect()},this.ws.onerror=t=>{console.error("WebSocketé”™è¯¯:",t)}}attemptReconnect(){if(this.isReconnecting||!this.connectionInfo)return;if(this.reconnectAttempts>=this.maxReconnectAttempts)return void this.showReconnectFailed();this.isReconnecting=1,this.reconnectAttempts++;const t=this.reconnectDelay*Math.pow(1.5,this.reconnectAttempts-1);this.showReconnectOverlay(this.reconnectAttempts,this.maxReconnectAttempts),console.log(`å°è¯•é‡è¿ (${this.reconnectAttempts}/${this.maxReconnectAttempts})ï¼Œ${t}mså...`),setTimeout(()=>{this.isReconnecting=0,this.connectionInfo&&this.establishConnection(this.connectionInfo.name,this.connectionInfo.roomId,0)},t)}showReconnectOverlay(t,s){let i=document.getElementById("reconnect-overlay");i||(i=document.createElement("div"),i.id="reconnect-overlay",i.innerHTML='\n                <div class="reconnect-content">\n                    <div class="reconnect-spinner"></div>\n                    <div class="reconnect-text">è¿æ¥æ–­å¼€ï¼Œæ­£åœ¨é‡è¿...</div>\n                    <div class="reconnect-attempt"></div>\n                </div>\n            ',document.body.appendChild(i)),i.style.display="flex",i.querySelector(".reconnect-attempt").textContent=`å°è¯• ${t}/${s}`}hideReconnectOverlay(){const t=document.getElementById("reconnect-overlay");t&&(t.style.display="none")}showReconnectFailed(){let t=document.getElementById("reconnect-overlay");t&&(t.querySelector(".reconnect-spinner").style.display="none",t.querySelector(".reconnect-text").textContent="é‡è¿å¤±è´¥",t.querySelector(".reconnect-attempt").innerHTML='<button onclick="location.reload()">è¿”å›ä¸»é¡µ</button>')}handleMessage(t){switch(t.action){case"joined":this.playerId=t.player_id;const s=t.player;this.camera.position.set(s.x,this.standingHeight,s.y),this.currentWeapon=s.weapon||"ak47",this.primaryWeapon=this.currentWeapon;const i=WeaponConfigs[this.currentWeapon];if(this.ammo=i.ammo,this.maxAmmo=i.ammo,this.fireRate=i.fireRate,this.weaponRecoil=i.recoil,t.target_kills&&(this.targetKills=t.target_kills),t.custom_map_config){this.loadCustomMap(t.custom_map_config),this.walls.forEach(t=>{t.mesh&&this.scene.remove(t.mesh)}),this.walls=[];const s=new MapBuilder(this.scene);this.walls=s.createMap(this.selectedMap),document.getElementById("map-name").textContent=MapConfigs[this.selectedMap]?.displayName||"è‡ªå®šä¹‰åœ°å›¾"}else if(t.map&&this.selectedMap!==t.map){this.selectedMap=t.map,this.walls.forEach(t=>{t.mesh&&this.scene.remove(t.mesh)}),this.walls=[];const s=new MapBuilder(this.scene);this.walls=s.createMap(this.selectedMap),document.getElementById("map-name").textContent=MapNames[t.map]||MapConfigs[t.map]?.displayName||"è‡ªå®šä¹‰åœ°å›¾"}document.getElementById("target-kills").textContent=this.targetKills,this.updateGunModel(),this.updateAmmoDisplay(),this.updateState(t.state),"defuse"===t.game_mode&&this.initDefuseMode(t);break;case"state":this.updateState(t.state);break;case"player_joined":this.addKillFeed(`${t.player.name} åŠ å…¥äº†æ¸¸æˆ`);break;case"player_left":const e=this.players[t.player_id];e&&this.addKillFeed(`${e.name} ç¦»å¼€äº†æ¸¸æˆ`),this.playerMeshes[t.player_id]&&(this.scene.remove(this.playerMeshes[t.player_id]),delete this.playerMeshes[t.player_id]),delete this.players[t.player_id];break;case"hits":t.hits.forEach(t=>{if("kill"===t.type){const s=this.players[t.killer],i=this.players[t.victim];if(s&&i){const e=this.formatKillMessage(s,i,t.headshot,t.weapon||"ak47");this.addKillFeed(e,t.headshot?"headshot":"kill")}if(t.killer===this.playerId){this.createHitMarker(),this.audio.playHitSound();const s=Date.now();s-this.lastKillTime<this.killStreakTimeout?this.killStreak++:this.killStreak=1,this.lastKillTime=s,this.showKillFeedback(t.headshot,t.knife_kill,this.killStreak),t.headshot?this.audio.playHeadshotVoice():t.knife_kill?this.audio.playKnifeKillVoice():this.killStreak>=2&&this.audio.playMultiKillVoice(this.killStreak)}t.victim===this.playerId&&(this.closeScope(),this.killStreak=0,this.audio.playDeathSound(),this.playDeathAnimation())}else"hit"===t.type&&t.shooter===this.playerId&&(this.createHitMarker(),this.audio.playHitSound())});break;case"respawn":t.player_id===this.playerId&&(this.clearRespawnTimer(),this.stopSpectating(),document.getElementById("death-screen").style.display="none",document.getElementById("game").classList.remove("dead-effect"),document.getElementById("death-overlay").classList.remove("active"),this.resetDeathAnimation(),this.camera.position.set(t.player.x,this.standingHeight,t.player.y),this.ammo=this.maxAmmo,this.grenadeCount=1,this.updateAmmoDisplay());break;case"game_over":const h=void 0!==t.ct_score?t.ct_score:t.ct_kills,n=void 0!==t.t_score?t.t_score:t.t_kills;this.showGameOver(t.winner,h,n,t.reason);break;case"score_update":this.ctKills=t.ct_kills||0,this.tKills=t.t_kills||0,this.updateTeamScores();break;case"room_full":alert("æˆ¿é—´å·²æ»¡ (æ¯é˜Ÿæœ€å¤š5äºº)"),this.backToMenu();break;case"room_not_found":alert("æˆ¿é—´ä¸å­˜åœ¨ï¼Œè¯·åˆ›å»ºæˆ¿é—´æˆ–è¾“å…¥æ­£ç¡®çš„æˆ¿é—´å·"),this.backToMenu();break;case"join_error":alert(t.message||"åŠ å…¥æˆ¿é—´å¤±è´¥"),this.backToMenu();break;case"bullet":if(t.bullet&&t.bullet.owner_id!==this.playerId){const s=this.players[t.bullet.owner_id];if(s){const i=s.x-this.camera.position.x,e=s.y-this.camera.position.z,h=Math.sqrt(i*i+e*e),n=150,o=.6*Math.max(.1,1-h/n);this.audio.playRemoteGunSound(t.bullet.weapon||s.weapon||"ak47",o)}}break;case"grenade_thrown":if(t.owner_id!==this.playerId){const s=new THREE.Vector3(t.start.x,t.start.y,t.start.z),i=new THREE.Vector3(t.direction.x,t.direction.y,t.direction.z);this.createLocalGrenade(s,i,1)}break;case"c4_planted":this.onC4Planted(t);break;case"bomb_defused":this.onBombDefused(t);break;case"bomb_exploded":this.onBombExploded(t);break;case"round_end":this.onRoundEnd(t);break;case"round_start":this.onRoundStart(t);break;case"freeze_time_end":this.onFreezeTimeEnd();break;case"defuse_started":this.onDefuseStarted(t);break;case"defuse_cancelled":case"defuse_interrupted":this.onDefuseCancelled();break;case"plant_failed":case"defuse_failed":this.addKillFeed(t.message)}}initDefuseMode(t){this.isDefuseMode=1,this.hasC4=t.has_c4||0,this.c4Planted=0,this.c4Position=null,this.c4Site=null,this.bombSites=t.bomb_sites||{},this.currentRound=t.current_round||1,this.ctScore=t.ct_score||0,this.tScore=t.t_score||0,this.isPlanting=0,this.isDefusing=0,this.plantProgress=0,this.defuseProgress=0,document.getElementById("defuse-hud").style.display="block",document.getElementById("round-info").style.display="inline",document.getElementById("deathmatch-info").style.display="none",document.getElementById("game").classList.add("defuse-mode"),document.getElementById("current-round").textContent=this.currentRound,document.getElementById("max-rounds").textContent="10",this.updateDefuseHUD(),this.updateDefuseScores()}onC4Planted(t){this.c4Planted=1,this.c4Position=t.position,this.c4Site=t.site,this.hasC4=0,this.c4PlantedTime=Date.now(),this.lastC4BeepTime=0,document.getElementById("c4-timer-display").style.display="block",document.getElementById("plant-hint").style.display="none",this.createC4Model(t.position),this.audio.playC4PlantSound(),this.addKillFeed(`ğŸ’£ C4å·²å®‰æ”¾åœ¨ ${t.site} ç‚¹!`,"bomb"),"ct"===this.selectedTeam&&this.showDefuseHint(),t.planter===this.playerId&&this.switchToSlot(1)}createC4Model(t){this.c4Model&&this.scene.remove(this.c4Model);const s=new THREE.Group,i=new THREE.BoxGeometry(3,1.5,2),e=new THREE.MeshLambertMaterial({color:2960685,transparent:1,opacity:.95,depthWrite:0}),h=new THREE.Mesh(i,e);h.renderOrder=1,s.add(h);const n=new THREE.SphereGeometry(.3,8,8),o=new THREE.MeshBasicMaterial({color:16711680,transparent:1,opacity:1,depthWrite:0}),c=new THREE.Mesh(n,o);c.position.set(0,.8,0),c.renderOrder=2,s.add(c),this.c4Light=c;const a=new THREE.CylinderGeometry(.1,.1,1,8),r=new THREE.MeshLambertMaterial({color:3355443,transparent:1,opacity:.95,depthWrite:0}),u=new THREE.Mesh(a,r);u.position.set(1,0,0),u.rotation.z=Math.PI/4,u.renderOrder=1,s.add(u);const l=new THREE.BoxGeometry(1.2,.5,.1),d=new THREE.MeshBasicMaterial({color:65280,transparent:1,opacity:1,depthWrite:0}),m=new THREE.Mesh(l,d);m.position.set(0,.3,1.05),m.renderOrder=2,s.add(m);const p=new THREE.RingGeometry(2,4,32),f=new THREE.MeshBasicMaterial({color:16711680,transparent:1,opacity:.3,side:THREE.DoubleSide,depthWrite:0,depthTest:0}),M=new THREE.Mesh(p,f);M.position.set(0,.1,0),M.rotation.x=-Math.PI/2,M.renderOrder=999,M.raycast=()=>{},s.add(M),this.c4Glow=M;const b=new THREE.CylinderGeometry(.5,1.5,8,16,1,1),v=new THREE.MeshBasicMaterial({color:16724736,transparent:1,opacity:.15,side:THREE.DoubleSide,depthWrite:0,depthTest:0}),w=new THREE.Mesh(b,v);w.position.set(0,4,0),w.renderOrder=999,w.raycast=()=>{},s.add(w),this.c4Beam=w,s.position.set(t.x,1,t.z),this.scene.add(s),this.c4Model=s}onBombDefused(t){this.c4Planted=0,this.c4PlantedTime=null,this.lastC4BeepTime=0,document.getElementById("c4-timer-display").style.display="none",document.getElementById("defuse-progress-container").style.display="none",document.getElementById("defuse-hint").style.display="none",this.c4Model&&(this.scene.remove(this.c4Model),this.c4Model=null),this.audio.playC4DefusedSound(),this.addKillFeed("ğŸ’š C4å·²è¢«æ‹†é™¤!","bomb")}onBombExploded(t){this.c4Planted=0,this.c4PlantedTime=null,this.lastC4BeepTime=0,document.getElementById("c4-timer-display").style.display="none",this.c4Position&&this.createC4Explosion(this.c4Position),this.c4Model&&(this.scene.remove(this.c4Model),this.c4Model=null),this.audio.playC4ExplodeSound(),this.addKillFeed("ğŸ’¥ C4å·²çˆ†ç‚¸!","bomb")}createC4Explosion(t){const s=new THREE.SphereGeometry(15,32,32),i=new THREE.MeshBasicMaterial({color:16737792,transparent:1,opacity:.9}),e=new THREE.Mesh(s,i);e.position.set(t.x,10,t.z),this.scene.add(e);const h=new THREE.RingGeometry(1,3,32),n=new THREE.MeshBasicMaterial({color:16776960,transparent:1,opacity:.8,side:THREE.DoubleSide}),o=new THREE.Mesh(h,n);o.position.set(t.x,1,t.z),o.rotation.x=-Math.PI/2,this.scene.add(o);const c=this.camera.position.distanceTo(new THREE.Vector3(t.x,10,t.z));this.screenShake=Math.max(.5,2-c/100),this.audio.playExplosionSound();let a=1;const r=()=>{a+=.5,e.scale.set(a,a,a),i.opacity-=.03,o.scale.set(3*a,3*a,1),n.opacity-=.02,i.opacity>0?requestAnimationFrame(r):(this.scene.remove(e),this.scene.remove(o))};r()}onRoundEnd(t){const s=document.getElementById("round-end-screen"),i=document.getElementById("round-winner"),e=document.getElementById("round-reason"),h=document.getElementById("round-score");"ct"===t.winner?(i.textContent="åæç²¾è‹±è·èƒœ",i.className="ct-win"):(i.textContent="ææ€–åˆ†å­è·èƒœ",i.className="t-win"),e.textContent={bomb_exploded:"C4å·²çˆ†ç‚¸",bomb_defused:"C4å·²æ‹†é™¤",t_eliminated:"ææ€–åˆ†å­å…¨ç­",ct_eliminated:"åæç²¾è‹±å…¨ç­",time_up:"æ—¶é—´ç»“æŸ"}[t.reason]||t.reason,h.textContent=`åæç²¾è‹± ${t.ct_score} - ${t.t_score} ææ€–åˆ†å­`,this.ctScore=t.ct_score,this.tScore=t.t_score,this.updateDefuseScores(),s.style.display="flex",setTimeout(()=>{s.style.display="none"},3e3)}onRoundStart(t){if(this.currentRound=t.round,this.c4Planted=0,this.c4Position=null,this.c4PlantedTime=null,this.lastC4BeepTime=0,this.isPlanting=0,this.isDefusing=0,this.plantInterval&&(clearInterval(this.plantInterval),this.plantInterval=null),document.getElementById("round-end-screen").style.display="none",document.getElementById("c4-timer-display").style.display="none",document.getElementById("defuse-progress-container").style.display="none",document.getElementById("plant-progress-container").style.display="none",document.getElementById("plant-hint").style.display="none",document.getElementById("defuse-hint").style.display="none",document.getElementById("freeze-time-overlay").style.display="flex",this.c4Model&&(this.scene.remove(this.c4Model),this.c4Model=null),document.getElementById("current-round").textContent=this.currentRound,document.getElementById("death-screen").style.display="none",document.getElementById("game").classList.remove("dead-effect"),document.getElementById("death-overlay").classList.remove("active"),this.resetDeathAnimation(),this.stopSpectating(),t.players&&t.players[this.playerId]){const s=t.players[this.playerId];this.camera.position.set(s.x,this.standingHeight,s.y),this.players=t.players}this.hasC4=t.c4_carrier===this.playerId,this.updateDefuseHUD(),this.ammo=this.maxAmmo,this.grenadeCount=1,this.updateAmmoDisplay(),this.addKillFeed(`=== ç¬¬ ${this.currentRound} å›åˆ ===`)}onFreezeTimeEnd(){document.getElementById("freeze-time-overlay").style.display="none",this.addKillFeed("å›åˆå¼€å§‹!")}onDefuseStarted(t){t.defuser!==this.playerId&&this.addKillFeed("CTæ­£åœ¨æ‹†å¼¹...")}onDefuseCancelled(){document.getElementById("defuse-progress-container").style.display="none",this.isDefusing=0,this.defuseProgress=0}updateDefuseHUD(){if(!this.isDefuseMode)return;const t=document.getElementById("c4-status");this.hasC4?t.textContent="ä½ æºå¸¦ç€C4 (æŒ‰5åˆ‡å‡º)":this.c4Planted?t.textContent=`C4å·²å®‰æ”¾åœ¨ ${this.c4Site} ç‚¹`:t.textContent=""}updateC4BeepSound(){if(!this.c4Planted||!this.c4PlantedTime)return;const t=Date.now(),s=(t-this.c4PlantedTime)/1e3,i=Math.max(0,40-s);let e;e=i<=5?200:i<=10?400:i<=20?800:1500,(!this.lastC4BeepTime||t-this.lastC4BeepTime>=e)&&(this.audio.playC4BeepSound(i),this.lastC4BeepTime=t)}updateDefuseScores(){document.getElementById("ct-score").textContent=`åæç²¾è‹±: ${this.ctScore}`,document.getElementById("t-score").textContent=`ææ€–åˆ†å­: ${this.tScore}`}startSpectating(){if(this.isDefuseMode){if(this.spectatorTargets=this.getAliveTeammates(),0===this.spectatorTargets.length)return this.isSpectating=0,this.spectatingPlayerId=null,void this.hideSpectatorUI();this.isSpectating=1,this.spectatingPlayerId=this.spectatorTargets[0],this.spectatorYaw=0,this.spectatorPitch=-.3,this.spectatorDistance=20,this.spectatorTargetPos={x:0,y:0,z:0},this.showSpectatorUI(),this.updateSpectatorView()}}getAliveTeammates(){const t=[];for(const[s,i]of Object.entries(this.players))s!==this.playerId&&i.team===this.selectedTeam&&i.is_alive&&t.push(s);return t}switchSpectatorTarget(){if(!this.isSpectating)return;if(this.spectatorTargets=this.getAliveTeammates(),0===this.spectatorTargets.length)return void this.stopSpectating();const t=(this.spectatorTargets.indexOf(this.spectatingPlayerId)+1)%this.spectatorTargets.length;this.spectatingPlayerId=this.spectatorTargets[t],this.updateSpectatorView()}updateSpectatorView(){if(!this.isSpectating||!this.spectatingPlayerId)return;const t=this.players[this.spectatingPlayerId];if(!t||!t.is_alive)return this.spectatorTargets=this.getAliveTeammates(),void(this.spectatorTargets.length>0?(this.spectatingPlayerId=this.spectatorTargets[0],this.updateSpectatorView()):this.stopSpectating());const s=document.getElementById("spectator-name");s&&(s.textContent=t.name||"é˜Ÿå‹"),this.updateSpectatorWeapon()}stopSpectating(){this.isSpectating=0,this.spectatingPlayerId=null,this.spectatorTargets=[],this.hideSpectatorUI()}showSpectatorUI(){const t=document.getElementById("spectator-ui");t&&(t.style.display="block"),this.updateSpectatorWeapon()}updateSpectatorWeapon(){this.isSpectating&&this.spectatingPlayerId&&this.gunModel&&(this.gunModel.visible=0)}hideSpectatorUI(){const t=document.getElementById("spectator-ui");t&&(t.style.display="none"),this.gunModel&&(this.gunModel.visible=1),this.updateGunModel()}updateSpectatorCamera(){if(!this.isSpectating||!this.spectatingPlayerId)return;const t=this.players[this.spectatingPlayerId];if(!t||!t.is_alive)return void this.switchSpectatorTarget();const s=t.x,i=t.y,e=(t.height_offset||0)+this.standingHeight,h=.15;this.spectatorTargetPos||(this.spectatorTargetPos={x:s,y:e,z:i}),this.spectatorTargetPos.x+=(s-this.spectatorTargetPos.x)*h,this.spectatorTargetPos.y+=(e-this.spectatorTargetPos.y)*h,this.spectatorTargetPos.z+=(i-this.spectatorTargetPos.z)*h;const n=this.spectatorDistance||20,o=this.yaw,c=Math.max(-Math.PI/3,Math.min(Math.PI/6,this.pitch)),a=this.spectatorTargetPos.x-Math.sin(o)*Math.cos(c)*n,r=this.spectatorTargetPos.z-Math.cos(o)*Math.cos(c)*n,u=this.spectatorTargetPos.y-Math.sin(c)*n+5;this.camera.position.x=a,this.camera.position.z=r,this.camera.position.y=Math.max(2,u),this.camera.lookAt(this.spectatorTargetPos.x,this.spectatorTargetPos.y,this.spectatorTargetPos.z)}showDefuseHint(){this.c4Planted&&"ct"===this.selectedTeam&&(document.getElementById("defuse-hint").style.display="block")}isInBombSite(){if(!this.bombSites||!this.camera)return null;const t=this.camera.position.x,s=this.camera.position.z;for(const[i,e]of Object.entries(this.bombSites)){const h=t-e.x,n=s-e.z;if(Math.sqrt(h*h+n*n)<=e.radius)return i}return null}isNearC4(){if(!this.c4Planted||!this.c4Position||!this.camera)return 0;const t=this.camera.position.x-this.c4Position.x,s=this.camera.position.z-this.c4Position.z;return Math.sqrt(t*t+s*s)<=5}tryPlantC4(){this.isDefuseMode&&this.hasC4&&!this.c4Planted&&this.isInBombSite()&&this.startPlantingC4()}startPlantingC4(){this.isDefuseMode&&this.hasC4&&!this.c4Planted&&!this.isPlanting&&(this.isInBombSite()?(this.isPlanting=1,this.plantProgress=0,this.plantStartTime=Date.now(),document.getElementById("plant-progress-container").style.display="block",this.audio.playC4PlantSound(),this.plantInterval=setInterval(()=>{if(!this.isPlanting)return clearInterval(this.plantInterval),void(this.plantInterval=null);const t=(Date.now()-this.plantStartTime)/1e3;this.plantProgress=Math.min(t/3,1);const s=document.getElementById("plant-progress");if(s&&(s.style.width=100*this.plantProgress+"%"),!this.isInBombSite())return this.cancelPlanting(),void this.addKillFeed("ç¦»å¼€åŒ…ç‚¹ï¼Œä¸‹åŒ…å–æ¶ˆ");this.plantProgress>=1&&(clearInterval(this.plantInterval),this.plantInterval=null,this.isPlanting=0,document.getElementById("plant-progress-container").style.display="none",this.ws.send(JSON.stringify({action:"plant_c4"})),this.hasC4=0,this.switchToSlot(1))},50)):this.addKillFeed("ä¸åœ¨åŒ…ç‚¹èŒƒå›´å†…"))}cancelPlanting(){this.isPlanting&&(this.isPlanting=0,this.plantProgress=0,this.plantInterval&&(clearInterval(this.plantInterval),this.plantInterval=null),document.getElementById("plant-progress-container").style.display="none")}tryDefuse(){this.isDefuseMode&&this.c4Planted&&"ct"===this.selectedTeam&&this.isNearC4()&&!this.isDefusing&&(this.isDefusing=1,this.defuseStartTime=Date.now(),document.getElementById("defuse-progress-container").style.display="block",this.audio.playC4DefuseSound(),this.ws.send(JSON.stringify({action:"start_defuse"})))}updateDefuseProgress(){if(!this.isDefusing||!this.c4Planted)return;if(!this.keys.KeyE)return void this.cancelDefuse();if(!this.isNearC4())return this.cancelDefuse(),void this.addKillFeed("ç¦»å¼€C4ï¼Œæ‹†å¼¹å–æ¶ˆ");const t=(Date.now()-this.defuseStartTime)/1e3,s=Math.min(t/10,1),i=document.getElementById("defuse-progress");i&&(i.style.width=100*s+"%")}cancelDefuse(){this.isDefusing&&(this.isDefusing=0,document.getElementById("defuse-progress-container").style.display="none",this.ws.send(JSON.stringify({action:"cancel_defuse"})))}updateState(t){if(this.players=t.players,void 0!==t.ct_kills&&(this.ctKills=t.ct_kills),void 0!==t.t_kills&&(this.tKills=t.t_kills),this.updateTeamScores(),void 0!==t.remaining_time&&t.remaining_time>=0){this.remainingTime=t.remaining_time;const s=Math.floor(this.remainingTime/60),i=this.remainingTime%60;document.getElementById("game-timer").textContent=`${s}:${i.toString().padStart(2,"0")} | `,document.getElementById("game-timer").style.display="inline"}if(t.game_mode){this.selectedGameMode=t.game_mode;const s="deathmatch"===t.game_mode?"å›¢é˜Ÿç«æŠ€":"çˆ†ç ´æ¨¡å¼";document.getElementById("game-mode-text").textContent=s+" | "}if("defuse"===t.game_mode){if(void 0!==t.current_round&&(this.currentRound=t.current_round,document.getElementById("current-round").textContent=this.currentRound),void 0!==t.ct_score&&(this.ctScore=t.ct_score),void 0!==t.t_score&&(this.tScore=t.t_score),this.updateDefuseScores(),void 0!==t.round_time&&t.round_time>=0){const s=Math.floor(t.round_time/60),i=t.round_time%60;document.getElementById("game-timer").textContent=`${s}:${i.toString().padStart(2,"0")} | `,document.getElementById("game-timer").style.display="inline"}t.is_freeze_time?(document.getElementById("freeze-time-overlay").style.display="flex",void 0!==t.round_time&&(document.getElementById("freeze-countdown").textContent=`å‡†å¤‡é˜¶æ®µ ${t.round_time}`)):document.getElementById("freeze-time-overlay").style.display="none",t.c4_planted?(this.c4Planted=1,t.c4_position&&(this.c4Position=t.c4_position),t.c4_site&&(this.c4Site=t.c4_site),void 0!==t.c4_time&&(document.getElementById("c4-timer-display").style.display="block",document.getElementById("c4-countdown").textContent=t.c4_time,document.getElementById("c4-timer-display").style.animationDuration=t.c4_time<=10?"0.25s":"0.5s"),"ct"===this.selectedTeam&&this.isNearC4()?document.getElementById("defuse-hint").style.display="block":document.getElementById("defuse-hint").style.display="none"):(this.c4Planted=0,document.getElementById("c4-timer-display").style.display="none",document.getElementById("defuse-hint").style.display="none"),void 0!==t.defuse_progress&&t.defuse_progress>0&&t.defuser_id===this.playerId?(document.getElementById("defuse-progress-container").style.display="block",document.getElementById("defuse-progress-bar").style.setProperty("--progress",100*t.defuse_progress+"%")):this.isDefusing||(document.getElementById("defuse-progress-container").style.display="none"),t.c4_carrier===this.playerId?(this.hasC4=1,!this.isInBombSite()||t.c4_planted||t.is_freeze_time?document.getElementById("plant-hint").style.display="none":document.getElementById("plant-hint").style.display="block"):(this.hasC4=0,document.getElementById("plant-hint").style.display="none"),this.updateDefuseHUD()}Object.entries(this.players).forEach(([t,s])=>{if(t===this.playerId)return void this.updateHUD(s);if(!s.is_alive){if(this.playerMeshes[t]){const s=this.playerMeshes[t];s.userData.isDying||s.userData.isDead||(s.userData.isDying=1,s.userData.deathStartTime=Date.now(),s.userData.deathStartRotationX=s.rotation.x||0,s.userData.deathStartY=s.position.y)}return}if(this.playerMeshes[t]&&(this.playerMeshes[t].userData.isDying||this.playerMeshes[t].userData.isDead)&&(this.scene.remove(this.playerMeshes[t]),delete this.playerMeshes[t]),!this.playerMeshes[t]||this.playerMeshes[t].userData.crouching!==s.crouching||this.playerMeshes[t].userData.weapon!==s.weapon){let i=null,e=null;this.playerMeshes[t]&&(i=this.playerMeshes[t].position.clone(),e=this.playerMeshes[t].rotation.y,this.scene.remove(this.playerMeshes[t]));const h=PlayerModel.create(s.team,s.crouching,s.weapon);h.userData.crouching=s.crouching,h.userData.weapon=s.weapon,h.userData.meshId=Date.now()+"_"+t,i?(h.position.copy(i),h.rotation.y=e):(h.position.set(s.x,s.height_offset||0,s.y),h.rotation.y=-s.angle+Math.PI/2),this.scene.add(h),this.playerMeshes[t]=h}const i=this.playerMeshes[t];i&&(i.userData.targetX=s.x,i.userData.targetZ=s.y,i.userData.targetY=s.height_offset||0,i.userData.targetAngle=-s.angle+Math.PI/2,i.userData.isShooting=s.is_shooting)}),Object.keys(this.playerMeshes).forEach(t=>{t===this.playerId||this.players[t]||(this.scene.remove(this.playerMeshes[t]),delete this.playerMeshes[t])})}updateOtherPlayers(){const t=.3;for(const[s,i]of Object.entries(this.playerMeshes)){if(i.userData.isDying){const t=Date.now()-i.userData.deathStartTime,e=600,h=Math.min(t/e,1),n=1-Math.pow(1-h,3);if(i.rotation.x=i.userData.deathStartRotationX+Math.PI/2*n,i.position.y=i.userData.deathStartY-3*n,h>=1){i.userData.isDying=0,i.userData.isDead=1;const t=i.userData.meshId;setTimeout(()=>{this.playerMeshes[s]&&this.playerMeshes[s].userData.isDead&&this.playerMeshes[s].userData.meshId===t&&(this.scene.remove(this.playerMeshes[s]),delete this.playerMeshes[s])},3e3)}continue}if(i.userData.isDead)continue;if(!i.userData.targetX)continue;i.userData.isShooting&&PlayerModel.showMuzzleFlash(i);const e=i.userData.targetX-i.position.x,h=i.userData.targetZ-i.position.z,n=Math.sqrt(e*e+h*h);i.userData.lastPosX||(i.userData.lastPosX=i.position.x,i.userData.lastPosZ=i.position.z);const o=i.position.x-i.userData.lastPosX,c=i.position.z-i.userData.lastPosZ,a=Math.sqrt(o*o+c*c);i.userData.lastPosX=i.position.x,i.userData.lastPosZ=i.position.z,i.userData.smoothSpeed||(i.userData.smoothSpeed=0),i.userData.smoothSpeed=.8*i.userData.smoothSpeed+.2*a;const r=i.userData.smoothSpeed>.05||n>.5;if(n>50)i.position.x=i.userData.targetX,i.position.z=i.userData.targetZ,i.position.y=i.userData.targetY,i.rotation.y=i.userData.targetAngle;else{i.position.x+=e*t,i.position.z+=h*t,r?(i.userData.walkPhase||(i.userData.walkPhase=0),i.userData.walkPhase+=.25,PlayerModel.animateWalk(i,i.userData.walkPhase),i.position.y+=(i.userData.targetY-i.position.y)*t):(i.position.y+=(i.userData.targetY-i.position.y)*t,PlayerModel.resetLegs(i),i.userData.walkPhase=0);let s=i.userData.targetAngle-i.rotation.y;for(;s>Math.PI;)s-=2*Math.PI;for(;s<-Math.PI;)s+=2*Math.PI;i.rotation.y+=s*t}}}respawn(){this.ws&&this.ws.readyState===WebSocket.OPEN&&this.ws.send(JSON.stringify({action:"respawn"}))}checkRotatedRectCollision(t,s,i,e,h,n,o){const c=Math.cos(-o),a=Math.sin(-o),r=t-i,u=s-e,l=r*c-u*a,d=r*a+u*c,m=l-Math.max(-h,Math.min(h,l)),p=d-Math.max(-n,Math.min(n,d)),f=Math.sqrt(m*m+p*p);let M,b;if(Math.abs(l)<=h&&Math.abs(d)<=n){const t=l+h,s=h-l,i=d+n,e=n-d,c=Math.min(t,s,i,e);let a=0,r=0;c===t?a=-1:c===s?a=1:r=c===i?-1:1;const u=Math.cos(o),m=Math.sin(o);return M=a*u-r*m,b=a*m+r*u,{dist:-c,pushX:M,pushZ:b,isInside:1,penetration:c}}if(f>.001){const t=m/f,s=p/f,i=Math.cos(o),e=Math.sin(o);M=t*i-s*e,b=t*e+s*i}else M=1,b=0;return{dist:f,pushX:M,pushZ:b,isInside:0,penetration:0}}checkCollision(t,s,i=null){const e=2.5,h=MapConfigs[this.selectedMap],n=h&&h.mapSize||125,o=null!==i?i:this.camera.position.y,c=o;let a=t,r=s,u=0,l=0;a<-n&&(a=-n,u=1),a>n&&(a=n,u=1),r<-n&&(r=-n,u=1),r>n&&(r=n,u=1);for(let t=0;t<4;t++){let t=0,s=0,i=0;for(const h of this.walls){const n=h.h||20,d=h.hBottom||0,m=o-this.standingHeight;if(!(c<d)){if(m>=n-.5){let t=0;if(h.rotation&&0!==h.rotation){const s=(h.originalW||h.w)/2,i=(h.originalD||h.d)/2,e=void 0!==h.centerX?h.centerX:h.x+h.w/2,n=void 0!==h.centerZ?h.centerZ:h.z+h.d/2;t=this.checkRotatedRectCollision(a,r,e,n,s,i,h.rotation).isInside}else{const s=h.x,i=h.z,e=h.w,n=h.d;t=a>=s&&a<=s+e&&r>=i&&r<=i+n}t&&n<=20&&(l=Math.max(l,n));continue}if(h.rotation&&0!==h.rotation){const n=(h.originalW||h.w)/2,o=(h.originalD||h.d)/2,c=void 0!==h.centerX?h.centerX:h.x+h.w/2,l=void 0!==h.centerZ?h.centerZ:h.z+h.d/2,d=this.checkRotatedRectCollision(a,r,c,l,n,o,h.rotation);if(d.isInside){const h=d.penetration+e;h>t&&(t=h,s=d.pushX*h,i=d.pushZ*h),u=1}else if(d.dist<e){const h=e-d.dist;h>t&&(t=h,s=d.pushX*h,i=d.pushZ*h),u=1}}else{const n=h.x,o=h.z,c=h.w,l=h.d,d=a-Math.max(n,Math.min(a,n+c)),m=r-Math.max(o,Math.min(r,o+l)),p=Math.sqrt(d*d+m*m);if(p<e){u=1;const h=e-p;if(h>t)if(t=h,p>.01)s=d/p*h,i=m/p*h;else{const t=a-n,h=n+c-a,u=r-o,d=o+l-r,m=Math.min(t,h,u,d);m===t?(s=-(e+t),i=0):m===h?(s=e+h,i=0):m===u?(s=0,i=-(e+u)):(s=0,i=e+d)}}}}}if(!(t>.01))break;a+=s,r+=i}return a=Math.max(-n,Math.min(n,a)),r=Math.max(-n,Math.min(n,r)),{blocked:u,pushX:a-t,pushZ:r-s,clampedX:a,clampedZ:r,standingOnHeight:l}}canStandAt(t,s){for(const i of this.walls){const e=i.h||20;if(e<=this.crouchingHeight||e>this.standingHeight)continue;let h;if(i.rotation&&0!==i.rotation){const e=(i.originalW||i.w)/2,n=(i.originalD||i.d)/2,o=void 0!==i.centerX?i.centerX:i.x+i.w/2,c=void 0!==i.centerZ?i.centerZ:i.z+i.d/2,a=this.checkRotatedRectCollision(t,s,o,c,e,n,i.rotation);h=a.isInside?-a.penetration:a.dist}else{const e=i.x,n=i.z,o=i.w,c=i.d,a=t-Math.max(e,Math.min(t,e+o)),r=s-Math.max(n,Math.min(s,n+c));h=Math.sqrt(a*a+r*r)}if(h<2.5)return 0}return 1}update(t){const s=t/(1/60);if(this.isLocked&&this.isFiring){const t=WeaponConfigs[this.currentWeapon];t&&t.auto&&this.shoot()}if(this.isFiring||(Date.now()-this.lastShotReleaseTime>150&&(this.shotsFired=Math.max(0,this.shotsFired-1),0===this.shotsFired&&(this.recoilAccumulator*=.85)),this.crosshairOffset*=.9),this.isDefusing&&this.updateDefuseProgress(),this.updateMobileDefuseButton(),this.c4Planted&&this.isDefuseMode&&this.updateC4BeepSound(),!this.playerId||this.gameOver)return this.updateGunAnimation(s),void this.updateOtherPlayers();const i=this.players[this.playerId];if(!i||!i.is_alive)return this.isSpectating&&this.updateSpectatorCamera(),this.updateGunAnimation(s),void this.updateOtherPlayers();const e=this.isCrouching?10:18;let h=1;"knife"===this.currentWeapon?h=1.3:"awp"===this.currentWeapon&&(h=.8);const n=e*t*h;let o=0,c=0;if(this.keys.KeyW&&(c=-1),this.keys.KeyS&&(c=1),this.keys.KeyA&&(o=-1),this.keys.KeyD&&(o=1),0!==o||0!==c){const t=this.yaw,s=(Math.sin(t)*c+Math.cos(t)*o)*n,i=(Math.cos(t)*c-Math.sin(t)*o)*n;let e=this.camera.position.x+s,h=this.camera.position.z+i;const a=this.checkCollision(e,h);a.blocked&&(e=a.clampedX,h=a.clampedZ),this.currentStandingHeight=a.standingOnHeight||0,this.camera.position.x=e,this.camera.position.z=h,this.audio.playFootstep()}this.keys.Space&&this.canJump&&(this.velocity.y=this.isCrouching?39:45,this.canJump=0);const a=(this.isCrouching?this.crouchingHeight:this.standingHeight)+(this.currentStandingHeight||0);if(this.targetCameraHeight=a,this.canJump){const s=this.targetCameraHeight-this.camera.position.y;if(Math.abs(s)>.1){const i=this.isCrouching?50:15;this.camera.position.y+=s*Math.min(i*t,1)}else this.camera.position.y=this.targetCameraHeight}else{const s=150;this.velocity.y-=s*t,this.camera.position.y+=this.velocity.y*t,this.camera.position.y<a&&(this.camera.position.y=a,this.velocity.y=0,this.canJump=1)}this.currentHeight=this.camera.position.y;const r=performance.now();this.ws&&this.ws.readyState===WebSocket.OPEN&&r-this.lastNetworkSend>=this.networkSendInterval&&(this.lastNetworkSend=r,this.ws.send(JSON.stringify({action:"update_position",x:this.camera.position.x,z:this.camera.position.z,height:this.currentHeight,crouching:this.isCrouching,angle:-this.yaw+Math.PI/2}))),this.updateGunAnimation(s),this.updateOtherPlayers()}updateGunAnimation(t=1){if(this.gunModel&&this.gunBasePosition&&this.gunBaseRotation){if(this.gunModel.position.copy(this.gunBasePosition),this.gunModel.rotation.copy(this.gunBaseRotation),this.gunRecoil>.005){this.gunRecoil*=.88;const t=.1*this.gunRecoil,s=.04*this.gunRecoil,i=.15*this.gunRecoil;this.gunModel.position.z+=t,this.gunModel.position.y+=s,this.gunModel.rotation.x-=i}else this.gunRecoil=0;if(this.isReloading){this.reloadAnimProgress+=.02;const t=this.reloadAnimProgress%1;t<.3?this.gunModel.rotation.z+=1*t:t<.7?this.gunModel.position.y-=.1*(t-.3):this.gunModel.rotation.z+=1*(1-t)}if(this.isSwitchingWeapon&&this.switchAnimProgress<1){this.switchAnimProgress+=.05;const t=.3*Math.sin(this.switchAnimProgress*Math.PI);this.gunModel.position.y-=t}this.screenShake*=.9,this.updateCrosshair()}}animate(){requestAnimationFrame(()=>this.animate());const t=performance.now();if(this.fpsFrameCount++,t-this.fpsLastTime>=1e3){this.currentFPS=this.fpsFrameCount,this.fpsFrameCount=0,this.fpsLastTime=t;const s=document.getElementById("fps-counter");s&&(s.textContent=`FPS: ${this.currentFPS}`)}this.processMouseMovement();const s=(t-this.lastFrameTime)/1e3;this.lastFrameTime=t;const i=Math.min(s,.1);if(this.update(i),this.minimap&&this.minimap.update(),this.fpsFrameCount%5==0&&this.checkCrosshairTarget(),this.c4Planted&&this.c4Model){const s=this.c4Position&&this.getC4RemainingTime&&this.getC4RemainingTime()<=10?200:500,i=Math.floor(t/s)%2==0;if(this.c4Light&&(this.c4Light.material.color.setHex(i?16711680:3342336),this.c4Light.material.emissive=this.c4Light.material.color),this.c4Glow){const s=.15*Math.sin(t/300)+.25;this.c4Glow.material.opacity=s,this.c4Glow.scale.set(1+.5*s,1+.5*s,1)}if(this.c4Beam){this.c4Beam.rotation.y+=.02;const s=.05*Math.sin(t/400)+.12;this.c4Beam.material.opacity=s}}let e=0,h=0,n=0,o=0;this.screenShake>.001&&(e=(Math.random()-.5)*this.screenShake*2,h=(Math.random()-.5)*this.screenShake*1.5,n=(Math.random()-.5)*this.screenShake*.02,o=(Math.random()-.5)*this.screenShake*.015,this.camera.position.x+=e,this.camera.position.y+=h,this.camera.rotation.x+=n,this.camera.rotation.y+=o),this.renderer.render(this.scene,this.camera),this.screenShake>.001&&(this.camera.position.x-=e,this.camera.position.y-=h,this.camera.rotation.x-=n,this.camera.rotation.y-=o)}}const game=new PixelCS3D;