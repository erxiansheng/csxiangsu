const DEFAULT_WS_SERVER_URL="wss://cs16xs.188np.cn";let WS_SERVER_URL=localStorage.getItem("cs_server_url")||DEFAULT_WS_SERVER_URL;async function loadDefaultServerURL(){try{const t=await fetch("/api/config");if(t.ok){const s=await t.json();s.wsServerURL&&!localStorage.getItem("cs_server_url")&&(WS_SERVER_URL=s.wsServerURL,console.log("ä» ESA/KV åŠ è½½æœåŠ¡å™¨åœ°å€:",WS_SERVER_URL))}}catch(t){console.warn("æ— æ³•ä» ESA/KV åŠ è½½æœåŠ¡å™¨åœ°å€ï¼Œä½¿ç”¨é»˜è®¤å€¼")}}function showPixelToast(t,s="info",i=null){const e=document.getElementById("pixel-toast-overlay"),n=document.getElementById("pixel-toast");if(!e||!n)return alert(t),void(i&&i());const o=n.querySelector(".pixel-toast-icon"),h=n.querySelector(".pixel-toast-title"),c=n.querySelector(".pixel-toast-body"),a=n.querySelector(".pixel-toast-btn"),r={info:{icon:"ğŸ“¢",title:"æç¤º"},success:{icon:"âœ…",title:"æˆåŠŸ"},error:{icon:"âŒ",title:"é”™è¯¯"},warning:{icon:"âš ï¸",title:"è­¦å‘Š"}},l=r[s]||r.info;o.textContent=l.icon,h.textContent=l.title,c.textContent=t,n.className="show "+s,e.className="show";const d=()=>{n.className="",e.className="",a.removeEventListener("click",d),i&&i()};a.addEventListener("click",d),e.onclick=d}loadDefaultServerURL();class PixelCS3D{constructor(){this.scene=null,this.camera=null,this.renderer=null,this.ws=null,this.playerId=null,this.players={},this.playerMeshes={},this.walls=[],this.keys={},this.velocity=new THREE.Vector3,this.isLocked=!1,this.canJump=!0,this.pitch=0,this.yaw=0,this.targetKills=20,this.selectedTeam="ct",this.selectedMap="indoor",this.selectedGameMode="deathmatch",this.isCreating=!1,this.gameOver=!1,this.ctKills=0,this.tKills=0,this.remainingTime=-1,this.pendingMouseX=0,this.pendingMouseY=0,this.isCrouching=!1,this.standingHeight=10,this.crouchingHeight=6,this.currentHeight=10,this.currentStandingHeight=0,this.targetCameraHeight=10,this.primaryWeapon="ak47",this.secondaryWeapon="pistol",this.currentWeapon="ak47",this.previousWeapon="pistol",this.grenadeCount=1,this.gunModel=null,this.gunBasePosition=null,this.gunBaseRotation=null,this.gunRecoil=0,this.recoilAccumulator=0,this.weaponRecoil=.08,this.isKnifeAttacking=!1,this.knifeAttackType="light",this.knifeAttackStartTime=0,this.knifeAttackDuration=300,this.isReloading=!1,this.ammo=30,this.maxAmmo=30,this.fireRate=100,this.lastShot=0,this.lastShotReleaseTime=0,this.isFiring=!1,this.shotsFired=0,this.screenShake=0,this.reloadAnimProgress=0,this.isSwitchingWeapon=!1,this.switchAnimProgress=0,this.crosshairOffset=0,this.isScoped=!1,this.scopeLevel=0,this.normalFOV=75,this.scopedFOV1=20,this.scopedFOV2=8,this.buyMenuOpen=!1,this.settingsMenuOpen=!1,this.respawnTimer=null,this.respawnCountdown=3,this.baseSensitivity=.002,this.sensitivityMultiplier=1,this.scopeSensitivityMultiplier=.6,this.scopeSensitivityMultiplier2=.3,this.masterVolume=1,this.killStreak=0,this.lastKillTime=0,this.killStreakTimeout=5e3,this.targetFPS=120,this.frameInterval=1e3/this.targetFPS,this.lastFrameTime=0,this.fpsFrameCount=0,this.fpsLastTime=0,this.currentFPS=0,this.lastNetworkSend=0,this.networkSendInterval=33,this.lastPingTime=0,this.currentPing=0,this.pingInterval=null,this.minimap=null,this.isDefuseMode=!1,this.hasC4=!1,this.c4Planted=!1,this.c4Position=null,this.c4Site=null,this.isPlanting=!1,this.isDefusing=!1,this.plantProgress=0,this.defuseProgress=0,this.plantInterval=null,this.c4Model=null,this.c4Light=null,this.c4Glow=null,this.c4Beam=null,this.customMapData=null,this.waitingForCustomMap=!1,this.isSpectating=!1,this.spectatingPlayerId=null,this.spectatorTargets=[],this.reconnectAttempts=0,this.maxReconnectAttempts=5,this.reconnectDelay=1e3,this.isReconnecting=!1,this.connectionInfo=null,this.audio=new AudioSystem,this.weaponBuilder=null,this.setupEventListeners(),this.setupVisibilityHandler()}setupVisibilityHandler(){document.addEventListener("visibilitychange",()=>{"visible"===document.visibilityState&&this.ws&&this.ws.readyState!==WebSocket.OPEN&&this.connectionInfo&&(console.log("é¡µé¢æ¢å¤å¯è§ï¼Œæ£€æµ‹åˆ°è¿æ¥æ–­å¼€ï¼Œå°è¯•é‡è¿..."),this.attemptReconnect())}),window.addEventListener("online",()=>{this.ws&&this.ws.readyState!==WebSocket.OPEN&&this.connectionInfo&&(console.log("ç½‘ç»œæ¢å¤ï¼Œå°è¯•é‡è¿..."),this.attemptReconnect())})}setupEventListeners(){document.getElementById("joinBtn").addEventListener("click",()=>this.joinGame()),document.getElementById("createBtn").addEventListener("click",()=>this.createGame()),document.getElementById("teamCT").addEventListener("click",()=>this.selectTeam("ct")),document.getElementById("teamT").addEventListener("click",()=>this.selectTeam("t")),document.getElementById("tabJoin").addEventListener("click",()=>this.switchTab(!1)),document.getElementById("tabCreate").addEventListener("click",()=>this.switchTab(!0)),document.getElementById("gameMode").addEventListener("change",t=>this.onGameModeChange(t.target.value)),document.querySelectorAll(".buy-btn").forEach(t=>{t.addEventListener("click",()=>this.buyPrimaryWeapon(t.dataset.weapon))}),document.addEventListener("keydown",t=>this.onKeyDown(t),{capture:!0}),document.addEventListener("keyup",t=>this.onKeyUp(t),{capture:!0}),document.addEventListener("mousedown",t=>this.onMouseDown(t)),document.addEventListener("mouseup",t=>this.onMouseUp(t)),document.addEventListener("contextmenu",t=>t.preventDefault()),document.addEventListener("pointerlockchange",()=>{this.isMobile?this.isLocked=!0:(this.isLocked=null!==document.pointerLockElement,this.isLocked||(this.isFiring=!1))}),this.preloadMaps(),this.loadAnnouncement(),this.initCustomMapImport(),this.initServerConfig(),this.initMobileControls(),this.initPublicRooms(),this.initMobileDrawer(),this.checkIOSPWA()}initMobileDrawer(){const t=document.getElementById("mobile-drawer"),s=document.getElementById("drawer-overlay"),i=document.getElementById("drawer-close"),e=document.getElementById("drawer-help-btn"),n=document.getElementById("drawer-rooms-btn"),o=document.getElementById("drawer-news-btn");if(!t)return;const h=i=>{const e=document.getElementById("drawer-title"),n=document.getElementById("drawer-content");if("help"===i)e.textContent="ğŸ® æ¸¸æˆç©æ³•",n.innerHTML='\n                    <div class="drawer-help-section">\n                        <h4>ğŸ¯ åŸºç¡€æ“ä½œ</h4>\n                        <p><span class="key">WASD</span> ç§»åŠ¨</p>\n                        <p><span class="key">é¼ æ ‡</span> è§†è§’æ§åˆ¶</p>\n                        <p><span class="key">å·¦é”®</span> å°„å‡»/æ”»å‡»</p>\n                        <p><span class="key">å³é”®</span> å¼€é•œ (AWP)</p>\n                        <p><span class="key">æ»šè½®</span> åˆ‡æ¢æ­¦å™¨</p>\n                    </div>\n                    <div class="drawer-help-section">\n                        <h4>ğŸƒ è¿›é˜¶æ“ä½œ</h4>\n                        <p><span class="key">ç©ºæ ¼</span> è·³è·ƒ</p>\n                        <p><span class="key">Ctrl</span> ä¸‹è¹²</p>\n                        <p><span class="key">R</span> æ¢å¼¹</p>\n                        <p><span class="key">Q</span> å¿«é€Ÿåˆ‡æª</p>\n                        <p><span class="key">E</span> æ‹†å¼¹/å®‰è£…C4</p>\n                    </div>\n                    <div class="drawer-help-section">\n                        <h4>ğŸ”« æ­¦å™¨åˆ‡æ¢</h4>\n                        <p><span class="key">1</span> ä¸»æ­¦å™¨</p>\n                        <p><span class="key">2</span> å‰¯æ­¦å™¨</p>\n                        <p><span class="key">3</span> è¿‘æˆ˜ (åˆ€)</p>\n                        <p><span class="key">4</span> æ‰‹é›·</p>\n                        <p><span class="key">5</span> C4ç‚¸å¼¹</p>\n                    </div>\n                    <div class="drawer-help-section">\n                        <h4>âš™ï¸ ç³»ç»ŸåŠŸèƒ½</h4>\n                        <p><span class="key">B</span> è´­ä¹°æ­¦å™¨</p>\n                        <p><span class="key">Tab</span> æŸ¥çœ‹æˆ˜ç»©</p>\n                        <p><span class="key">ESC</span> è®¾ç½®/æš‚åœ</p>\n                        <p><span class="key">G</span> ä¸¢å¼ƒæ­¦å™¨ï¼ˆå¾…å¼€å‘ï¼‰</p>\n                    </div>\n                    <div class="drawer-help-section">\n                        <h4>ğŸ’¡ æ¸¸æˆæç¤º</h4>\n                        <p style="color:#fbbf24;">â€¢ çˆ†å¤´ä¼¤å®³ç¿»å€</p>\n                        <p style="color:#fbbf24;">â€¢ è¹²ä¸‹å°„å‡»æ›´ç²¾å‡†</p>\n                        <p style="color:#fbbf24;">â€¢ AWPåŒå‡»å³é”®äºŒå€é•œ</p>\n                        <p style="color:#fbbf24;">â€¢ è¿æ€æœ‰ç‰¹æ®ŠéŸ³æ•ˆ</p>\n                    </div>\n                ';else if("rooms"===i){e.textContent="ğŸŒ å…¬å¼€æˆ¿é—´";const t={dust2:"æ²™æ¼ ç°",indoor:"å®¤å†…ç«æŠ€åœº",office:"åŠå…¬å®¤",aztec:"é˜¿å…¹ç‰¹å…‹"};n.innerHTML=`\n                    <div class="drawer-rooms-grid">\n                        ${this.publicRooms.map(s=>`\n                            <button class="drawer-room-btn ${s.mode}" data-room="${s.id}" data-mode="${s.mode}" data-map="${s.map}">\n                                <span class="room-name">${"defuse"===s.mode?"çˆ†ç ´":"ç«æŠ€"}${s.id.slice(-1)}å·</span>\n                                <span class="room-map">${t[s.map]||s.map}</span>\n                                <span class="room-players" id="drawer-${s.id}-players">æŸ¥è¯¢ä¸­...</span>\n                            </button>\n                        `).join("")}\n                    </div>\n                `,n.querySelectorAll(".drawer-room-btn").forEach(t=>{t.addEventListener("click",()=>{c(),this.joinPublicRoom(t.dataset.room,t.dataset.mode,t.dataset.map)})}),this.refreshDrawerRoomsStatus()}else if("news"===i){e.textContent="ğŸ“¢ æ¸¸æˆå…¬å‘Š";const t=document.getElementById("announcement-content");n.innerHTML=t?t.innerHTML.replace(/announcement-/g,"drawer-announcement-"):'<p style="color:#888;text-align:center;">åŠ è½½ä¸­...</p>'}t.classList.remove("drawer-hidden"),t.classList.add("drawer-visible"),s.classList.add("visible")},c=()=>{t.classList.remove("drawer-visible"),t.classList.add("drawer-hidden"),s.classList.remove("visible")};e&&e.addEventListener("click",()=>h("help")),n&&n.addEventListener("click",()=>h("rooms")),o&&o.addEventListener("click",()=>h("news")),i&&i.addEventListener("click",c),s&&s.addEventListener("click",c)}async refreshDrawerRoomsStatus(){for(const t of this.publicRooms)try{const s=new WebSocket(WS_SERVER_URL);s.onopen=()=>{s.send(JSON.stringify({action:"check_room",room_id:t.id}))},s.onmessage=i=>{try{const s=JSON.parse(i.data);if("room_check"===s.action){const i=s.player_count||0,e=document.getElementById(`drawer-${t.id}-players`);e&&(e.textContent=`${i}/16`)}}catch(t){}s.close()},s.onerror=()=>{const i=document.getElementById(`drawer-${t.id}-players`);i&&(i.textContent="0/16"),s.close()},setTimeout(()=>{s.readyState!==WebSocket.OPEN&&s.readyState!==WebSocket.CONNECTING||s.close()},2e3)}catch(t){}}initPublicRooms(){this.publicRooms=[{id:"DEFUSE01",mode:"defuse",map:"dust2"},{id:"DEFUSE02",mode:"defuse",map:"dust2"},{id:"DEFUSE03",mode:"defuse",map:"dust2"},{id:"TEAM0001",mode:"deathmatch",map:"indoor"},{id:"TEAM0002",mode:"deathmatch",map:"indoor"},{id:"TEAM0003",mode:"deathmatch",map:"indoor"}],document.querySelectorAll(".public-room-btn").forEach(t=>{t.addEventListener("click",()=>{const s=t.dataset.room,i=t.dataset.mode,e=t.dataset.map;this.joinPublicRoom(s,i,e)})}),this.refreshPublicRoomsStatus(),setInterval(()=>this.refreshPublicRoomsStatus(),5e3)}async refreshPublicRoomsStatus(){for(const t of this.publicRooms)try{const s=new WebSocket(WS_SERVER_URL);s.onopen=()=>{s.send(JSON.stringify({action:"check_room",room_id:t.id}))},s.onmessage=i=>{try{const s=JSON.parse(i.data);if("room_check"===s.action){const i=s.player_count||0,e=document.getElementById(`room-${t.id}-players`);e&&(e.textContent=`${i}/16`);const n=document.getElementById(`drawer-${t.id}-players`);n&&(n.textContent=`${i}/16`)}}catch(t){}s.close()},s.onerror=()=>s.close(),setTimeout(()=>{s.readyState!==WebSocket.OPEN&&s.readyState!==WebSocket.CONNECTING||s.close()},2e3)}catch(t){}}joinPublicRoom(t,s,i){const e=document.getElementById("quick-join-modal"),n=document.getElementById("quick-join-room-name"),o=document.getElementById("quick-join-room-mode"),h=document.getElementById("quickJoinName"),c=document.getElementById("quick-join-confirm"),a=document.getElementById("quick-join-cancel"),r=document.getElementById("quickJoinTeamCT"),l=document.getElementById("quickJoinTeamT");if(!e)return;let d="ct";r.classList.add("active"),l.classList.remove("active");const u=()=>{d="ct",r.classList.add("active"),l.classList.remove("active")},m=()=>{d="t",l.classList.add("active"),r.classList.remove("active")};r.addEventListener("click",u),l.addEventListener("click",m),n.textContent={DEFUSE01:"çˆ†ç ´1å·",DEFUSE02:"çˆ†ç ´2å·",DEFUSE03:"çˆ†ç ´3å·",TEAM0001:"ç«æŠ€1å·",TEAM0002:"ç«æŠ€2å·",TEAM0003:"ç«æŠ€3å·"}[t]||t,o.textContent=("defuse"===s?"çˆ†ç ´æ¨¡å¼":"å›¢é˜Ÿç«æŠ€")+" | "+({dust2:"æ²™æ¼ ç°",indoor:"å®¤å†…ç«æŠ€åœº",office:"åŠå…¬å®¤",aztec:"é˜¿å…¹ç‰¹å…‹"}[i]||i),h.value="",e.style.display="flex",h.focus();const p=t,f=s,b=i,w=()=>{const t=h.value.trim();if(!t||t.length<2||t.length>8)return showPixelToast("è¯·è¾“å…¥2-8ä¸ªå­—ç¬¦çš„åç§°","warning"),void h.focus();e.style.display="none",k(),this.selectedTeam=d,this.selectedMap=b,this.selectedGameMode=f,this.joinOrCreatePublicRoom(t,p,f,b)},v=()=>{e.style.display="none",k()},M=t=>{"Enter"===t.key?w():"Escape"===t.key&&v()},k=()=>{c.removeEventListener("click",w),a.removeEventListener("click",v),h.removeEventListener("keydown",M),e.removeEventListener("click",E),r.removeEventListener("click",u),l.removeEventListener("click",m)},E=t=>{t.target===e&&v()};c.addEventListener("click",w),a.addEventListener("click",v),h.addEventListener("keydown",M),e.addEventListener("click",E)}joinOrCreatePublicRoom(t,s,i,e){const n=new WebSocket(WS_SERVER_URL);n.onopen=()=>{n.send(JSON.stringify({action:"check_room",room_id:s}))},n.onmessage=async o=>{try{const h=JSON.parse(o.data);if("room_check"===h.action)if(n.close(),h.exists)this.isCreating=!1,"defuse"===i&&(this.waitingForCustomMap=!0,this.selectedGameMode="defuse"),this.startGame(t,s,!1);else{if(this.isCreating=!0,this.selectedMap=e,this.selectedGameMode=i,this.targetKills=20,"defuse"===i&&"dust2"===e)try{this.showMapLoadingOverlay("æ­£åœ¨åŠ è½½æ²™æ¼ ç°åœ°å›¾...");const t=await fetch("custom_dust2.json"),s=await t.json();this.loadCustomMap(s),this.customMapData=s,this.hideMapLoadingOverlay()}catch(t){console.error("åŠ è½½åœ°å›¾æ–‡ä»¶å¤±è´¥:",t),this.hideMapLoadingOverlay()}this.startGame(t,s,!0)}}catch(t){n.close()}},n.onerror=()=>{n.close(),showPixelToast("è¿æ¥æœåŠ¡å™¨å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•","error")}}checkIOSPWA(){const t=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream,s=!0===window.navigator.standalone;t&&!s&&setTimeout(()=>{this.showIOSPWAPrompt()},1500)}showIOSPWAPrompt(){const t=document.getElementById("ios-pwa-prompt");if(!t)return;t.style.display="flex";const s=document.getElementById("ios-prompt-close"),i=document.getElementById("ios-prompt-dismiss"),e=()=>{t.style.display="none"};s&&s.addEventListener("click",e),i&&i.addEventListener("click",e),t.addEventListener("click",s=>{s.target===t&&e()})}initMobileControls(){if(this.isMobile=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)||"ontouchstart"in window||navigator.maxTouchPoints>0,!this.isMobile)return;const t=document.getElementById("mobile-controls");t&&(t.style.display="block",this.isLocked=!0,this.setupJoystick(),this.setupMobileButtons(),this.setupTouchLook(),this.lockLandscape())}lockLandscape(){screen.orientation&&screen.orientation.lock&&screen.orientation.lock("landscape").catch(()=>{console.log("æ— æ³•é”å®šå±å¹•æ–¹å‘")})}setupJoystick(){const t=document.getElementById("joystick-base"),s=document.getElementById("joystick-stick");if(!t||!s)return;let i=!1,e=null,n={x:0,y:0};const o=(t,e)=>{if(!i)return;const o=t-n.x,h=e-n.y,c=Math.sqrt(o*o+h*h),a=Math.min(c,58),r=Math.atan2(h,o),l=Math.cos(r)*a,d=Math.sin(r)*a;s.style.transform=`translate(${l}px, ${d}px)`,this.keys.KeyW=h<-10,this.keys.KeyS=h>10,this.keys.KeyA=o<-10,this.keys.KeyD=o>10};t.addEventListener("touchstart",s=>{s.preventDefault(),s.stopPropagation();const h=s.changedTouches[0];i=!0,e=h.identifier;const c=t.getBoundingClientRect();n={x:c.left+c.width/2,y:c.top+c.height/2},o(h.clientX,h.clientY)},{passive:!1}),document.addEventListener("touchmove",t=>{if(i)for(let s=0;s<t.touches.length;s++)if(t.touches[s].identifier===e){o(t.touches[s].clientX,t.touches[s].clientY);break}},{passive:!0}),document.addEventListener("touchend",t=>{for(let n=0;n<t.changedTouches.length;n++)if(t.changedTouches[n].identifier===e){i=!1,e=null,s.style.transform="translate(0, 0)",this.keys.KeyW=!1,this.keys.KeyS=!1,this.keys.KeyA=!1,this.keys.KeyD=!1;break}})}setupMobileButtons(){const t=document.getElementById("mobile-shoot");if(t){let s=null,i=0,e=0,n=!1;const o=this;t.addEventListener("touchstart",t=>{t.preventDefault(),t.stopPropagation();const h=t.changedTouches[0];s=h.identifier,i=h.clientX,e=h.clientY,n=!1,o.isDefuseMode&&"c4"===o.currentWeapon&&o.hasC4&&!o.c4Planted&&o.isInBombSite()?o.startPlantingC4():"awp"===o.currentWeapon&&o.isScoped||"c4"!==o.currentWeapon&&(o.isFiring=!0,o.shoot())},{passive:!1}),document.addEventListener("touchmove",t=>{if(null!==s)for(let h=0;h<t.touches.length;h++)if(t.touches[h].identifier===s){const s=t.touches[h],c=s.clientX-i,a=s.clientY-e;(Math.abs(c)>3||Math.abs(a)>3)&&(n=!0);const r=.006*o.sensitivityMultiplier;o.yaw-=c*r,o.pitch-=a*r,o.pitch=Math.max(-Math.PI/2+.1,Math.min(Math.PI/2-.1,o.pitch)),!o.isSpectating&&o.camera&&(o.camera.rotation.order="YXZ",o.camera.rotation.y=o.yaw,o.camera.rotation.x=o.pitch),i=s.clientX,e=s.clientY;break}},{passive:!0}),document.addEventListener("touchend",t=>{if(null!==s)for(let i=0;i<t.changedTouches.length;i++)if(t.changedTouches[i].identifier===s){o.isPlanting&&o.cancelPlanting(),"awp"===o.currentWeapon&&o.isScoped&&o.shoot(),o.isFiring=!1,s=null,n=!1;break}}),document.addEventListener("touchcancel",t=>{null!==s&&(o.isPlanting&&o.cancelPlanting(),"awp"===o.currentWeapon&&o.isScoped&&o.shoot(),o.isFiring=!1,s=null,n=!1)})}const s=document.getElementById("mobile-reload");s&&s.addEventListener("touchstart",t=>{t.preventDefault(),t.stopPropagation(),this.reload()},{passive:!1});const i=document.getElementById("mobile-jump");i&&(i.addEventListener("touchstart",t=>{t.preventDefault(),t.stopPropagation(),this.keys.Space=!0},{passive:!1}),i.addEventListener("touchend",()=>{this.keys.Space=!1}));const e=document.getElementById("mobile-crouch");if(e){let t=null;e.addEventListener("touchstart",s=>{s.preventDefault(),s.stopPropagation(),t=s.changedTouches[0].identifier,this.camera?this.setCrouch(!0):this.isCrouching=!0},{passive:!1}),e.addEventListener("touchend",s=>{for(let i=0;i<s.changedTouches.length;i++)if(s.changedTouches[i].identifier===t){t=null,this.camera?this.setCrouch(!1):this.isCrouching=!1;break}}),e.addEventListener("touchcancel",()=>{t=null,this.camera?this.setCrouch(!1):this.isCrouching=!1})}const n=document.getElementById("mobile-switch");n&&n.addEventListener("touchstart",t=>{t.preventDefault(),t.stopPropagation(),this.switchToPrevious()},{passive:!1});const o=document.getElementById("mobile-buy");o&&o.addEventListener("touchstart",t=>{t.preventDefault(),t.stopPropagation(),this.toggleBuyMenu()},{passive:!1});const h=document.getElementById("mobile-settings");h&&h.addEventListener("touchstart",t=>{t.preventDefault(),t.stopPropagation(),this.toggleSettingsMenu()},{passive:!1});const c=document.getElementById("mobile-scoreboard");c&&c.addEventListener("touchstart",t=>{t.preventDefault(),t.stopPropagation(),this.toggleScoreboard()},{passive:!1});const a=document.getElementById("mobile-scope");a&&a.addEventListener("touchstart",t=>{t.preventDefault(),t.stopPropagation(),"awp"===this.currentWeapon&&this.toggleScope()},{passive:!1}),document.querySelectorAll(".weapon-slot").forEach(t=>{t.addEventListener("touchstart",s=>{s.preventDefault(),s.stopPropagation();const i=parseInt(t.dataset.slot);this.switchToSlot(i)},{passive:!1})});const r=document.getElementById("mobile-defuse");if(r){let t=null;const s=this;r.addEventListener("touchstart",i=>{i.preventDefault(),i.stopPropagation(),t=i.changedTouches[0].identifier,s.tryDefuse(),s.keys.KeyE=!0},{passive:!1}),r.addEventListener("touchend",i=>{for(let e=0;e<i.changedTouches.length;e++)if(i.changedTouches[e].identifier===t){t=null,s.keys.KeyE=!1,s.cancelDefuse();break}}),r.addEventListener("touchcancel",()=>{t=null,s.keys.KeyE=!1,s.cancelDefuse()})}}updateMobileDefuseButton(){if(!this.isMobile)return;const t=document.getElementById("mobile-defuse");t&&(this.isDefuseMode&&this.c4Planted&&"ct"===this.selectedTeam&&this.isNearC4()?t.style.display="block":t.style.display="none")}setupTouchLook(){const t=document.getElementById("game");if(!t)return;let s=0,i=0,e=!1,n=null;t.addEventListener("touchstart",t=>{for(let o=0;o<t.changedTouches.length;o++){const h=t.changedTouches[o];if(h.clientX>window.innerWidth/3&&!e){e=!0,n=h.identifier,s=h.clientX,i=h.clientY;break}}},{passive:!0}),t.addEventListener("touchmove",t=>{if(!e)return;let o=null;for(let s=0;s<t.touches.length;s++)if(t.touches[s].identifier===n){o=t.touches[s];break}if(!o)return;const h=o.clientX-s,c=o.clientY-i,a=.008*this.sensitivityMultiplier;this.yaw-=h*a,this.pitch-=c*a,this.pitch=Math.max(-Math.PI/2+.1,Math.min(Math.PI/2-.1,this.pitch)),this.isSpectating||(this.camera.rotation.order="YXZ",this.camera.rotation.y=this.yaw,this.camera.rotation.x=this.pitch),s=o.clientX,i=o.clientY},{passive:!0}),t.addEventListener("touchend",t=>{for(let s=0;s<t.changedTouches.length;s++)if(t.changedTouches[s].identifier===n){e=!1,n=null;break}})}initServerConfig(){const t=document.getElementById("serverUrl"),s=document.getElementById("saveServerBtn"),i=document.getElementById("currentServer");if(!t||!s)return;const e=localStorage.getItem("cs_server_url");e?(t.value=e,i.textContent="å½“å‰: "+e):i.textContent="å½“å‰: é»˜è®¤æœåŠ¡å™¨",s.addEventListener("click",()=>{const s=t.value.trim();if(s){if(!s.startsWith("ws://")&&!s.startsWith("wss://"))return void showPixelToast("æœåŠ¡å™¨åœ°å€å¿…é¡»ä»¥ ws:// æˆ– wss:// å¼€å¤´","warning");localStorage.setItem("cs_server_url",s),WS_SERVER_URL=s,i.textContent="å½“å‰: "+s,showPixelToast("æœåŠ¡å™¨åœ°å€å·²ä¿å­˜","success")}else localStorage.removeItem("cs_server_url"),WS_SERVER_URL=DEFAULT_WS_SERVER_URL,i.textContent="å½“å‰: é»˜è®¤æœåŠ¡å™¨",showPixelToast("å·²æ¢å¤é»˜è®¤æœåŠ¡å™¨","success")})}async loadAnnouncement(){if(document.getElementById("announcement-content"))try{console.log("æ­£åœ¨ä» /api/announcements è·å–å…¬å‘Š...");const t=await fetch("/api/announcements");if(console.log("å…¬å‘Š API å“åº”çŠ¶æ€:",t.status),t.ok){const s=await t.json();console.log("è·å–åˆ°çš„å…¬å‘Šæ•°æ®:",s),this.displayAnnouncement({announcements:s})}else console.warn("å…¬å‘Š API è¿”å›é”™è¯¯çŠ¶æ€:",t.status),this.displayDefaultAnnouncement()}catch(t){console.error("åŠ è½½å…¬å‘Šå¤±è´¥:",t),this.displayDefaultAnnouncement()}}displayAnnouncement(t){const s=document.getElementById("announcement-content");if(!s)return;let i="";t.announcements&&t.announcements.length>0?(t.announcements.forEach(t=>{i+=`<div class="announcement-item"><span class="announcement-date">${t.date||""}</span><p class="announcement-text">${t.content}</p></div>`}),s.innerHTML=i):this.displayDefaultAnnouncement()}displayDefaultAnnouncement(){const t=document.getElementById("announcement-content");t&&(t.innerHTML='\n            <div class="announcement-item"><span class="announcement-date">2025-12-28</span><p class="announcement-text">ğŸ‰ æ¬¢è¿æ¥åˆ° CS 1.6 åƒç´ ç‰ˆï¼</p></div>\n            <div class="announcement-item"><span class="announcement-date">2025-12-28</span><p class="announcement-text">ğŸ”« æ–°å¢æ­¦å™¨ï¼šAK47ã€M4A1ã€AWP</p></div>\n            <div class="announcement-item"><span class="announcement-date">2025-12-28</span><p class="announcement-text">ğŸ—ºï¸ å¤šå¼ ç»å…¸åœ°å›¾å¯é€‰</p></div>\n            <div class="announcement-item"><span class="announcement-date">2025-12-28</span><p class="announcement-text">âš¡ æ”¯æŒä¸‹è¹²è·³è·ƒæ“ä½œ</p></div>\n        ')}preloadMaps(){const t=document.createElement("div");t.id="preload-status",t.style.cssText="position:fixed;bottom:10px;left:10px;color:#0f0;font-size:12px;font-family:monospace;z-index:9999;",t.textContent="æ­£åœ¨é¢„åŠ è½½åœ°å›¾èµ„æº...",document.body.appendChild(t);const s=()=>{preloadAllMaps((s,i)=>{t.textContent=`é¢„åŠ è½½åœ°å›¾: ${i} (${s}%)`},()=>{t.textContent="âœ“ åœ°å›¾èµ„æºåŠ è½½å®Œæˆ",setTimeout(()=>t.remove(),2e3)})};window.requestIdleCallback?requestIdleCallback(s,{timeout:1e3}):setTimeout(s,100)}onKeyDown(t){if(this.isLocked&&((t.ctrlKey||"ControlLeft"===t.code||"ControlRight"===t.code)&&(t.preventDefault(),t.stopPropagation()),["KeyW","KeyA","KeyS","KeyD","Space","KeyR","KeyQ","KeyB","Tab"].includes(t.code)&&(t.preventDefault(),t.stopPropagation())),this.keys[t.code]=!0,"Tab"===t.code&&(t.preventDefault(),this.showScoreboard()),"KeyR"===t.code&&!this.isReloading&&"knife"!==this.currentWeapon&&"grenade"!==this.currentWeapon){const t=WeaponConfigs[this.currentWeapon];this.ammo<t.ammo&&this.reload()}"ControlLeft"!==t.code&&"ControlRight"!==t.code||(t.preventDefault(),this.setCrouch(!0)),this.buyMenuOpen||this.settingsMenuOpen||("Digit1"===t.code&&this.switchToSlot(1),"Digit2"===t.code&&this.switchToSlot(2),"Digit3"===t.code&&this.switchToSlot(3),"Digit4"===t.code&&this.switchToSlot(4),"Digit5"===t.code&&this.switchToC4()),"KeyQ"===t.code&&this.switchToPrevious(),"KeyB"===t.code&&this.toggleBuyMenu(),"Escape"===t.code&&this.toggleSettingsMenu(),"KeyE"===t.code&&this.isDefuseMode&&!t.repeat&&(this.hasC4&&"t"===this.selectedTeam&&"c4"===this.currentWeapon?this.startPlantingC4():this.c4Planted&&"ct"===this.selectedTeam&&this.tryDefuse()),this.buyMenuOpen&&("Digit1"===t.code&&(this.buyPrimaryWeapon("ak47"),t.preventDefault()),"Digit2"===t.code&&(this.buyPrimaryWeapon("m4a1"),t.preventDefault()),"Digit3"===t.code&&(this.buyPrimaryWeapon("awp"),t.preventDefault()))}switchToC4(){this.isDefuseMode&&this.hasC4&&(this.isReloading||this.isSwitchingWeapon||"c4"!==this.currentWeapon&&this.startWeaponSwitch("c4"))}onKeyUp(t){this.keys[t.code]=!1,"ControlLeft"!==t.code&&"ControlRight"!==t.code||this.setCrouch(!1),"Tab"===t.code&&this.hideScoreboard(),"KeyE"===t.code&&(this.isDefusing&&this.cancelDefuse(),this.isPlanting&&this.cancelPlanting())}onMouseDown(t){if(!this.buyMenuOpen&&this.isLocked){if(0===t.button){if(this.isSpectating)return void this.switchSpectatorTarget();if(this.isDefuseMode&&"c4"===this.currentWeapon&&this.hasC4&&!this.c4Planted&&this.isInBombSite())return void this.startPlantingC4();if("c4"!==this.currentWeapon){this.isFiring=!0;const t=WeaponConfigs[this.currentWeapon];t&&t.auto||this.shoot()}}if(2===t.button)if("knife"===this.currentWeapon){const t=Date.now();t-this.lastShot>=600&&(this.knifeAttack(!0),this.lastShot=t)}else this.toggleScope()}}onMouseUp(t){0===t.button&&(this.isFiring=!1,this.lastShotReleaseTime=Date.now(),this.isPlanting&&this.cancelPlanting())}onMouseMove(t){if(!this.isLocked||this.buyMenuOpen||this.settingsMenuOpen)return;const s=t.movementX||0,i=t.movementY||0;Math.abs(s)>200||Math.abs(i)>200||(this.pendingMouseX+=s,this.pendingMouseY+=i)}processMouseMovement(){if(0===this.pendingMouseX&&0===this.pendingMouseY)return;const t=this.baseSensitivity*this.sensitivityMultiplier;let s=t;1===this.scopeLevel?s=t*this.scopeSensitivityMultiplier:2===this.scopeLevel&&(s=t*this.scopeSensitivityMultiplier2),this.yaw-=this.pendingMouseX*s,this.pitch-=this.pendingMouseY*s,this.pitch=Math.max(-Math.PI/2+.1,Math.min(Math.PI/2-.1,this.pitch)),this.camera.rotation.order="YXZ",this.camera.rotation.y=this.yaw,this.camera.rotation.x=this.pitch,this.pendingMouseX=0,this.pendingMouseY=0}switchTab(t){this.isCreating=t,document.getElementById("tabJoin").classList.toggle("active",!t),document.getElementById("tabCreate").classList.toggle("active",t),document.getElementById("createOptions").style.display=t?"block":"none",document.getElementById("joinBtn").style.display=t?"none":"block",document.getElementById("createBtn").style.display=t?"block":"none";const s=document.getElementById("welcome-banner");s&&(s.style.display=t?"none":"block")}selectTeam(t){this.selectedTeam=t,document.getElementById("teamCT").classList.toggle("active","ct"===t),document.getElementById("teamT").classList.toggle("active","t"===t)}onGameModeChange(t){const s=document.getElementById("targetKillsGroup"),i=document.getElementById("mapSelectGroup"),e=document.getElementById("customMapGroup");document.getElementById("mapSelect"),updateMapSelect("custom"===t?"deathmatch":t),"defuse"===t?(s.style.display="none",i.style.display="block",e.style.display="none"):"custom"===t?(i.style.display="none",e.style.display="block",s.style.display="none"):(s.style.display="block",i.style.display="block",e.style.display="none")}initCustomMapImport(){const t=document.getElementById("customMapFile"),s=document.getElementById("importMapBtn"),i=document.getElementById("cloudMapBtn");if(!t||!s)return;s.addEventListener("click",()=>t.click()),t.addEventListener("change",s=>{const i=s.target.files[0];if(!i)return;const e=new FileReader;e.onload=s=>{try{const e=JSON.parse(s.target.result),n=this.validateCustomMap(e);if(!n.valid)return showPixelToast("åœ°å›¾æ–‡ä»¶æ ¼å¼é”™è¯¯: "+n.error,"error"),t.value="",void(document.getElementById("customMapName").textContent="æœªé€‰æ‹©åœ°å›¾");this.loadCustomMap(e),document.getElementById("customMapName").textContent="ğŸ“ "+(e.displayName||i.name)}catch(s){showPixelToast("åœ°å›¾æ–‡ä»¶è§£æå¤±è´¥: JSONæ ¼å¼é”™è¯¯","error"),t.value="",document.getElementById("customMapName").textContent="æœªé€‰æ‹©åœ°å›¾",console.error("åœ°å›¾åŠ è½½å¤±è´¥:",s)}},e.readAsText(i)}),i&&i.addEventListener("click",()=>this.showCloudMapModal());const e=document.getElementById("cloud-map-close"),n=document.getElementById("cloud-map-refresh");e&&e.addEventListener("click",()=>this.hideCloudMapModal()),n&&n.addEventListener("click",()=>this.loadCloudMapList())}showCloudMapModal(){const t=document.getElementById("cloud-map-modal");t&&(t.style.display="flex",this.loadCloudMapList())}hideCloudMapModal(){const t=document.getElementById("cloud-map-modal");t&&(t.style.display="none")}async loadCloudMapList(){const t=document.getElementById("cloud-map-loading"),s=document.getElementById("cloud-map-error"),i=document.getElementById("cloud-map-empty"),e=document.getElementById("cloud-map-list");if(t&&e){t.style.display="block",s.style.display="none",i.style.display="none",e.innerHTML="";try{const s=await MapCloudService.listMaps();if(t.style.display="none",0===s.length)return void(i.style.display="block");s.forEach(t=>{const s=document.createElement("div");s.className="cloud-map-item";const i=t.likes||0,n=t.thumbnail||"";s.innerHTML=`\n                    ${n?`<div class="cloud-map-thumb" data-thumb="${n}"><img src="${n}" alt=""></div>`:'<div class="cloud-map-thumb no-thumb">æ— é¢„è§ˆ</div>'}\n                    <div class="cloud-map-item-info">\n                        <div class="cloud-map-item-name">${this.escapeHtml(t.displayName||t.name)}</div>\n                        <div class="cloud-map-item-id">${this.escapeHtml(t.id)}</div>\n                    </div>\n                    <div class="cloud-map-item-actions">\n                        <button class="pixel-btn small cloud-like-btn ${this.hasLikedMap(t.id)?"liked":""}" data-id="${this.escapeHtml(t.id)}" ${this.hasLikedMap(t.id)?"disabled":""}>ğŸ‘ <span class="like-count">${i}</span></button>\n                        <button class="pixel-btn small primary cloud-select-btn">é€‰æ‹©</button>\n                    </div>\n                `;const o=s.querySelector(".cloud-map-thumb[data-thumb]");o&&(o.style.cursor="pointer",o.addEventListener("click",t=>{t.stopPropagation(),this.showThumbnailPreview(n)})),s.querySelector(".cloud-map-item-info").addEventListener("click",()=>this.selectCloudMap(t.id)),s.querySelector(".cloud-select-btn").addEventListener("click",()=>this.selectCloudMap(t.id)),s.querySelector(".cloud-like-btn").addEventListener("click",async s=>{s.stopPropagation();const i=s.currentTarget,e=t.id;if(!this.hasLikedMap(e)){i.disabled=!0;try{const t=await MapCloudService.likeMap(e);i.querySelector(".like-count").textContent=t.likes,this.markMapAsLiked(e),i.classList.add("liked")}catch(t){console.error("ç‚¹èµå¤±è´¥:",t),i.disabled=!1}}}),e.appendChild(s)})}catch(i){t.style.display="none",s.textContent=i.message,s.style.display="block"}}}async selectCloudMap(t){try{const s=await MapCloudService.getMap(t),i=this.validateCustomMap(s);if(!i.valid)return void showPixelToast("äº‘ç«¯åœ°å›¾æ ¼å¼é”™è¯¯: "+i.error,"error");this.loadCustomMap(s),document.getElementById("customMapName").textContent="â˜ï¸ "+(s.displayName||t),this.hideCloudMapModal()}catch(t){showPixelToast("åŠ è½½äº‘ç«¯åœ°å›¾å¤±è´¥: "+t.message,"error")}}escapeHtml(t){const s=document.createElement("div");return s.textContent=t||"",s.innerHTML}hasLikedMap(t){try{return JSON.parse(localStorage.getItem("likedMaps")||"[]").includes(t)}catch{return!1}}markMapAsLiked(t){try{const s=JSON.parse(localStorage.getItem("likedMaps")||"[]");s.includes(t)||(s.push(t),localStorage.setItem("likedMaps",JSON.stringify(s)))}catch{}}showThumbnailPreview(t){let s=document.getElementById("thumbnail-preview");s||(s=document.createElement("div"),s.id="thumbnail-preview",s.innerHTML='\n                <div class="thumb-preview-content">\n                    <img src="" alt="åœ°å›¾é¢„è§ˆ">\n                    <button class="thumb-preview-close">âœ•</button>\n                </div>\n            ',s.addEventListener("click",t=>{(t.target===s||t.target.classList.contains("thumb-preview-close"))&&s.classList.remove("active")}),document.body.appendChild(s)),s.querySelector("img").src=t,s.classList.add("active")}validateCustomMap(t){if(!t||"object"!=typeof t)return{valid:!1,error:"æ— æ•ˆçš„åœ°å›¾æ•°æ®"};if(!t.name||"string"!=typeof t.name||""===t.name.trim())return{valid:!1,error:"ç¼ºå°‘åœ°å›¾åç§°(name)"};if(void 0!==t.mapSize&&("number"!=typeof t.mapSize||t.mapSize<50||t.mapSize>1e3))return{valid:!1,error:"åœ°å›¾å¤§å°(mapSize)å¿…é¡»åœ¨50-1000ä¹‹é—´"};if(void 0!==t.gameMode){if(!Array.isArray(t.gameMode))return{valid:!1,error:"æ¸¸æˆæ¨¡å¼(gameMode)å¿…é¡»æ˜¯æ•°ç»„"};const s=["deathmatch","defuse"];for(const i of t.gameMode)if(!s.includes(i))return{valid:!1,error:"æ— æ•ˆçš„æ¸¸æˆæ¨¡å¼: "+i}}if(void 0!==t.objects){if(!Array.isArray(t.objects))return{valid:!1,error:"ç‰©ä½“åˆ—è¡¨(objects)å¿…é¡»æ˜¯æ•°ç»„"};for(let s=0;s<t.objects.length;s++){const i=t.objects[s];if(!i||"object"!=typeof i)return{valid:!1,error:`ç‰©ä½“[${s}]æ ¼å¼æ— æ•ˆ`};if("number"!=typeof i.x||"number"!=typeof i.z)return{valid:!1,error:`ç‰©ä½“[${s}]ç¼ºå°‘æœ‰æ•ˆåæ ‡(x,z)`}}}if(t.gameMode&&t.gameMode.includes("defuse")){if(!t.bombSites||"object"!=typeof t.bombSites)return{valid:!1,error:"çˆ†ç ´æ¨¡å¼éœ€è¦åŒ…ç‚¹é…ç½®(bombSites)"};if(!t.spawnPoints||"object"!=typeof t.spawnPoints)return{valid:!1,error:"çˆ†ç ´æ¨¡å¼éœ€è¦å‡ºç”Ÿç‚¹é…ç½®(spawnPoints)"}}return{valid:!0}}loadCustomMap(t){this.customMapData=t;const s=document.getElementById("targetKillsGroup"),i=t.gameMode||["deathmatch"];i.includes("defuse")?(this.selectedGameMode="defuse",s.style.display="none"):(this.selectedGameMode="deathmatch",s.style.display="block");const e=t.name||"custom_imported";let n=7058393;void 0!==t.skyColor&&(n="string"==typeof t.skyColor?parseInt(t.skyColor.replace("0x",""),16)||7058393:t.skyColor),MapConfigs[e]={displayName:t.displayName||"è‡ªå®šä¹‰åœ°å›¾",gameMode:i,floorColor1:t.floorColor1||"#c4a574",floorColor2:t.floorColor2||"#a68b5b",wallColor1:t.wallColor1||"#95a5a6",wallColor2:t.wallColor2||"#7f8c8d",skyColor:n,mapSize:t.mapSize||300,obstacles:this.convertObjectsToObstacles(t.objects||[]),bombSites:t.bombSites||{},spawnPoints:t.spawnPoints||{}},this.selectedMap=e,console.log("è‡ªå®šä¹‰åœ°å›¾å·²åŠ è½½:",e,MapConfigs[e])}convertObjectsToObstacles(t){const s=[];return t.forEach(t=>{"floor"!==t.type&&"bombsite_a"!==t.type&&"bombsite_b"!==t.type&&"spawn_ct"!==t.type&&"spawn_t"!==t.type&&s.push({x:t.x,y:t.y,z:t.z,w:t.w,h:t.h,d:t.d,color:t.color,rotation:t.rotation,textureType:t.textureType,type:t.type})}),s}toggleBuyMenu(){this.settingsMenuOpen||(this.buyMenuOpen=!this.buyMenuOpen,document.getElementById("buy-menu").style.display=this.buyMenuOpen?"flex":"none",this.buyMenuOpen?document.exitPointerLock():document.body.requestPointerLock())}showScoreboard(){const t=document.getElementById("scoreboard-panel");t&&(t.classList.add("visible"),this.updateScoreboard())}hideScoreboard(){const t=document.getElementById("scoreboard-panel");t&&t.classList.remove("visible")}updateScoreboard(){const t=document.getElementById("scoreboard-ct-players"),s=document.getElementById("scoreboard-t-players"),i=document.getElementById("scoreboard-ct-score"),e=document.getElementById("scoreboard-t-score");if(!t||!s)return;this.isDefuseMode?(i.textContent=this.ctScore||0,e.textContent=this.tScore||0):(i.textContent=this.ctKills||0,e.textContent=this.tKills||0);const n=[],o=[];for(const[t,s]of Object.entries(this.players))"ct"===s.team?n.push({...s,id:t}):o.push({...s,id:t});n.sort((t,s)=>(s.kills||0)-(t.kills||0)),o.sort((t,s)=>(s.kills||0)-(t.kills||0)),t.innerHTML=n.map(t=>`\n            <div class="scoreboard-player ${t.is_alive?"":"dead"} ${t.id===this.playerId?"self":""}">\n                <span class="scoreboard-player-name">${t.name||"æœªçŸ¥"}</span>\n                <div class="scoreboard-player-stats">\n                    <span>${t.kills||0}</span>\n                    <span>${t.deaths||0}</span>\n                    <span>${t.is_alive?t.health:0}</span>\n                </div>\n            </div>\n        `).join(""),s.innerHTML=o.map(t=>`\n            <div class="scoreboard-player ${t.is_alive?"":"dead"} ${t.id===this.playerId?"self":""}">\n                <span class="scoreboard-player-name">${t.name||"æœªçŸ¥"}</span>\n                <div class="scoreboard-player-stats">\n                    <span>${t.kills||0}</span>\n                    <span>${t.deaths||0}</span>\n                    <span>${t.is_alive?t.health:0}</span>\n                </div>\n            </div>\n        `).join("")}toggleScoreboard(){const t=document.getElementById("scoreboard-panel");t&&(t.classList.contains("visible")?this.hideScoreboard():this.showScoreboard())}toggleSettingsMenu(){this.buyMenuOpen||(this.settingsMenuOpen=!this.settingsMenuOpen,document.getElementById("settings-menu").style.display=this.settingsMenuOpen?"block":"none",this.settingsMenuOpen?(document.exitPointerLock(),this.setupSettingsListeners()):document.body.requestPointerLock())}setupSettingsListeners(){const t=document.getElementById("sensitivity-slider"),s=document.getElementById("scope-sensitivity-slider"),i=document.getElementById("volume-slider"),e=document.getElementById("resumeGame"),n=document.getElementById("toggleFullscreen"),o=document.getElementById("exitGame");t&&!t.hasListener&&(t.hasListener=!0,t.value=5*this.sensitivityMultiplier,document.getElementById("sens-value").textContent=t.value,t.addEventListener("input",t=>{const s=parseFloat(t.target.value);this.sensitivityMultiplier=s/5,document.getElementById("sens-value").textContent=s})),s&&!s.hasListener&&(s.hasListener=!0,s.value=10*this.scopeSensitivityMultiplier,document.getElementById("scope-sens-value").textContent=s.value,s.addEventListener("input",t=>{const s=parseFloat(t.target.value);this.scopeSensitivityMultiplier=s/10,document.getElementById("scope-sens-value").textContent=s})),i&&!i.hasListener&&(i.hasListener=!0,i.value=100*this.masterVolume,document.getElementById("volume-value").textContent=i.value,i.addEventListener("input",t=>{const s=parseInt(t.target.value);this.masterVolume=s/100,this.audio.setVolume(this.masterVolume),document.getElementById("volume-value").textContent=s})),e&&!e.hasListener&&(e.hasListener=!0,e.addEventListener("click",()=>this.toggleSettingsMenu())),n&&!n.hasListener&&(n.hasListener=!0,n.addEventListener("click",()=>{document.fullscreenElement?(document.exitFullscreen(),n.textContent="è¿›å…¥å…¨å±"):(document.documentElement.requestFullscreen().catch(()=>{}),n.textContent="é€€å‡ºå…¨å±"),this.settingsMenuOpen=!1,document.getElementById("settings-menu").style.display="none",setTimeout(()=>document.body.requestPointerLock(),100)})),o&&!o.hasListener&&(o.hasListener=!0,o.addEventListener("click",()=>this.backToMenu()))}updateAmmoDisplay(){const t=WeaponConfigs[this.currentWeapon],s=t?t.name:"AK-47";"knife"===this.currentWeapon||"c4"===this.currentWeapon?document.getElementById("weapon").textContent=s:"grenade"===this.currentWeapon?document.getElementById("weapon").textContent=`${s} x${this.grenadeCount}`:document.getElementById("weapon").textContent=`${s} ${this.ammo}/${this.maxAmmo}`}updateTeamScores(){this.isDefuseMode?(document.getElementById("ct-score").textContent=`åæç²¾è‹±: ${this.ctScore}`,document.getElementById("t-score").textContent=`ææ€–åˆ†å­: ${this.tScore}`):(document.getElementById("ct-score").textContent=`åæç²¾è‹±: ${this.ctKills}`,document.getElementById("t-score").textContent=`ææ€–åˆ†å­: ${this.tKills}`)}updateHUD(t){document.getElementById("health").textContent=`HP: ${t.health}`,this.isReloading||this.updateAmmoDisplay(),document.getElementById("score").textContent=`K: ${t.kills} / D: ${t.deaths}`,t.is_alive||this.gameOver||(this.isDefuseMode?this.isSpectating||(this.getAliveTeammates().length>0?(document.getElementById("death-screen").style.display="none",document.getElementById("game").classList.remove("dead-effect"),document.getElementById("death-overlay").classList.remove("active"),this.startSpectating()):(document.getElementById("death-screen").style.display="block",document.getElementById("game").classList.add("dead-effect"),document.getElementById("death-overlay").classList.add("active"),document.getElementById("respawn-info").textContent="ç­‰å¾…ä¸‹å›åˆå¤æ´»")):(document.getElementById("death-screen").style.display="block",document.getElementById("game").classList.add("dead-effect"),document.getElementById("death-overlay").classList.add("active"),document.getElementById("respawn-info").innerHTML='<span id="respawn-countdown">3</span> ç§’åè‡ªåŠ¨å¤æ´»',this.startRespawnTimer()))}updateCrosshair(){document.getElementById("crosshair").style.transform="translate(-50%, -50%)"}addKillFeed(t,s="system"){const i=document.getElementById("killfeed"),e=document.createElement("div");for(e.className="kill-msg","kill"===s?e.classList.add("kill-event"):"headshot"===s?e.classList.add("headshot-event"):"bomb"===s?e.classList.add("bomb-event"):e.classList.add("system-event"),e.innerHTML=t,i.appendChild(e);i.children.length>6;)i.removeChild(i.firstChild);setTimeout(()=>e.remove(),3500)}formatKillMessage(t,s,i,e){const n="t"===t.team?"t-team":"",o="t"===s.team?"t-team":"";return`${i?'<span class="hs-icon">ğŸ’€</span>':""}<span class="killer-name ${n}">${t.name}</span><span class="weapon-text">å‡»æ€</span><span class="victim-name ${o}">${s.name}</span>`}checkCrosshairTarget(){if(!this.camera||this.isSpectating||this.buyMenuOpen||this.settingsMenuOpen)return void this.hideCrosshairTarget();const t=new THREE.Raycaster;t.setFromCamera(new THREE.Vector2(0,0),this.camera),t.far=500;let s=null,i=1/0;for(const e in this.playerMeshes){if(e===this.playerId)continue;const n=this.playerMeshes[e];if(!n||n.userData.isDead)continue;const o=t.intersectObject(n,!0);o.length>0&&o[0].distance<i&&(i=o[0].distance,s=this.players[e])}s&&i<200?this.showCrosshairTarget(s):this.hideCrosshairTarget()}showCrosshairTarget(t){const s=document.getElementById("crosshair-target");if(!s)return;const i=this.selectedTeam,e=t.team!==i;s.textContent=t.name,s.className="visible "+(e?"enemy":"friendly")}hideCrosshairTarget(){const t=document.getElementById("crosshair-target");t&&(t.className="")}showKillFeedback(t,s,i){const e=document.getElementById("kill-icon"),n=document.getElementById("kill-streak-icon");if(e.className="",n.className="",t?(e.className="headshot",e.textContent="HEADSHOT"):s?(e.className="knife",e.textContent="KNIFE KILL"):(e.className="kill",e.textContent="KILL"),i>=2){const t={2:"DOUBLE KILL",3:"TRIPLE KILL",4:"ULTRA KILL",5:"RAMPAGE",6:"GODLIKE",7:"UNSTOPPABLE",8:"LEGENDARY"};n.textContent=t[Math.min(i,8)],n.className="active",i>=6?n.classList.add("streak-6"):i>=5?n.classList.add("streak-5"):i>=4?n.classList.add("streak-4"):i>=3&&n.classList.add("streak-3")}setTimeout(()=>{e.className="",e.textContent=""},2e3),setTimeout(()=>{n.className="",n.textContent=""},2500)}playDeathAnimation(){if(!this.camera)return;const t=this.pitch,s=this.camera.position.y,i=Date.now(),e=document.createElement("div");e.style.cssText="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,0,0,0.5);pointer-events:none;z-index:999;",document.body.appendChild(e);let n=.5;const o=setInterval(()=>{n-=.05,n<=0?(clearInterval(o),e.remove()):e.style.background=`rgba(255,0,0,${n})`},50),h=()=>{const e=Date.now()-i,n=Math.min(e/800,1),o=1-Math.pow(1-n,3);if(this.pitch=t+Math.PI/3*o,this.camera.rotation.x=this.pitch,this.camera.position.y=s-(s-1.5)*o,n<.7){const t=Math.sin(20*n)*(1-n)*.05;this.camera.rotation.z=t}else this.camera.rotation.z=0;n<1?requestAnimationFrame(h):this.camera.rotation.z=.1};h()}resetDeathAnimation(){this.camera&&(this.camera.rotation.z=0,this.pitch=0,this.camera.rotation.x=0)}startRespawnTimer(){this.respawnTimer||(this.respawnCountdown=3,document.getElementById("respawn-countdown").textContent=this.respawnCountdown,this.respawnTimer=setInterval(()=>{this.respawnCountdown--,document.getElementById("respawn-countdown").textContent=this.respawnCountdown,this.respawnCountdown<=0&&(this.clearRespawnTimer(),this.respawn())},1e3))}clearRespawnTimer(){this.respawnTimer&&(clearInterval(this.respawnTimer),this.respawnTimer=null)}showGameOver(t,s,i,e="kills"){let n;this.gameOver=!0,this.clearRespawnTimer(),document.getElementById("death-screen").style.display="none",document.getElementById("game-over").style.display="block",n="draw"===t?"å¹³å±€!":"ct"===t?"åæç²¾è‹±è·èƒœ!":"ææ€–åˆ†å­è·èƒœ!";let o="";"time"===e?o=" (æ—¶é—´ç»“æŸ)":"match_won"===e&&(o=" (æ¯”èµ›èƒœåˆ©)"),document.getElementById("winner-text").textContent=n+o,this.isDefuseMode?document.getElementById("final-score").textContent=`æœ€ç»ˆæ¯”åˆ† - åæç²¾è‹±: ${s} å›åˆ | ææ€–åˆ†å­: ${i} å›åˆ`:document.getElementById("final-score").textContent=`æœ€ç»ˆæ¯”åˆ† - åæç²¾è‹±: ${s} | ææ€–åˆ†å­: ${i}`,document.exitPointerLock()}handleNewGame(t){document.getElementById("game-over").style.display="none",document.getElementById("death-screen").style.display="none",document.getElementById("game").classList.remove("dead-effect"),document.getElementById("death-overlay").classList.remove("active"),this.gameOver=!1,this.killStreak=0,this.ctKills=0,this.tKills=0,this.ctScore=0,this.tScore=0,t.state&&this.updateState(t.state),this.isDefuseMode&&t.c4_carrier&&(this.hasC4=t.c4_carrier===this.playerId,this.c4Planted=!1,this.updateDefuseHUD(),this.updateC4SlotVisibility());const s=this.players[this.playerId];s&&(this.camera.position.set(s.x,this.standingHeight,s.y),this.ammo=this.maxAmmo,this.grenadeCount=1,this.updateAmmoDisplay()),this.isMobile||document.body.requestPointerLock(),this.addKillFeed("ğŸ“¢ æ–°æ¸¸æˆå¼€å§‹ï¼","system")}updateGunModel(){this.camera&&(this.gunModel&&this.camera.remove(this.gunModel),this.weaponBuilder=new WeaponModelBuilder(this.selectedTeam),this.gunModel=this.weaponBuilder.createModel(this.currentWeapon),this.gunBasePosition=this.gunModel.position.clone(),this.gunBaseRotation=this.gunModel.rotation.clone(),this.camera.add(this.gunModel),this.gunRecoil=0)}createGunModel(){this.weaponBuilder=new WeaponModelBuilder(this.selectedTeam),this.gunModel=this.weaponBuilder.createModel("ak47"),this.gunBasePosition=this.gunModel.position.clone(),this.gunBaseRotation=this.gunModel.rotation.clone(),this.camera.add(this.gunModel),this.scene.add(this.camera),this.isSwitchingWeapon=!1,this.isReloading=!1,this.switchAnimProgress=0,this.reloadAnimProgress=0,this.gunRecoil=0}buyPrimaryWeapon(t){this.primaryWeapon=t,this.switchToSlot(1),this.buyMenuOpen&&this.toggleBuyMenu()}switchToSlot(t){if(this.isReloading||this.isSwitchingWeapon)return;let s;switch(t){case 1:s=this.primaryWeapon;break;case 2:s=this.secondaryWeapon;break;case 3:s="knife";break;case 4:s="grenade";break;case 5:if(!this.isDefuseMode||!this.hasC4)return;s="c4";break;default:return}s!==this.currentWeapon&&("grenade"===s&&this.grenadeCount<=0||this.startWeaponSwitch(s))}switchToPrevious(){if(this.isReloading||this.isSwitchingWeapon)return;const t=t=>"ak47"===t||"m4a1"===t||"awp"===t;let s;s=t(this.currentWeapon)?this.secondaryWeapon:"pistol"===this.currentWeapon?this.primaryWeapon:"knife"===this.currentWeapon?t(this.previousWeapon)?this.previousWeapon:this.primaryWeapon:"grenade"!==this.currentWeapon&&"c4"!==this.currentWeapon||!t(this.previousWeapon)?this.primaryWeapon:this.previousWeapon,s!==this.currentWeapon&&this.startWeaponSwitch(s)}startWeaponSwitch(t){this.isScoped&&this.closeScope(),this.previousWeapon=this.currentWeapon,this.isSwitchingWeapon=!0,this.switchAnimProgress=0,this.audio.playWeaponSwitchSound();const s=this;setTimeout(function(){s.currentWeapon=t;const i=WeaponConfigs[t];i&&(s.maxAmmo=i.ammo,s.ammo=i.ammo,s.fireRate=i.fireRate,s.weaponRecoil=i.recoil),s.shotsFired=0,s.recoilAccumulator=0,s.updateGunModel(),s.updateAmmoDisplay(),setTimeout(function(){s.isSwitchingWeapon=!1,s.switchAnimProgress=0},200)},300),this.ws&&this.ws.readyState===WebSocket.OPEN&&this.ws.send(JSON.stringify({action:"switch_weapon",weapon:t}))}reload(){"knife"!==this.currentWeapon&&"grenade"!==this.currentWeapon&&"c4"!==this.currentWeapon&&(this.isReloading=!0,this.reloadAnimProgress=0,this.audio.playReloadSound(this.currentWeapon),document.getElementById("weapon").textContent="æ¢å¼¹ä¸­...",setTimeout(()=>{this.ammo=this.maxAmmo,this.isReloading=!1,this.reloadAnimProgress=0,this.updateAmmoDisplay()},1800))}toggleScope(){"awp"===this.currentWeapon&&(this.scopeLevel=(this.scopeLevel+1)%3,this.isScoped=this.scopeLevel>0,document.getElementById("scope").style.display=this.isScoped?"block":"none",document.getElementById("crosshair").style.display=this.isScoped?"none":"block",this.camera&&(0===this.scopeLevel?this.camera.fov=this.normalFOV:1===this.scopeLevel?this.camera.fov=this.scopedFOV1:this.camera.fov=this.scopedFOV2,this.camera.updateProjectionMatrix()),this.gunModel&&(this.gunModel.visible=!this.isScoped))}closeScope(){this.isScoped&&(this.isScoped=!1,this.scopeLevel=0,document.getElementById("scope").style.display="none",document.getElementById("crosshair").style.display="block",this.camera&&(this.camera.fov=this.normalFOV,this.camera.updateProjectionMatrix()),this.gunModel&&(this.gunModel.visible=!0))}setCrouch(t){if(this.isCrouching===t)return;if(!t&&this.camera&&!this.canStandAt(this.camera.position.x,this.camera.position.z))return;this.isCrouching=t;const s=t?this.crouchingHeight:this.standingHeight;this.targetCameraHeight=s+(this.currentStandingHeight||0),this.ws&&this.ws.readyState===WebSocket.OPEN&&this.ws.send(JSON.stringify({action:"crouch",crouching:t}))}shoot(){if(this.isReloading||this.isSwitchingWeapon||this.gameOver||this.buyMenuOpen)return;if(!this.isLocked)return;const t=Date.now();if(t-this.lastShot<this.fireRate)return;if("knife"===this.currentWeapon)return this.knifeAttack(),void(this.lastShot=t);if("grenade"===this.currentWeapon)return this.throwGrenade(),void(this.lastShot=t);if("c4"===this.currentWeapon)return;if(this.ammo<=0)return void this.reload();this.lastShot=t,this.ammo--,this.shotsFired++,this.audio.playGunSound(this.currentWeapon);const s=WeaponConfigs[this.currentWeapon];let i=0;if(this.shotsFired>2){const t=Math.min(this.shotsFired-2,8),e=s.recoil+t*s.recoilIncrease;i=Math.min(e,s.maxRecoil)}this.recoilAccumulator+=i,this.crosshairOffset=Math.min(1.5*this.recoilAccumulator,.6),this.gunRecoil=.5+2*s.recoil,this.screenShake=.02+.1*s.recoil;const e=.008*s.recoil*(1+Math.min(.1*this.shotsFired,.5)),n=(Math.random()-.5)*s.recoil*.02;this.pitch+=e,this.yaw+=n,this.pitch=Math.max(-Math.PI/2+.1,Math.min(Math.PI/2-.1,this.pitch)),this.camera.rotation.order="YXZ",this.camera.rotation.x=this.pitch,this.camera.rotation.y=this.yaw;const o=this.isScoped;"awp"===this.currentWeapon&&this.isScoped&&this.closeScope(),this.raycastShoot(o),this.updateAmmoDisplay(),this.ws&&this.ws.readyState===WebSocket.OPEN&&this.ws.send(JSON.stringify({action:"shoot",pitch:this.pitch}))}knifeAttack(t=!1){this.audio.playKnifeSound(),this.gunRecoil=0,this.isKnifeAttacking=!0,this.knifeAttackType=t?"heavy":"light",this.knifeAttackStartTime=Date.now(),this.knifeAttackDuration=t?450:300,this.ws&&this.ws.readyState===WebSocket.OPEN&&this.ws.send(JSON.stringify({action:"knife_attack",is_heavy:t}));const s=new THREE.Raycaster;s.setFromCamera(new THREE.Vector2(0,0),this.camera),s.far=t?10:9,setTimeout(()=>{for(const[i,e]of Object.entries(this.playerMeshes)){if(i===this.playerId)continue;const n=[];e.traverse(t=>{t.isMesh&&n.push(t)});const o=s.intersectObjects(n);if(o.length>0){const s=o[0].point;if(this.createHitMarker(s),this.createBloodEffect(s),this.audio.playHitSound(),this.ws&&this.ws.readyState===WebSocket.OPEN){const e=this.playerMeshes[i],n=e?e.position.y:0,o=s.y-n;this.ws.send(JSON.stringify({action:"hit_player",target_id:i,hit_height:o,is_heavy_attack:t}))}break}}},t?120:80)}updateKnifeAnimation(){if(!this.isKnifeAttacking||!this.gunModel||!this.gunBasePosition)return;const t=Date.now()-this.knifeAttackStartTime,s=Math.min(t/this.knifeAttackDuration,1);if(this.gunModel.position.copy(this.gunBasePosition),this.gunModel.rotation.copy(this.gunBaseRotation),"heavy"===this.knifeAttackType)if(s<.15){const t=s/.15;this.gunModel.position.z+=.15*t,this.gunModel.position.y+=.05*t,this.gunModel.rotation.x=.4*t}else if(s<.35){const t=(s-.15)/.2;this.gunModel.position.z=.15-.8*t,this.gunModel.position.y=.05-.1*t,this.gunModel.rotation.x=.4-1.8*t,this.gunModel.rotation.z=2*t}else if(s<.55){const t=(s-.35)/.2;this.gunModel.position.z=-.65-.15*t,this.gunModel.position.y=-.05-.05*t,this.gunModel.rotation.x=-1.4,this.gunModel.rotation.z=2+1.5*t,this.gunModel.traverse(s=>{s.isMesh&&s.material&&(s.material.opacity=1-.3*t,s.material.transparent=!0)})}else if(s<.75){const t=(s-.55)/.2;this.gunModel.position.z=.6*t-.8,this.gunModel.position.y=.08*t-.1,this.gunModel.rotation.x=1.2*t-1.4,this.gunModel.rotation.z=3.5-2.5*t,this.gunModel.traverse(s=>{s.isMesh&&s.material&&(s.material.opacity=.7+.3*t,s.material.transparent=!0)})}else{const t=(s-.75)/.25;this.gunModel.position.z=.2*t-.2,this.gunModel.position.y=.02*t-.02,this.gunModel.rotation.x=.2*t-.2,this.gunModel.rotation.z=1-1*t,this.gunModel.traverse(t=>{t.isMesh&&t.material&&(t.material.opacity=1,t.material.transparent=!1)})}else if(s<.15){const t=s/.15;this.gunModel.position.z+=.08*t,this.gunModel.rotation.x=.3*t}else if(s<.4){const t=(s-.15)/.25;this.gunModel.position.z=.08-.4*t,this.gunModel.rotation.x=.3-.8*t}else{const t=(s-.4)/.6;this.gunModel.position.z=.32*t-.32,this.gunModel.rotation.x=.5*t-.5}s>=1&&(this.isKnifeAttacking=!1)}throwGrenade(){if(this.grenadeCount<=0)return;this.grenadeCount--,this.audio.playGrenadeThrowSound(),this.gunRecoil=.5;const t=new THREE.Vector3;this.camera.getWorldDirection(t);const s=this.camera.position.clone();this.ws&&this.ws.readyState===WebSocket.OPEN&&this.ws.send(JSON.stringify({action:"throw_grenade",start:{x:s.x,y:s.y,z:s.z},direction:{x:t.x,y:t.y,z:t.z}})),this.createLocalGrenade(s,t),this.updateAmmoDisplay(),this.grenadeCount,this.switchToSlot(1)}createLocalGrenade(t,s,i=!1){const e=new THREE.SphereGeometry(.3,8,8),n=new THREE.MeshLambertMaterial({color:2968109}),o=new THREE.Mesh(e,n);o.position.copy(t),this.scene.add(o);let h=new THREE.Vector3(s.x,s.y,s.z).normalize().multiplyScalar(85);h.y+=15;const c=.7;let a=0,r=performance.now();const l=this.walls,d=.5;i&&this.audio.playGrenadeThrowSound();const u=()=>{const t=performance.now(),s=Math.min((t-r)/1e3,.05);r=t,h.y-=55*s;const e=o.position.clone(),n=e.clone().add(h.clone().multiplyScalar(s));((t,s,i)=>{let e=!1;for(const n of l){const o=n.h||20,h=n.hBottom||0;if(!(t.y>o+d||t.y<h-d))if(n.rotation&&0!==n.rotation){const t=n.centerX||n.x+n.w/2,o=n.centerZ||n.z+n.d/2,h=(n.originalW||n.w)/2,a=(n.originalD||n.d)/2,r=n.rotation,l=Math.cos(-r),u=Math.sin(-r),m=s.x-t,p=s.z-o,f=m*l-p*u,b=m*u+p*l;if(Math.abs(f)<=h+d&&Math.abs(b)<=a+d){const n=f+h+d,l=h+d-f,u=b+a+d,m=a+d-b,p=Math.min(n,l,u,m);let w=0,v=0;p===n?(w=-1,s.x=t+(-h-d-.01)*Math.cos(r),s.z=o+(-h-d-.01)*Math.sin(r)):p===l?(w=1,s.x=t+(h+d+.01)*Math.cos(r),s.z=o+(h+d+.01)*Math.sin(r)):v=p===u?-1:1;const M=Math.cos(r),k=Math.sin(r),E=w*M-v*k,g=w*k+v*M,y=i.x*E+i.z*g;y<0&&(i.x-=2*y*E*.5,i.z-=2*y*g*.5,i.x*=c,i.z*=c),e=!0;break}}else{const t=n.x,h=n.z,a=n.w,r=n.d,l=t-d,u=t+a+d,m=h-d,p=h+r+d;if(s.x>=l&&s.x<=u&&s.z>=m&&s.z<=p&&s.y<=o+d){const t=s.x-l,n=u-s.x,o=s.z-m,h=p-s.z,a=Math.min(t,n,o,h);a===t||a===n?(i.x*=-.5,s.x=a===t?l-.01:u+.01):(i.z*=-.5,s.z=a===o?m-.01:p+.01),i.x*=c,i.z*=c,e=!0;break}}}})(e,n,h),o.position.copy(n),o.position.y<.5&&(o.position.y=.5,h.y*=-.5,h.x*=c,h.z*=c,a++);const m=MapConfigs[this.selectedMap],p=(m&&m.mapSize||125)-5;Math.abs(o.position.x)>p&&(h.x*=-.5,o.position.x=Math.sign(o.position.x)*p),Math.abs(o.position.z)>p&&(h.z*=-.5,o.position.z=Math.sign(o.position.z)*p),a<5&&h.length()>1?requestAnimationFrame(u):setTimeout(()=>{this.createExplosion(o.position,i),this.scene.remove(o)},500)};u()}createExplosion(t,s=!1){this.audio.playExplosionSound();const i=new THREE.SphereGeometry(2,16,16),e=new THREE.MeshBasicMaterial({color:16737792,transparent:!0,opacity:.9}),n=new THREE.Mesh(i,e);n.position.copy(t),this.scene.add(n);const o=new THREE.SphereGeometry(1.5,12,12),h=new THREE.MeshBasicMaterial({color:16777164,transparent:!0,opacity:1}),c=new THREE.Mesh(o,h);c.position.copy(t),this.scene.add(c);const a=new THREE.TorusGeometry(3,1,8,16),r=new THREE.MeshBasicMaterial({color:4473924,transparent:!0,opacity:.6}),l=new THREE.Mesh(a,r);l.position.copy(t),l.rotation.x=Math.PI/2,this.scene.add(l);const d=[];for(let s=0;s<20;s++){const s=new THREE.BoxGeometry(.3,.3,.3),i=Math.random()>.5?16729088:16755200,e=new THREE.MeshBasicMaterial({color:i,transparent:!0,opacity:1}),n=new THREE.Mesh(s,e);n.position.copy(t),n.velocity=new THREE.Vector3(2*(Math.random()-.5),1.5*Math.random()+.5,2*(Math.random()-.5)),this.scene.add(n),d.push({mesh:n,mat:e,vel:n.velocity})}const u=this.camera.position.clone(),m=this.camera.position.distanceTo(t),p=.5*Math.max(0,1-m/30);let f=0,b=1,w=1;const v=()=>{f++,b+=.4,n.scale.set(b,b,b),e.opacity-=.08,h.opacity-=.15,c.scale.set(.8*b,.8*b,.8*b),w+=.3,l.scale.set(w,w,w),l.position.y+=.2,r.opacity-=.04,d.forEach(t=>{t.mesh.position.add(t.vel),t.vel.y-=.08,t.mat.opacity-=.05}),f<10&&p>0&&(this.camera.position.x=u.x+(Math.random()-.5)*p,this.camera.position.y=u.y+(Math.random()-.5)*p),e.opacity>0?requestAnimationFrame(v):(this.scene.remove(n),this.scene.remove(c),this.scene.remove(l),d.forEach(t=>this.scene.remove(t.mesh)))};if(v(),!s)for(const[s,i]of Object.entries(this.playerMeshes)){if(s===this.playerId)continue;const e=i.position.distanceTo(t);e<20&&this.ws&&this.ws.readyState===WebSocket.OPEN&&this.ws.send(JSON.stringify({action:"grenade_hit",target_id:s,distance:e}))}}raycastShoot(t=!1){const s=new THREE.Raycaster,i=WeaponConfigs[this.currentWeapon];let e=0,n=0;if("awp"!==this.currentWeapon||t){if(this.shotsFired>2)if(this.shotsFired>=10){const t=(i.spread||.02)+.08;e=(Math.random()-.5)*t,n=(Math.random()-.5)*t*.8+.04}else{const t=Math.min((this.shotsFired-2)/8,1),s=(i.spread||.02)*t+.03*this.recoilAccumulator*t;e=(Math.random()-.5)*s,n=Math.random()*s*.8+.012*this.recoilAccumulator}}else{const t=.15;e=(Math.random()-.5)*t,n=(Math.random()-.5)*t}const o=this.camera.position.clone(),h=new THREE.Vector3;if(this.camera.getWorldDirection(h),0!==e||0!==n){const t=new THREE.Vector3,s=new THREE.Vector3;this.camera.getWorldDirection(h),t.crossVectors(h,this.camera.up).normalize(),s.crossVectors(t,h).normalize(),h.add(t.multiplyScalar(e)),h.add(s.multiplyScalar(n)),h.normalize()}s.set(o,h);let c=o.clone().add(h.clone().multiplyScalar(100)),a=1/0,r=null,l=null,d=!1;if(h.y<0){const t=new THREE.Plane(new THREE.Vector3(0,1,0),0),i=new THREE.Vector3;if(s.ray.intersectPlane(t,i)&&i.clone().sub(o).dot(h)>0){const t=i.distanceTo(o);t<a&&t<100&&t>.5&&(a=t,c=i.clone(),d=!0)}}const u=this.walls.map(t=>t.mesh),m=s.intersectObjects(u);if(m.length>0&&m[0].distance<a){a=m[0].distance,c=m[0].point.clone(),d=!1;const t=m[0].face?m[0].face.normal.clone():null;t&&t.transformDirection(m[0].object.matrixWorld),this.createBulletHole(m[0].point,t,!1)}else d&&this.createFloorBulletHole(c);for(const[t,i]of Object.entries(this.playerMeshes)){if(t===this.playerId)continue;const e=[];i.traverse(t=>{t.isMesh&&e.push(t)});const n=s.intersectObjects(e);n.length>0&&n[0].distance<a&&(r=t,l=n[0].point.clone(),c=l)}if(r&&l&&(this.createHitMarker(l),this.createBloodEffect(l),this.audio.playHitSound(),this.ws&&this.ws.readyState===WebSocket.OPEN)){const t=this.playerMeshes[r],s=t?t.position.y:0,i=l.y-s;this.ws.send(JSON.stringify({action:"hit_player",target_id:r,hit_height:i}))}}createHitMarker(t=null){const s=document.createElement("div");if(s.className="hit-marker",s.innerHTML="Ã—",t&&this.camera){const i=t.clone().project(this.camera),e=document.getElementById("game").getBoundingClientRect(),n=(.5*i.x+.5)*e.width,o=(.5*-i.y+.5)*e.height;n>=0&&n<=e.width&&o>=0&&o<=e.height&&i.z<1&&(s.style.left=`${n}px`,s.style.top=`${o}px`,s.style.transform="translate(-50%, -50%)")}document.getElementById("game").appendChild(s),setTimeout(()=>s.remove(),200)}createBulletHole(t,s=null,i=!1){const e=document.createElement("canvas");e.width=64,e.height=64;const n=e.getContext("2d");n.clearRect(0,0,64,64);const o=n.createRadialGradient(32,32,0,32,32,28);o.addColorStop(0,"rgba(0, 0, 0, 1)"),o.addColorStop(.2,"rgba(15, 12, 10, 0.95)"),o.addColorStop(.4,"rgba(35, 30, 25, 0.85)"),o.addColorStop(.6,"rgba(50, 45, 40, 0.6)"),o.addColorStop(.8,"rgba(70, 60, 50, 0.3)"),o.addColorStop(1,"rgba(90, 80, 70, 0)"),n.fillStyle=o,n.beginPath(),n.arc(32,32,28,0,2*Math.PI),n.fill();const h=n.createRadialGradient(32,32,0,32,32,12);h.addColorStop(0,"rgba(0, 0, 0, 1)"),h.addColorStop(.6,"rgba(5, 5, 5, 1)"),h.addColorStop(1,"rgba(20, 18, 15, 0.9)"),n.fillStyle=h,n.beginPath(),n.arc(32,32,12,0,2*Math.PI),n.fill(),n.strokeStyle="rgba(20, 18, 15, 0.7)",n.lineWidth=2;for(let t=0;t<6;t++){const s=2*Math.PI/6*t+.4*Math.random(),i=14+8*Math.random();n.beginPath(),n.moveTo(32+10*Math.cos(s),32+10*Math.sin(s)),n.lineTo(32+Math.cos(s)*i,32+Math.sin(s)*i),n.stroke()}const c=new THREE.CanvasTexture(e);c.minFilter=THREE.LinearFilter,c.magFilter=THREE.LinearFilter;const a=new THREE.MeshBasicMaterial({map:c,transparent:!0,opacity:1,side:THREE.DoubleSide,depthWrite:!1,polygonOffset:!0,polygonOffsetFactor:-1,polygonOffsetUnits:-1}),r=new THREE.Mesh(new THREE.CircleGeometry(.5,16),a);r.userData.isBulletHole=!0,r.renderOrder=1,i?(r.position.copy(t),r.rotation.x=-Math.PI/2,r.position.y=.03):s?(r.position.copy(t).add(s.clone().multiplyScalar(.1)),r.lookAt(r.position.clone().add(s))):(r.position.copy(t),r.lookAt(this.camera.position)),this.scene.add(r),setTimeout(()=>{const t=()=>{r.material.opacity-=.02,r.material.opacity>0?requestAnimationFrame(t):this.scene.remove(r)};t()},8e3)}createFloorBulletHole(t){this.createBulletHole(t,null,!0)}createRemoteBulletHole(t,s,i=0){if(!t||!this.scene)return;const e=t.crouching?6:10,n=new THREE.Vector3(t.x,e,t.y),o=-s+Math.PI/2,h=new THREE.Vector3(-Math.sin(o)*Math.cos(i),-Math.sin(i),-Math.cos(o)*Math.cos(i)).normalize(),c=new THREE.Raycaster(n,h,.1,150);let a=1/0,r=!1,l=n.clone().add(h.clone().multiplyScalar(100));if(h.y<0){const t=new THREE.Plane(new THREE.Vector3(0,1,0),0),s=new THREE.Vector3;if(c.ray.intersectPlane(t,s)&&s.clone().sub(n).dot(h)>0){const t=s.distanceTo(n);t<a&&t<100&&t>.5&&(a=t,l=s.clone(),r=!0)}}const d=this.walls.map(t=>t.mesh),u=c.intersectObjects(d);if(u.length>0&&u[0].distance<a){a=u[0].distance,l=u[0].point.clone(),r=!1;const t=u[0].face?u[0].face.normal.clone():null;return t&&t.transformDirection(u[0].object.matrixWorld),void this.createBulletHole(u[0].point,t,!1)}r&&this.createFloorBulletHole(l)}playRemoteKnifeAnimation(t,s){const i=this.playerMeshes[t];if(!i||!i.userData.weaponModel)return;const e=i.userData.weaponModel,n=s?450:300,o=Date.now(),h=this.players[t];if(h){const t=h.x-this.camera.position.x,s=h.y-this.camera.position.z,i=Math.sqrt(t*t+s*s),e=25;if(i>e)return;const n=i/e,o=.5*Math.max(0,1-n*n);o>.02&&this.audio.playKnifeSound(o)}const c=e.position.clone(),a=e.rotation.clone(),r=()=>{const t=Date.now()-o,i=Math.min(t/n,1);if(e.position.copy(c),e.rotation.copy(a),s)if(i<.3){const t=i/.3;e.rotation.x=-.8*t,e.position.z-=1.5*t}else if(i<.6){const t=(i-.3)/.3;e.rotation.x=1.6*t-.8,e.position.z=c.z-1.5+3*t}else{const t=(i-.6)/.4;e.rotation.x=.8-.8*t,e.position.z=c.z+1.5-1.5*t}else if(i<.4){const t=i/.4;e.position.z-=2*t,e.rotation.x=-.3*t}else{const t=(i-.4)/.6;e.position.z=c.z-2+2*t,e.rotation.x=.3*t-.3}i<1?requestAnimationFrame(r):(e.position.copy(c),e.rotation.copy(a))};r()}createBloodEffect(t){for(let s=0;s<5;s++){const s=new THREE.Mesh(new THREE.BoxGeometry(.3,.3,.3),new THREE.MeshBasicMaterial({color:13369344}));s.position.copy(t),s.position.x+=2*(Math.random()-.5),s.position.y+=2*Math.random(),s.position.z+=2*(Math.random()-.5),this.scene.add(s),setTimeout(()=>this.scene.remove(s),300)}}createBulletTracer(t,s){const i=t.distanceTo(s),e=new THREE.SphereGeometry(.06,4,4),n=new THREE.MeshBasicMaterial({color:16776960,transparent:!0,opacity:1}),o=new THREE.Mesh(e,n);o.position.copy(t),this.scene.add(o);let h=performance.now(),c=0;const a=()=>{const e=performance.now(),r=(e-h)/1e3;h=e,c+=800*r,c>=i?this.scene.remove(o):(o.position.lerpVectors(t,s,c/i),n.opacity=1-c/i*.5,requestAnimationFrame(a))};a()}validateInput(t,s){return t.length<2||t.length>8?(this.showMenuError("ç©å®¶åç§°å¿…é¡»åœ¨2-8ä¸ªå­—ç¬¦ä¹‹é—´"),!1):8!==s.length?(this.showMenuError("æˆ¿é—´å·å¿…é¡»æ˜¯8ä¸ªå­—ç¬¦"),!1):!!/^[a-zA-Z0-9]+$/.test(s)||(this.showMenuError("æˆ¿é—´å·åªèƒ½åŒ…å«å­—æ¯å’Œæ•°å­—"),!1)}joinGame(){const t=document.getElementById("playerName").value.trim(),s=document.getElementById("roomId").value.trim();this.validateInput(t,s)&&this.checkRoomInfo(s).then(async i=>{if(i.exists){if(this.selectedMap=i.map||"dust2",this.selectedGameMode=i.game_mode||"deathmatch",this.targetKills=i.target_kills||20,i.has_custom_map&&i.cloud_map_id){console.log("åŠ å…¥äº‘ç«¯åœ°å›¾æˆ¿é—´ï¼Œæ­£åœ¨åŠ è½½åœ°å›¾:",i.cloud_map_id),this.showMapLoadingOverlay("æ­£åœ¨åŠ è½½äº‘ç«¯åœ°å›¾...");try{const t=await MapCloudService.getMap(i.cloud_map_id);this.loadCustomMap(t),this.hideMapLoadingOverlay(),console.log("äº‘ç«¯åœ°å›¾åŠ è½½å®Œæˆ")}catch(t){console.error("äº‘ç«¯åœ°å›¾åŠ è½½å¤±è´¥:",t),this.hideMapLoadingOverlay(),this.waitingForCustomMap=!0}}else i.has_custom_map&&(console.log("åŠ å…¥è‡ªå®šä¹‰åœ°å›¾æˆ¿é—´ï¼Œåœ°å›¾å°†åœ¨è¿æ¥ååŒæ­¥"),this.waitingForCustomMap=!0);this.startGame(t,s,!1)}else this.showMenuError("æˆ¿é—´ä¸å­˜åœ¨ï¼Œè¯·åˆ›å»ºæˆ¿é—´æˆ–è¾“å…¥æ­£ç¡®çš„æˆ¿é—´å·")}).catch(()=>{this.startGame(t,s,!1)})}showMapLoadingOverlay(t){let s=document.getElementById("map-loading-overlay");if(s)s.querySelector(".map-loading-text").textContent=t,s.style.display="flex";else{if(s=document.createElement("div"),s.id="map-loading-overlay",s.innerHTML=`\n                <div class="map-loading-content">\n                    <div class="map-loading-spinner"></div>\n                    <div class="map-loading-text">${t}</div>\n                </div>\n            `,s.style.cssText="\n                position: fixed;\n                top: 0;\n                left: 0;\n                width: 100%;\n                height: 100%;\n                background: rgba(0, 0, 0, 0.8);\n                display: flex;\n                justify-content: center;\n                align-items: center;\n                z-index: 10000;\n            ",s.querySelector(".map-loading-content").style.cssText="\n                text-align: center;\n                color: #fff;\n            ",s.querySelector(".map-loading-spinner").style.cssText="\n                width: 50px;\n                height: 50px;\n                border: 4px solid rgba(255, 255, 255, 0.3);\n                border-top-color: #4ade80;\n                border-radius: 50%;\n                animation: spin 1s linear infinite;\n                margin: 0 auto 20px;\n            ",s.querySelector(".map-loading-text").style.cssText="\n                font-size: 18px;\n                font-family: 'Press Start 2P', monospace;\n            ",!document.getElementById("map-loading-style")){const t=document.createElement("style");t.id="map-loading-style",t.textContent="@keyframes spin { to { transform: rotate(360deg); } }",document.head.appendChild(t)}document.body.appendChild(s)}}hideMapLoadingOverlay(){const t=document.getElementById("map-loading-overlay");t&&(t.style.display="none")}checkRoomInfo(t){return new Promise((s,i)=>{const e=new WebSocket(WS_SERVER_URL);let n=!1;e.onopen=()=>{e.send(JSON.stringify({action:"check_room",room_id:t}))},e.onmessage=t=>{try{const i=JSON.parse(t.data);"room_check"===i.action&&(n=!0,e.close(),s({exists:i.exists,map:i.map,game_mode:i.game_mode,target_kills:i.target_kills,has_custom_map:i.has_custom_map||!1,cloud_map_id:i.cloud_map_id||null}))}catch(t){e.close(),i(t)}},e.onerror=()=>{n||i(new Error("è¿æ¥å¤±è´¥"))},setTimeout(()=>{n||(e.close(),i(new Error("è¶…æ—¶")))},2e3)})}showMenuError(t){const s=document.querySelector(".menu-error");s&&s.remove();const i=document.createElement("div");i.className="menu-error",i.textContent=t,i.style.cssText="color: #ff4444; background: rgba(255,0,0,0.1); padding: 10px 20px; border-radius: 5px; margin-top: 10px; text-align: center; border: 1px solid #ff4444;";const e=document.getElementById("joinBtn"),n=document.getElementById("createBtn"),o="none"!==e.style.display?e:n;o.parentNode.insertBefore(i,o.nextSibling),setTimeout(()=>i.remove(),3e3)}createGame(){const t=document.getElementById("playerName").value.trim();let s=document.getElementById("roomId").value.trim();if(s||(s=Math.random().toString(36).substr(2,8),document.getElementById("roomId").value=s),!this.validateInput(t,s))return;this.targetKills=parseInt(document.getElementById("targetKills").value)||20;const i=document.getElementById("gameMode").value||"deathmatch";if("custom"===i){if(!this.customMapData)return void showPixelToast("è¯·å…ˆå¯¼å…¥åœ°å›¾æ–‡ä»¶","warning")}else this.selectedMap=document.getElementById("mapSelect").value||"dust2",this.selectedGameMode=i;this.startGame(t,s,!0)}startGame(t,s,i){if(this.isMobile&&window.innerHeight>window.innerWidth)return this.pendingGameStart={name:t,roomId:s,isCreating:i},void this.showRotateHint();this.actualStartGame(t,s,i)}showRotateHint(){const t=document.getElementById("rotate-screen-hint");t&&(t.style.display="flex",t.innerHTML='\n                <div class="rotate-icon">ğŸ“±</div>\n                <div>è¯·å°†æ‰‹æœºæ¨ªå±</div>\n                <div style="font-size: 16px; margin-top: 10px; opacity: 0.7;">æ¨ªå±åè‡ªåŠ¨è¿›å…¥æ¸¸æˆ</div>\n            ');const s=()=>{if(window.innerWidth>window.innerHeight&&(window.removeEventListener("resize",s),screen.orientation&&screen.orientation.removeEventListener("change",s),t&&(t.style.display="none"),this.pendingGameStart)){const{name:t,roomId:s,isCreating:i}=this.pendingGameStart;this.pendingGameStart=null;const e=document.documentElement;e.requestFullscreen?e.requestFullscreen().then(()=>{this.actualStartGame(t,s,i)}).catch(()=>{this.actualStartGame(t,s,i)}):this.actualStartGame(t,s,i)}};window.addEventListener("resize",s),screen.orientation&&screen.orientation.addEventListener("change",s),setTimeout(s,100)}actualStartGame(t,s,i){let e;this.showConnectingOverlay(),console.log("[DEBUG] å°è¯•è¿æ¥æœåŠ¡å™¨:",WS_SERVER_URL);try{e=new WebSocket(WS_SERVER_URL)}catch(t){return console.error("[DEBUG] WebSocket åˆ›å»ºå¤±è´¥:",t),this.hideConnectingOverlay(),void this.showMenuError("WebSocket åˆ›å»ºå¤±è´¥: "+t.message)}const n=setTimeout(()=>{console.log("[DEBUG] è¿æ¥è¶…æ—¶"),e.close(),this.hideConnectingOverlay(),this.showMenuError("æœåŠ¡å™¨è¿æ¥è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–æœåŠ¡å™¨åœ°å€")},5e3);e.onopen=()=>{console.log("[DEBUG] æµ‹è¯•è¿æ¥æˆåŠŸ"),clearTimeout(n),e.close(),this.hideConnectingOverlay(),this.doStartGame(t,s,i)},e.onerror=t=>{console.error("[DEBUG] WebSocket é”™è¯¯:",t),clearTimeout(n),this.hideConnectingOverlay(),this.showMenuError("æœåŠ¡å™¨è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–æœåŠ¡å™¨åœ°å€")},e.onclose=t=>{console.log("[DEBUG] WebSocket å…³é—­, code:",t.code,"reason:",t.reason)}}showConnectingOverlay(){let t=document.getElementById("connecting-overlay");t||(t=document.createElement("div"),t.id="connecting-overlay",t.innerHTML='\n                <div class="connecting-content">\n                    <div class="connecting-spinner"></div>\n                    <div class="connecting-text">æ­£åœ¨è¿æ¥æœåŠ¡å™¨...</div>\n                </div>\n            ',document.body.appendChild(t)),t.style.display="flex"}hideConnectingOverlay(){const t=document.getElementById("connecting-overlay");t&&(t.style.display="none")}showMenuError(t){let s=document.getElementById("menu-error");if(!s){s=document.createElement("div"),s.id="menu-error";const t=document.querySelector(".menu-container");t&&t.appendChild(s)}s.textContent=t,s.style.display="block",setTimeout(()=>{s.style.display="none"},4e3)}doStartGame(t,s,i){document.body.classList.add("in-game"),document.getElementById("menu").style.display="none",document.getElementById("game").style.display="block",document.getElementById("target-kills").textContent=this.targetKills,document.getElementById("map-name").textContent=MapNames[this.selectedMap]||"æ²™æ¼ 2";const e="deathmatch"===this.selectedGameMode?"å›¢é˜Ÿç«æŠ€":"çˆ†ç ´æ¨¡å¼";document.getElementById("game-mode-text").textContent=e+" | ","deathmatch"===this.selectedGameMode&&(document.getElementById("game-timer").style.display="inline",document.getElementById("game-timer").textContent="10:00 | "),"undefined"!=typeof pixelMusic&&pixelMusic&&pixelMusic.stop(),document.getElementById("music-control").style.display="none";const n=document.getElementById("editor-link");n&&(n.style.display="none"),"undefined"!=typeof pixelBg&&pixelBg&&pixelBg.stop();const o=document.documentElement;this.isMobile?screen.orientation&&screen.orientation.lock&&screen.orientation.lock("landscape").catch(()=>{}):o.requestFullscreen&&o.requestFullscreen().catch(()=>{}),this.audio.init(),this.initThree(),this.updateC4SlotVisibility(),this.renderer.compile(this.scene,this.camera),this.renderer.render(this.scene,this.camera),this.connect(t,s,i),this.isMobile||setTimeout(()=>{document.body.requestPointerLock()},100),document.getElementById("backToMenu").addEventListener("click",()=>this.backToMenu())}backToMenu(){document.body.classList.remove("in-game"),this.stopPingMeasurement(),this.ws&&this.ws.close(),document.exitPointerLock(),document.fullscreenElement&&document.exitFullscreen(),screen.orientation&&screen.orientation.unlock&&screen.orientation.unlock(),location.reload()}initThree(){this.scene=new THREE.Scene,this.scene.background=new THREE.Color(7058393),this.scene.fog=null,this.camera=new THREE.PerspectiveCamera(this.normalFOV,window.innerWidth/window.innerHeight,.1,2e3),this.camera.position.set(0,this.standingHeight,0),this.renderer=new THREE.WebGLRenderer({antialias:!1,powerPreference:"high-performance"}),this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.setPixelRatio(Math.min(window.devicePixelRatio,2));const t=this.renderer.getContext(),s=t.getExtension("WEBGL_debug_renderer_info");if(s){const i=t.getParameter(s.UNMASKED_RENDERER_WEBGL);console.log("ğŸ® GPUåŠ é€Ÿå·²å¯ç”¨:",i)}document.getElementById("game").insertBefore(this.renderer.domElement,document.getElementById("game").firstChild);const i=new THREE.AmbientLight(16777215,.6);this.scene.add(i);const e=new THREE.DirectionalLight(16777215,.8);if(e.position.set(50,100,50),this.scene.add(e),this.waitingForCustomMap||"custom_map"===this.selectedMap&&!this.customMapData)this.walls=[],console.log("ç­‰å¾…æœåŠ¡å™¨å‘é€è‡ªå®šä¹‰åœ°å›¾é…ç½®...");else{const t=new MapBuilder(this.scene);this.walls=t.createMap(this.selectedMap)}this.createGunModel(),this.minimap=new Minimap(this),document.addEventListener("mousemove",t=>this.onMouseMove(t)),document.addEventListener("click",()=>{this.isLocked||this.buyMenuOpen||document.body.requestPointerLock()}),window.addEventListener("resize",()=>{this.camera.aspect=window.innerWidth/window.innerHeight,this.camera.updateProjectionMatrix(),this.renderer.setSize(window.innerWidth,window.innerHeight)}),this.animate()}connect(t,s,i){this.connectionInfo={name:t,roomId:s,isCreating:i},this.reconnectAttempts=0,this.isReconnecting=!1,this.establishConnection(t,s,i)}establishConnection(t,s,i){this.ws&&(this.ws.onclose=null,this.ws.onerror=null,this.ws.close()),this.ws=new WebSocket(WS_SERVER_URL),this.ws.onopen=()=>{console.log("WebSocketè¿æ¥æˆåŠŸ"),this.reconnectAttempts=0,this.isReconnecting=!1,this.hideReconnectOverlay(),this.startPingMeasurement();const e={action:"join",name:t,room_id:s,team:this.selectedTeam};if(i){e.target_kills=this.targetKills,e.map=this.selectedMap,e.game_mode=this.selectedGameMode,e.is_creating=!0;const t=MapConfigs[this.selectedMap];t&&(e.map_size=t.mapSize||125,t.bombSites&&(e.bomb_sites=t.bombSites),t.spawnPoints&&(e.spawn_points=t.spawnPoints),this.customMapData&&(e.custom_map_config=this.customMapData))}this.ws.send(JSON.stringify(e))},this.ws.onmessage=t=>{const s=JSON.parse(t.data);if("pong"===s.action){this.currentPing=Date.now()-this.lastPingTime;const t=document.getElementById("ping-text");return void(t&&(t.textContent=`å»¶è¿Ÿ: ${this.currentPing}ms`,this.currentPing<50?t.style.color="#4ade80":this.currentPing<100?t.style.color="#fbbf24":t.style.color="#ef4444"))}this.handleMessage(s)},this.ws.onclose=t=>{console.log("WebSocketè¿æ¥å…³é—­",t.code,t.reason),this.connectionInfo&&!this.gameOver&&this.attemptReconnect()},this.ws.onerror=t=>{console.error("WebSocketé”™è¯¯:",t)}}startPingMeasurement(){this.pingInterval&&clearInterval(this.pingInterval),this.pingInterval=setInterval(()=>{this.ws&&this.ws.readyState===WebSocket.OPEN&&(this.lastPingTime=Date.now(),this.ws.send(JSON.stringify({action:"ping"})))},2e3),this.ws&&this.ws.readyState===WebSocket.OPEN&&(this.lastPingTime=Date.now(),this.ws.send(JSON.stringify({action:"ping"})))}stopPingMeasurement(){this.pingInterval&&(clearInterval(this.pingInterval),this.pingInterval=null)}attemptReconnect(){if(this.isReconnecting||!this.connectionInfo)return;if(this.reconnectAttempts>=this.maxReconnectAttempts)return void this.showReconnectFailed();this.isReconnecting=!0,this.reconnectAttempts++;const t=this.reconnectDelay*Math.pow(1.5,this.reconnectAttempts-1);this.showReconnectOverlay(this.reconnectAttempts,this.maxReconnectAttempts),console.log(`å°è¯•é‡è¿ (${this.reconnectAttempts}/${this.maxReconnectAttempts})ï¼Œ${t}mså...`),setTimeout(()=>{this.isReconnecting=!1,this.connectionInfo&&this.establishConnection(this.connectionInfo.name,this.connectionInfo.roomId,!1)},t)}showReconnectOverlay(t,s){let i=document.getElementById("reconnect-overlay");i||(i=document.createElement("div"),i.id="reconnect-overlay",i.innerHTML='\n                <div class="reconnect-content">\n                    <div class="reconnect-spinner"></div>\n                    <div class="reconnect-text">è¿æ¥æ–­å¼€ï¼Œæ­£åœ¨é‡è¿...</div>\n                    <div class="reconnect-attempt"></div>\n                </div>\n            ',document.body.appendChild(i)),i.style.display="flex",i.querySelector(".reconnect-attempt").textContent=`å°è¯• ${t}/${s}`}hideReconnectOverlay(){const t=document.getElementById("reconnect-overlay");t&&(t.style.display="none")}showReconnectFailed(){let t=document.getElementById("reconnect-overlay");t&&(t.querySelector(".reconnect-spinner").style.display="none",t.querySelector(".reconnect-text").textContent="é‡è¿å¤±è´¥",t.querySelector(".reconnect-attempt").innerHTML='<button onclick="location.reload()">è¿”å›ä¸»é¡µ</button>')}handleMessage(t){switch(t.action){case"joined":this.playerId=t.player_id;const s=t.player;this.camera.position.set(s.x,this.standingHeight,s.y),this.currentWeapon=s.weapon||"ak47",this.primaryWeapon=this.currentWeapon;const i=WeaponConfigs[this.currentWeapon];if(this.ammo=i.ammo,this.maxAmmo=i.ammo,this.fireRate=i.fireRate,this.weaponRecoil=i.recoil,t.target_kills&&(this.targetKills=t.target_kills),t.custom_map_config){console.log("[DEBUG] æ”¶åˆ°æœåŠ¡å™¨å‘é€çš„ custom_map_config:",t.custom_map_config.name),console.log("[DEBUG] custom_map_config objects æ•°é‡:",t.custom_map_config.objects?.length||0),this.loadCustomMap(t.custom_map_config),console.log("[DEBUG] loadCustomMap å®Œæˆ, selectedMap:",this.selectedMap),console.log("[DEBUG] MapConfigs[selectedMap]:",MapConfigs[this.selectedMap]),this.waitingForCustomMap=!1,this.walls.forEach(t=>{t.mesh&&this.scene.remove(t.mesh)}),this.walls=[],console.log("[DEBUG] å¼€å§‹åˆ›å»ºåœ°å›¾, scene:",this.scene?"å­˜åœ¨":"ä¸å­˜åœ¨");const s=new MapBuilder(this.scene);this.walls=s.createMap(this.selectedMap),console.log("[DEBUG] åœ°å›¾åˆ›å»ºå®Œæˆ, walls æ•°é‡:",this.walls.length);const i=MapConfigs[this.selectedMap];i&&void 0!==i.skyColor&&(this.scene.background=new THREE.Color(i.skyColor)),document.getElementById("map-name").textContent=MapConfigs[this.selectedMap]?.displayName||"è‡ªå®šä¹‰åœ°å›¾"}else if(this.waitingForCustomMap)console.log("[DEBUG] ç­‰å¾…è‡ªå®šä¹‰åœ°å›¾ä½†æœåŠ¡å™¨æœªå‘é€ custom_map_config");else if(t.map&&this.selectedMap!==t.map){this.selectedMap=t.map,this.walls.forEach(t=>{t.mesh&&this.scene.remove(t.mesh)}),this.walls=[];const s=new MapBuilder(this.scene);this.walls=s.createMap(this.selectedMap),document.getElementById("map-name").textContent=MapNames[t.map]||MapConfigs[t.map]?.displayName||"è‡ªå®šä¹‰åœ°å›¾"}document.getElementById("target-kills").textContent=this.targetKills,this.updateGunModel(),this.updateAmmoDisplay(),this.updateState(t.state),"defuse"===t.game_mode&&this.initDefuseMode(t);break;case"state":this.updateState(t.state);break;case"delta":this.updateDeltaState(t.d);break;case"player_joined":this.addKillFeed(`${t.player.name} åŠ å…¥äº†æ¸¸æˆ`);break;case"player_left":const e=this.players[t.player_id];e&&this.addKillFeed(`${e.name} ç¦»å¼€äº†æ¸¸æˆ`),this.playerMeshes[t.player_id]&&(this.scene.remove(this.playerMeshes[t.player_id]),delete this.playerMeshes[t.player_id]),delete this.players[t.player_id];break;case"hits":t.hits.forEach(t=>{if("kill"===t.type){const s=this.players[t.killer],i=this.players[t.victim];if(s&&i){const e=this.formatKillMessage(s,i,t.headshot,t.weapon||"ak47");this.addKillFeed(e,t.headshot?"headshot":"kill")}if(i&&t.victim!==this.playerId){i.is_alive=!1,i.health=0;const s=this.playerMeshes[t.victim];!s||s.userData.isDying||s.userData.isDead||(s.userData.isDying=!0,s.userData.deathStartTime=Date.now(),s.userData.deathStartRotationX=s.rotation.x||0,s.userData.deathStartY=s.position.y)}if(t.killer===this.playerId){this.createHitMarker(),this.audio.playHitSound();const s=Date.now();s-this.lastKillTime<this.killStreakTimeout?this.killStreak++:this.killStreak=1,this.lastKillTime=s,this.showKillFeedback(t.headshot,t.knife_kill,this.killStreak),t.headshot?this.audio.playHeadshotVoice():t.knife_kill?this.audio.playKnifeKillVoice():this.killStreak>=2&&this.audio.playMultiKillVoice(this.killStreak)}t.victim===this.playerId&&(this.closeScope(),this.killStreak=0,this.audio.playDeathSound(),this.playDeathAnimation())}else"hit"===t.type&&t.shooter===this.playerId&&(this.createHitMarker(),this.audio.playHitSound())});break;case"respawn":t.player_id===this.playerId&&(this.clearRespawnTimer(),this.stopSpectating(),document.getElementById("death-screen").style.display="none",document.getElementById("game").classList.remove("dead-effect"),document.getElementById("death-overlay").classList.remove("active"),this.resetDeathAnimation(),this.camera.position.set(t.player.x,this.standingHeight,t.player.y),this.ammo=this.maxAmmo,this.grenadeCount=1,this.updateAmmoDisplay());break;case"game_over":const n=void 0!==t.ct_score?t.ct_score:t.ct_kills,o=void 0!==t.t_score?t.t_score:t.t_kills;this.showGameOver(t.winner,n,o,t.reason);break;case"new_game":this.handleNewGame(t);break;case"score_update":this.ctKills=t.ct_kills||0,this.tKills=t.t_kills||0,this.updateTeamScores();break;case"room_full":showPixelToast("æˆ¿é—´å·²æ»¡ (æ¯é˜Ÿæœ€å¤š8äºº)","warning",()=>this.backToMenu());break;case"room_not_found":showPixelToast("æˆ¿é—´ä¸å­˜åœ¨ï¼Œè¯·åˆ›å»ºæˆ¿é—´æˆ–è¾“å…¥æ­£ç¡®çš„æˆ¿é—´å·","error",()=>this.backToMenu());break;case"join_error":showPixelToast(t.message||"åŠ å…¥æˆ¿é—´å¤±è´¥","error",()=>this.backToMenu());break;case"bullet":if(t.bullet&&t.bullet.owner_id!==this.playerId){const s=this.players[t.bullet.owner_id];if(s){const i=s.x-this.camera.position.x,e=s.y-this.camera.position.z,n=Math.sqrt(i*i+e*e)/180,o=.6*Math.max(0,1-n*n);o>.001&&this.audio.playRemoteGunSound(t.bullet.weapon||s.weapon||"ak47",o),this.createRemoteBulletHole(s,t.bullet.angle,t.bullet.pitch||0)}}break;case"knife_attack":t.player_id!==this.playerId&&this.playRemoteKnifeAnimation(t.player_id,t.is_heavy);break;case"grenade_thrown":if(t.owner_id!==this.playerId){const s=new THREE.Vector3(t.start.x,t.start.y,t.start.z),i=new THREE.Vector3(t.direction.x,t.direction.y,t.direction.z);this.createLocalGrenade(s,i,!0)}break;case"c4_planted":this.onC4Planted(t);break;case"bomb_defused":this.onBombDefused(t);break;case"bomb_exploded":this.onBombExploded(t);break;case"round_end":this.onRoundEnd(t);break;case"round_start":this.onRoundStart(t);break;case"freeze_time_end":this.onFreezeTimeEnd();break;case"defuse_started":this.onDefuseStarted(t);break;case"defuse_cancelled":case"defuse_interrupted":this.onDefuseCancelled();break;case"plant_failed":case"defuse_failed":this.addKillFeed(t.message)}}initDefuseMode(t){this.isDefuseMode=!0,this.hasC4=t.has_c4||!1,this.c4Planted=!1,this.c4Position=null,this.c4Site=null,this.bombSites=t.bomb_sites||{},this.currentRound=t.current_round||1,this.ctScore=t.ct_score||0,this.tScore=t.t_score||0,this.isPlanting=!1,this.isDefusing=!1,this.plantProgress=0,this.defuseProgress=0,document.getElementById("defuse-hud").style.display="block",document.getElementById("round-info").style.display="inline",document.getElementById("deathmatch-info").style.display="none",document.getElementById("game").classList.add("defuse-mode"),document.getElementById("current-round").textContent=this.currentRound,document.getElementById("max-rounds").textContent="10",this.updateDefuseHUD(),this.updateDefuseScores()}onC4Planted(t){this.c4Planted=!0,this.c4Position=t.position,this.c4Site=t.site,this.hasC4=!1,this.c4PlantedTime=Date.now(),this.lastC4BeepTime=0,document.getElementById("c4-timer-display").style.display="block",document.getElementById("plant-hint").style.display="none",this.createC4Model(t.position),this.audio.playC4PlantSound(),this.addKillFeed(`ğŸ’£ C4å·²å®‰æ”¾åœ¨ ${t.site} ç‚¹!`,"bomb"),"ct"===this.selectedTeam&&this.showDefuseHint(),t.planter===this.playerId&&this.switchToSlot(1)}createC4Model(t){this.c4Model&&this.scene.remove(this.c4Model);const s=new THREE.Group,i=new THREE.BoxGeometry(3,1.5,2),e=new THREE.MeshLambertMaterial({color:2960685,transparent:!0,opacity:.95,depthWrite:!1}),n=new THREE.Mesh(i,e);n.renderOrder=1,s.add(n);const o=new THREE.SphereGeometry(.3,8,8),h=new THREE.MeshBasicMaterial({color:16711680,transparent:!0,opacity:1,depthWrite:!1}),c=new THREE.Mesh(o,h);c.position.set(0,.8,0),c.renderOrder=2,s.add(c),this.c4Light=c;const a=new THREE.CylinderGeometry(.1,.1,1,8),r=new THREE.MeshLambertMaterial({color:3355443,transparent:!0,opacity:.95,depthWrite:!1}),l=new THREE.Mesh(a,r);l.position.set(1,0,0),l.rotation.z=Math.PI/4,l.renderOrder=1,s.add(l);const d=new THREE.BoxGeometry(1.2,.5,.1),u=new THREE.MeshBasicMaterial({color:65280,transparent:!0,opacity:1,depthWrite:!1}),m=new THREE.Mesh(d,u);m.position.set(0,.3,1.05),m.renderOrder=2,s.add(m);const p=new THREE.RingGeometry(2,4,32),f=new THREE.MeshBasicMaterial({color:16711680,transparent:!0,opacity:.3,side:THREE.DoubleSide,depthWrite:!1,depthTest:!1}),b=new THREE.Mesh(p,f);b.position.set(0,.1,0),b.rotation.x=-Math.PI/2,b.renderOrder=999,b.raycast=()=>{},s.add(b),this.c4Glow=b;const w=new THREE.CylinderGeometry(.5,1.5,8,16,1,!0),v=new THREE.MeshBasicMaterial({color:16724736,transparent:!0,opacity:.15,side:THREE.DoubleSide,depthWrite:!1,depthTest:!1}),M=new THREE.Mesh(w,v);M.position.set(0,4,0),M.renderOrder=999,M.raycast=()=>{},s.add(M),this.c4Beam=M,s.position.set(t.x,1,t.z),this.scene.add(s),this.c4Model=s}onBombDefused(t){this.c4Planted=!1,this.c4PlantedTime=null,this.lastC4BeepTime=0,document.getElementById("c4-timer-display").style.display="none",document.getElementById("defuse-progress-container").style.display="none",document.getElementById("defuse-hint").style.display="none",this.c4Model&&(this.scene.remove(this.c4Model),this.c4Model=null),this.audio.playC4DefusedSound(),this.addKillFeed("ğŸ’š C4å·²è¢«æ‹†é™¤!","bomb")}onBombExploded(t){this.c4Planted=!1,this.c4PlantedTime=null,this.lastC4BeepTime=0,document.getElementById("c4-timer-display").style.display="none",this.c4Position&&this.createC4Explosion(this.c4Position),this.c4Model&&(this.scene.remove(this.c4Model),this.c4Model=null),this.audio.playC4ExplodeSound(),this.addKillFeed("ğŸ’¥ C4å·²çˆ†ç‚¸!","bomb")}createC4Explosion(t){const s=new THREE.SphereGeometry(15,32,32),i=new THREE.MeshBasicMaterial({color:16737792,transparent:!0,opacity:.9}),e=new THREE.Mesh(s,i);e.position.set(t.x,10,t.z),this.scene.add(e);const n=new THREE.RingGeometry(1,3,32),o=new THREE.MeshBasicMaterial({color:16776960,transparent:!0,opacity:.8,side:THREE.DoubleSide}),h=new THREE.Mesh(n,o);h.position.set(t.x,1,t.z),h.rotation.x=-Math.PI/2,this.scene.add(h);const c=this.camera.position.distanceTo(new THREE.Vector3(t.x,10,t.z));this.screenShake=Math.max(.5,2-c/100),this.audio.playExplosionSound();let a=1;const r=()=>{a+=.5,e.scale.set(a,a,a),i.opacity-=.03,h.scale.set(3*a,3*a,1),o.opacity-=.02,i.opacity>0?requestAnimationFrame(r):(this.scene.remove(e),this.scene.remove(h))};r()}onRoundEnd(t){const s=document.getElementById("round-end-screen"),i=document.getElementById("round-winner"),e=document.getElementById("round-reason"),n=document.getElementById("round-score");"ct"===t.winner?(i.textContent="åæç²¾è‹±è·èƒœ",i.className="ct-win"):(i.textContent="ææ€–åˆ†å­è·èƒœ",i.className="t-win"),e.textContent={bomb_exploded:"C4å·²çˆ†ç‚¸",bomb_defused:"C4å·²æ‹†é™¤",t_eliminated:"ææ€–åˆ†å­å…¨ç­",ct_eliminated:"åæç²¾è‹±å…¨ç­",time_up:"æ—¶é—´ç»“æŸ"}[t.reason]||t.reason,n.textContent=`åæç²¾è‹± ${t.ct_score} - ${t.t_score} ææ€–åˆ†å­`,this.ctScore=t.ct_score,this.tScore=t.t_score,this.updateDefuseScores(),s.style.display="flex",setTimeout(()=>{s.style.display="none"},3e3)}onRoundStart(t){if(this.currentRound=t.round,this.c4Planted=!1,this.c4Position=null,this.c4PlantedTime=null,this.lastC4BeepTime=0,this.isPlanting=!1,this.isDefusing=!1,this.plantInterval&&(clearInterval(this.plantInterval),this.plantInterval=null),document.getElementById("round-end-screen").style.display="none",document.getElementById("c4-timer-display").style.display="none",document.getElementById("defuse-progress-container").style.display="none",document.getElementById("plant-progress-container").style.display="none",document.getElementById("plant-hint").style.display="none",document.getElementById("defuse-hint").style.display="none",document.getElementById("freeze-time-overlay").style.display="flex",this.c4Model&&(this.scene.remove(this.c4Model),this.c4Model=null),document.getElementById("current-round").textContent=this.currentRound,document.getElementById("death-screen").style.display="none",document.getElementById("game").classList.remove("dead-effect"),document.getElementById("death-overlay").classList.remove("active"),this.resetDeathAnimation(),this.stopSpectating(),t.players&&t.players[this.playerId]){const s=t.players[this.playerId];this.camera.position.set(s.x,this.standingHeight,s.y),this.players=t.players}this.hasC4=t.c4_carrier===this.playerId,this.updateDefuseHUD(),this.ammo=this.maxAmmo,this.grenadeCount=1,this.updateAmmoDisplay(),this.addKillFeed(`=== ç¬¬ ${this.currentRound} å›åˆ ===`)}onFreezeTimeEnd(){document.getElementById("freeze-time-overlay").style.display="none",this.addKillFeed("å›åˆå¼€å§‹!")}onDefuseStarted(t){t.defuser!==this.playerId&&this.addKillFeed("CTæ­£åœ¨æ‹†å¼¹...")}onDefuseCancelled(){document.getElementById("defuse-progress-container").style.display="none",this.isDefusing=!1,this.defuseProgress=0}updateDefuseHUD(){if(!this.isDefuseMode)return;const t=document.getElementById("c4-status");this.hasC4?t.textContent="ä½ æºå¸¦ç€C4 (æŒ‰5åˆ‡å‡º)":this.c4Planted?t.textContent=`C4å·²å®‰æ”¾åœ¨ ${this.c4Site} ç‚¹`:t.textContent="",this.updateC4SlotVisibility()}updateC4SlotVisibility(){const t=document.querySelector('.weapon-slot[data-slot="5"]');t&&(this.isDefuseMode&&this.hasC4?(t.classList.add("show-c4"),t.style.background="rgba(255, 100, 0, 0.6)"):t.classList.remove("show-c4"))}updateC4BeepSound(){if(!this.c4Planted||!this.c4PlantedTime)return;const t=Date.now(),s=(t-this.c4PlantedTime)/1e3,i=Math.max(0,40-s);let e;e=i<=5?200:i<=10?400:i<=20?800:1500,(!this.lastC4BeepTime||t-this.lastC4BeepTime>=e)&&(this.audio.playC4BeepSound(i),this.lastC4BeepTime=t)}updateDefuseScores(){document.getElementById("ct-score").textContent=`åæç²¾è‹±: ${this.ctScore}`,document.getElementById("t-score").textContent=`ææ€–åˆ†å­: ${this.tScore}`}startSpectating(){if(this.isDefuseMode){if(this.spectatorTargets=this.getAliveTeammates(),0===this.spectatorTargets.length)return this.isSpectating=!1,this.spectatingPlayerId=null,void this.hideSpectatorUI();this.isSpectating=!0,this.spectatingPlayerId=this.spectatorTargets[0],this.spectatorYaw=0,this.spectatorPitch=-.3,this.spectatorDistance=20,this.spectatorTargetPos={x:0,y:0,z:0},this.showSpectatorUI(),this.updateSpectatorView()}}getAliveTeammates(){const t=[];for(const[s,i]of Object.entries(this.players))s!==this.playerId&&i.team===this.selectedTeam&&i.is_alive&&t.push(s);return t}switchSpectatorTarget(){if(!this.isSpectating)return;if(this.spectatorTargets=this.getAliveTeammates(),0===this.spectatorTargets.length)return void this.stopSpectating();const t=(this.spectatorTargets.indexOf(this.spectatingPlayerId)+1)%this.spectatorTargets.length;this.spectatingPlayerId=this.spectatorTargets[t],this.updateSpectatorView()}updateSpectatorView(){if(!this.isSpectating||!this.spectatingPlayerId)return;const t=this.players[this.spectatingPlayerId];if(!t||!t.is_alive)return this.spectatorTargets=this.getAliveTeammates(),void(this.spectatorTargets.length>0?(this.spectatingPlayerId=this.spectatorTargets[0],this.updateSpectatorView()):this.stopSpectating());const s=document.getElementById("spectator-name");s&&(s.textContent=t.name||"é˜Ÿå‹"),this.updateSpectatorWeapon()}stopSpectating(){this.isSpectating=!1,this.spectatingPlayerId=null,this.spectatorTargets=[],this.hideSpectatorUI()}showSpectatorUI(){const t=document.getElementById("spectator-ui");t&&(t.style.display="block"),this.updateSpectatorWeapon()}updateSpectatorWeapon(){this.isSpectating&&this.spectatingPlayerId&&this.gunModel&&(this.gunModel.visible=!1)}hideSpectatorUI(){const t=document.getElementById("spectator-ui");t&&(t.style.display="none"),this.gunModel&&(this.gunModel.visible=!0),this.updateGunModel()}updateSpectatorCamera(){if(!this.isSpectating||!this.spectatingPlayerId)return;const t=this.players[this.spectatingPlayerId];if(!t||!t.is_alive)return void this.switchSpectatorTarget();const s=t.x,i=t.y,e=(t.height_offset||0)+this.standingHeight,n=.15;this.spectatorTargetPos||(this.spectatorTargetPos={x:s,y:e,z:i}),this.spectatorTargetPos.x+=(s-this.spectatorTargetPos.x)*n,this.spectatorTargetPos.y+=(e-this.spectatorTargetPos.y)*n,this.spectatorTargetPos.z+=(i-this.spectatorTargetPos.z)*n;const o=this.spectatorDistance||20,h=this.yaw,c=Math.max(-Math.PI/3,Math.min(Math.PI/6,this.pitch)),a=this.spectatorTargetPos.x-Math.sin(h)*Math.cos(c)*o,r=this.spectatorTargetPos.z-Math.cos(h)*Math.cos(c)*o,l=this.spectatorTargetPos.y-Math.sin(c)*o+5;this.camera.position.x=a,this.camera.position.z=r,this.camera.position.y=Math.max(2,l),this.camera.lookAt(this.spectatorTargetPos.x,this.spectatorTargetPos.y,this.spectatorTargetPos.z)}showDefuseHint(){this.c4Planted&&"ct"===this.selectedTeam&&(document.getElementById("defuse-hint").style.display="block")}isInBombSite(){if(!this.bombSites||!this.camera)return null;const t=this.camera.position.x,s=this.camera.position.z;for(const[i,e]of Object.entries(this.bombSites)){const n=t-e.x,o=s-e.z;if(Math.sqrt(n*n+o*o)<=e.radius)return i}return null}isNearC4(){if(!this.c4Planted||!this.c4Position||!this.camera)return!1;const t=this.camera.position.x-this.c4Position.x,s=this.camera.position.z-this.c4Position.z;return Math.sqrt(t*t+s*s)<=5}tryPlantC4(){this.isDefuseMode&&this.hasC4&&!this.c4Planted&&this.isInBombSite()&&this.startPlantingC4()}startPlantingC4(){this.isDefuseMode&&this.hasC4&&!this.c4Planted&&!this.isPlanting&&(this.isInBombSite()?(this.isPlanting=!0,this.plantProgress=0,this.plantStartTime=Date.now(),document.getElementById("plant-progress-container").style.display="block",this.audio.playC4PlantSound(),this.plantInterval=setInterval(()=>{if(!this.isPlanting)return clearInterval(this.plantInterval),void(this.plantInterval=null);const t=(Date.now()-this.plantStartTime)/1e3;this.plantProgress=Math.min(t/3,1);const s=document.getElementById("plant-progress");if(s&&(s.style.width=100*this.plantProgress+"%"),!this.isInBombSite())return this.cancelPlanting(),void this.addKillFeed("ç¦»å¼€åŒ…ç‚¹ï¼Œä¸‹åŒ…å–æ¶ˆ");this.plantProgress>=1&&(clearInterval(this.plantInterval),this.plantInterval=null,this.isPlanting=!1,document.getElementById("plant-progress-container").style.display="none",this.ws.send(JSON.stringify({action:"plant_c4"})),this.hasC4=!1,this.switchToSlot(1))},50)):this.addKillFeed("ä¸åœ¨åŒ…ç‚¹èŒƒå›´å†…"))}cancelPlanting(){this.isPlanting&&(this.isPlanting=!1,this.plantProgress=0,this.plantInterval&&(clearInterval(this.plantInterval),this.plantInterval=null),document.getElementById("plant-progress-container").style.display="none")}tryDefuse(){this.isDefuseMode&&this.c4Planted&&"ct"===this.selectedTeam&&this.isNearC4()&&!this.isDefusing&&(this.isDefusing=!0,this.defuseStartTime=Date.now(),document.getElementById("defuse-progress-container").style.display="block",this.audio.playC4DefuseSound(),this.ws.send(JSON.stringify({action:"start_defuse"})))}updateDefuseProgress(){if(!this.isDefusing||!this.c4Planted)return;if(!this.keys.KeyE)return void this.cancelDefuse();if(!this.isNearC4())return this.cancelDefuse(),void this.addKillFeed("ç¦»å¼€C4ï¼Œæ‹†å¼¹å–æ¶ˆ");const t=(Date.now()-this.defuseStartTime)/1e3,s=Math.min(t/10,1),i=document.getElementById("defuse-progress");i&&(i.style.width=100*s+"%")}cancelDefuse(){this.isDefusing&&(this.isDefusing=!1,document.getElementById("defuse-progress-container").style.display="none",this.ws.send(JSON.stringify({action:"cancel_defuse"})))}updateState(t){if(this.players=t.players,void 0!==t.ct_kills&&(this.ctKills=t.ct_kills),void 0!==t.t_kills&&(this.tKills=t.t_kills),this.updateTeamScores(),void 0!==t.remaining_time&&t.remaining_time>=0){this.remainingTime=t.remaining_time;const s=Math.floor(this.remainingTime/60),i=this.remainingTime%60;document.getElementById("game-timer").textContent=`${s}:${i.toString().padStart(2,"0")} | `,document.getElementById("game-timer").style.display="inline"}if(t.game_mode){this.selectedGameMode=t.game_mode;const s="deathmatch"===t.game_mode?"å›¢é˜Ÿç«æŠ€":"çˆ†ç ´æ¨¡å¼";document.getElementById("game-mode-text").textContent=s+" | "}if("defuse"===t.game_mode){if(void 0!==t.current_round&&(this.currentRound=t.current_round,document.getElementById("current-round").textContent=this.currentRound),void 0!==t.ct_score&&(this.ctScore=t.ct_score),void 0!==t.t_score&&(this.tScore=t.t_score),this.updateDefuseScores(),void 0!==t.round_time&&t.round_time>=0){const s=Math.floor(t.round_time/60),i=t.round_time%60;document.getElementById("game-timer").textContent=`${s}:${i.toString().padStart(2,"0")} | `,document.getElementById("game-timer").style.display="inline"}t.is_freeze_time?(document.getElementById("freeze-time-overlay").style.display="flex",void 0!==t.round_time&&(document.getElementById("freeze-countdown").textContent=`å‡†å¤‡é˜¶æ®µ ${t.round_time}`)):document.getElementById("freeze-time-overlay").style.display="none",t.c4_planted?(this.c4Planted=!0,t.c4_position&&(this.c4Position=t.c4_position),t.c4_site&&(this.c4Site=t.c4_site),void 0!==t.c4_time&&(document.getElementById("c4-timer-display").style.display="block",document.getElementById("c4-countdown").textContent=t.c4_time,document.getElementById("c4-timer-display").style.animationDuration=t.c4_time<=10?"0.25s":"0.5s"),"ct"===this.selectedTeam&&this.isNearC4()?document.getElementById("defuse-hint").style.display="block":document.getElementById("defuse-hint").style.display="none"):(this.c4Planted=!1,document.getElementById("c4-timer-display").style.display="none",document.getElementById("defuse-hint").style.display="none"),void 0!==t.defuse_progress&&t.defuse_progress>0&&t.defuser_id===this.playerId?(document.getElementById("defuse-progress-container").style.display="block",document.getElementById("defuse-progress-bar").style.setProperty("--progress",100*t.defuse_progress+"%")):this.isDefusing||(document.getElementById("defuse-progress-container").style.display="none"),t.c4_carrier===this.playerId?(this.hasC4=!0,!this.isInBombSite()||t.c4_planted||t.is_freeze_time?document.getElementById("plant-hint").style.display="none":document.getElementById("plant-hint").style.display="block"):(this.hasC4=!1,document.getElementById("plant-hint").style.display="none"),this.updateDefuseHUD()}const s=document.getElementById("scoreboard-panel");s&&s.classList.contains("visible")&&this.updateScoreboard(),Object.entries(this.players).forEach(([t,s])=>{if(t===this.playerId)return void this.updateHUD(s);if(!s.is_alive){if(this.playerMeshes[t]){const s=this.playerMeshes[t];s.userData.isDying||s.userData.isDead||(s.userData.isDying=!0,s.userData.deathStartTime=Date.now(),s.userData.deathStartRotationX=s.rotation.x||0,s.userData.deathStartY=s.position.y)}return}if(this.playerMeshes[t]&&(this.playerMeshes[t].userData.isDying||this.playerMeshes[t].userData.isDead)&&(this.scene.remove(this.playerMeshes[t]),delete this.playerMeshes[t]),!this.playerMeshes[t]||this.playerMeshes[t].userData.crouching!==s.crouching||this.playerMeshes[t].userData.weapon!==s.weapon){let i=null,e=null;this.playerMeshes[t]&&(i=this.playerMeshes[t].position.clone(),e=this.playerMeshes[t].rotation.y,this.scene.remove(this.playerMeshes[t]));const n=PlayerModel.create(s.team,s.crouching,s.weapon);n.userData.crouching=s.crouching,n.userData.weapon=s.weapon,n.userData.meshId=Date.now()+"_"+t,i?(n.position.copy(i),n.rotation.y=e):(n.position.set(s.x,s.height_offset||0,s.y),n.rotation.y=-s.angle+Math.PI/2),this.scene.add(n),this.playerMeshes[t]=n}const i=this.playerMeshes[t];i&&(i.userData.targetX=s.x,i.userData.targetZ=s.y,i.userData.targetY=s.height_offset||0,i.userData.targetAngle=-s.angle+Math.PI/2,i.userData.isShooting=s.is_shooting)}),Object.keys(this.playerMeshes).forEach(t=>{t===this.playerId||this.players[t]||(this.scene.remove(this.playerMeshes[t]),delete this.playerMeshes[t])})}updateDeltaState(t){t&&t.players&&Object.entries(t.players).forEach(([t,s])=>{if(t!==this.playerId&&this.players[t]){this.players[t].x=s.x,this.players[t].y=s.y,this.players[t].angle=s.a,void 0!==s.h&&(this.players[t].health=s.h),void 0!==s.s&&(this.players[t].is_shooting=s.s);const i=this.playerMeshes[t];i&&(i.userData.targetX=s.x,i.userData.targetZ=s.y,i.userData.targetAngle=-s.a+Math.PI/2,i.userData.isShooting=s.s)}})}updateOtherPlayers(){const t=.3;for(const[s,i]of Object.entries(this.playerMeshes)){if(i.userData.isDying){const t=Date.now()-i.userData.deathStartTime,e=600,n=Math.min(t/e,1),o=1-Math.pow(1-n,3);if(i.rotation.x=i.userData.deathStartRotationX+Math.PI/2*o,i.position.y=i.userData.deathStartY-3*o,n>=1){i.userData.isDying=!1,i.userData.isDead=!0;const t=i.userData.meshId;setTimeout(()=>{this.playerMeshes[s]&&this.playerMeshes[s].userData.isDead&&this.playerMeshes[s].userData.meshId===t&&(this.scene.remove(this.playerMeshes[s]),delete this.playerMeshes[s])},3e3)}continue}if(i.userData.isDead)continue;if(!i.userData.targetX)continue;const e=i.userData.targetX-i.position.x,n=i.userData.targetZ-i.position.z,o=Math.sqrt(e*e+n*n);i.userData.lastPosX||(i.userData.lastPosX=i.position.x,i.userData.lastPosZ=i.position.z);const h=i.position.x-i.userData.lastPosX,c=i.position.z-i.userData.lastPosZ,a=Math.sqrt(h*h+c*c);i.userData.lastPosX=i.position.x,i.userData.lastPosZ=i.position.z,i.userData.smoothSpeed||(i.userData.smoothSpeed=0),i.userData.smoothSpeed=.8*i.userData.smoothSpeed+.2*a;const r=i.userData.smoothSpeed>.05||o>.5;if(o>50)i.position.x=i.userData.targetX,i.position.z=i.userData.targetZ,i.position.y=i.userData.targetY,i.rotation.y=i.userData.targetAngle;else{i.position.x+=e*t,i.position.z+=n*t,r?(i.userData.walkPhase||(i.userData.walkPhase=0),i.userData.walkPhase+=.25,PlayerModel.animateWalk(i,i.userData.walkPhase),i.position.y+=(i.userData.targetY-i.position.y)*t):(i.position.y+=(i.userData.targetY-i.position.y)*t,PlayerModel.resetLegs(i),i.userData.walkPhase=0);let s=i.userData.targetAngle-i.rotation.y;for(;s>Math.PI;)s-=2*Math.PI;for(;s<-Math.PI;)s+=2*Math.PI;i.rotation.y+=s*t}}}respawn(){this.ws&&this.ws.readyState===WebSocket.OPEN&&this.ws.send(JSON.stringify({action:"respawn"}))}checkRotatedRectCollision(t,s,i,e,n,o,h){const c=Math.cos(-h),a=Math.sin(-h),r=t-i,l=s-e,d=r*c-l*a,u=r*a+l*c,m=d-Math.max(-n,Math.min(n,d)),p=u-Math.max(-o,Math.min(o,u)),f=Math.sqrt(m*m+p*p);let b,w;if(Math.abs(d)<=n&&Math.abs(u)<=o){const t=d+n,s=n-d,i=u+o,e=o-u,c=Math.min(t,s,i,e);let a=0,r=0;c===t?a=-1:c===s?a=1:r=c===i?-1:1;const l=Math.cos(h),m=Math.sin(h);return b=a*l-r*m,w=a*m+r*l,{dist:-c,pushX:b,pushZ:w,isInside:!0,penetration:c}}if(f>.001){const t=m/f,s=p/f,i=Math.cos(h),e=Math.sin(h);b=t*i-s*e,w=t*e+s*i}else b=1,w=0;return{dist:f,pushX:b,pushZ:w,isInside:!1,penetration:0}}checkCollision(t,s,i=null){const e=2.5,n=MapConfigs[this.selectedMap],o=n&&n.mapSize||125,h=null!==i?i:this.camera.position.y,c=h;let a=t,r=s,l=!1,d=0;a<-o&&(a=-o,l=!0),a>o&&(a=o,l=!0),r<-o&&(r=-o,l=!0),r>o&&(r=o,l=!0);for(let t=0;t<4;t++){let t=0,s=0,i=0;for(const n of this.walls){const o=n.h||20,u=n.hBottom||0,m=h-this.standingHeight;if(!(c<u)){if(m>=o-.5){let t=!1;if(n.rotation&&0!==n.rotation){const s=(n.originalW||n.w)/2,i=(n.originalD||n.d)/2,e=void 0!==n.centerX?n.centerX:n.x+n.w/2,o=void 0!==n.centerZ?n.centerZ:n.z+n.d/2;t=this.checkRotatedRectCollision(a,r,e,o,s,i,n.rotation).isInside}else{const s=n.x,i=n.z,e=n.w,o=n.d;t=a>=s&&a<=s+e&&r>=i&&r<=i+o}t&&o<=20&&(d=Math.max(d,o));continue}if(n.rotation&&0!==n.rotation){const o=(n.originalW||n.w)/2,h=(n.originalD||n.d)/2,c=void 0!==n.centerX?n.centerX:n.x+n.w/2,d=void 0!==n.centerZ?n.centerZ:n.z+n.d/2,u=this.checkRotatedRectCollision(a,r,c,d,o,h,n.rotation);if(u.isInside){const n=u.penetration+e;n>t&&(t=n,s=u.pushX*n,i=u.pushZ*n),l=!0}else if(u.dist<e){const n=e-u.dist;n>t&&(t=n,s=u.pushX*n,i=u.pushZ*n),l=!0}}else{const o=n.x,h=n.z,c=n.w,d=n.d,u=a-Math.max(o,Math.min(a,o+c)),m=r-Math.max(h,Math.min(r,h+d)),p=Math.sqrt(u*u+m*m);if(p<e){l=!0;const n=e-p;if(n>t)if(t=n,p>.01)s=u/p*n,i=m/p*n;else{const t=a-o,n=o+c-a,l=r-h,u=h+d-r,m=Math.min(t,n,l,u);m===t?(s=-(e+t),i=0):m===n?(s=e+n,i=0):m===l?(s=0,i=-(e+l)):(s=0,i=e+u)}}}}}if(!(t>.01))break;a+=s,r+=i}return a=Math.max(-o,Math.min(o,a)),r=Math.max(-o,Math.min(o,r)),{blocked:l,pushX:a-t,pushZ:r-s,clampedX:a,clampedZ:r,standingOnHeight:d}}canStandAt(t,s){for(const i of this.walls){const e=i.h||20;if(e<=this.crouchingHeight||e>this.standingHeight)continue;let n;if(i.rotation&&0!==i.rotation){const e=(i.originalW||i.w)/2,o=(i.originalD||i.d)/2,h=void 0!==i.centerX?i.centerX:i.x+i.w/2,c=void 0!==i.centerZ?i.centerZ:i.z+i.d/2,a=this.checkRotatedRectCollision(t,s,h,c,e,o,i.rotation);n=a.isInside?-a.penetration:a.dist}else{const e=i.x,o=i.z,h=i.w,c=i.d,a=t-Math.max(e,Math.min(t,e+h)),r=s-Math.max(o,Math.min(s,o+c));n=Math.sqrt(a*a+r*r)}if(n<2.5)return!1}return!0}update(t){const s=t/(1/60);if(this.isLocked&&this.isFiring){const t=WeaponConfigs[this.currentWeapon];t&&t.auto&&this.shoot()}if(!this.isFiring){if(Date.now()-this.lastShotReleaseTime>150&&(this.shotsFired=Math.max(0,this.shotsFired-1),0===this.shotsFired)){const t=Math.pow(.85,s);this.recoilAccumulator*=t}const t=Math.pow(.9,s);this.crosshairOffset*=t}if(this.isDefusing&&this.updateDefuseProgress(),this.updateMobileDefuseButton(),this.c4Planted&&this.isDefuseMode&&this.updateC4BeepSound(),!this.playerId||this.gameOver)return this.updateGunAnimation(s),void this.updateOtherPlayers();const i=this.players[this.playerId];if(!i||!i.is_alive)return this.isSpectating&&this.updateSpectatorCamera(),this.updateGunAnimation(s),void this.updateOtherPlayers();const e=this.isCrouching?10:18;let n=1;"knife"===this.currentWeapon?n=1.3:"awp"===this.currentWeapon&&(n=.8);const o=e*t*n;let h=0,c=0;if(this.keys.KeyW&&(c=-1),this.keys.KeyS&&(c=1),this.keys.KeyA&&(h=-1),this.keys.KeyD&&(h=1),0!==h||0!==c){const t=this.yaw,s=(Math.sin(t)*c+Math.cos(t)*h)*o,i=(Math.cos(t)*c-Math.sin(t)*h)*o;let e=this.camera.position.x+s,n=this.camera.position.z+i;const a=this.checkCollision(e,n);a.blocked&&(e=a.clampedX,n=a.clampedZ),this.currentStandingHeight=a.standingOnHeight||0,this.camera.position.x=e,this.camera.position.z=n,this.audio.playFootstep()}this.keys.Space&&this.canJump&&(this.velocity.y=this.isCrouching?39:45,this.canJump=!1);const a=(this.isCrouching?this.crouchingHeight:this.standingHeight)+(this.currentStandingHeight||0);if(this.targetCameraHeight=a,this.canJump){const s=this.targetCameraHeight-this.camera.position.y;if(Math.abs(s)>.1){const i=this.isCrouching?50:15;this.camera.position.y+=s*Math.min(i*t,1)}else this.camera.position.y=this.targetCameraHeight}else{const s=150;this.velocity.y-=s*t,this.camera.position.y+=this.velocity.y*t,this.camera.position.y<a&&(this.camera.position.y=a,this.velocity.y=0,this.canJump=!0)}this.currentHeight=this.camera.position.y;const r=performance.now();this.ws&&this.ws.readyState===WebSocket.OPEN&&r-this.lastNetworkSend>=this.networkSendInterval&&(this.lastNetworkSend=r,this.ws.send(JSON.stringify({action:"update_position",x:this.camera.position.x,z:this.camera.position.z,height:this.currentHeight,crouching:this.isCrouching,angle:-this.yaw+Math.PI/2}))),this.updateGunAnimation(s),this.updateOtherPlayers()}updateGunAnimation(t=1){if(!this.gunModel||!this.gunBasePosition||!this.gunBaseRotation)return;if(this.isKnifeAttacking&&"knife"===this.currentWeapon)return void this.updateKnifeAnimation();if(this.gunModel.position.copy(this.gunBasePosition),this.gunModel.rotation.copy(this.gunBaseRotation),this.gunRecoil>.005){const s=Math.pow(.88,t);this.gunRecoil*=s;const i=.1*this.gunRecoil,e=.04*this.gunRecoil,n=.15*this.gunRecoil;this.gunModel.position.z+=i,this.gunModel.position.y+=e,this.gunModel.rotation.x-=n}else this.gunRecoil=0;if(this.isReloading){this.reloadAnimProgress+=.02*t;const s=this.reloadAnimProgress%1;s<.3?this.gunModel.rotation.z+=1*s:s<.7?this.gunModel.position.y-=.1*(s-.3):this.gunModel.rotation.z+=1*(1-s)}if(this.isSwitchingWeapon&&this.switchAnimProgress<1){this.switchAnimProgress+=.05*t;const s=.3*Math.sin(this.switchAnimProgress*Math.PI);this.gunModel.position.y-=s}const s=Math.pow(.9,t);this.screenShake*=s,this.updateCrosshair()}animate(){requestAnimationFrame(()=>this.animate());const t=performance.now();if(this.fpsFrameCount++,t-this.fpsLastTime>=1e3){this.currentFPS=this.fpsFrameCount,this.fpsFrameCount=0,this.fpsLastTime=t;const s=document.getElementById("fps-text");s&&(s.textContent=`FPS: ${this.currentFPS}`)}this.processMouseMovement();const s=(t-this.lastFrameTime)/1e3;this.lastFrameTime=t;const i=Math.min(s,.1);if(this.update(i),this.minimap&&this.minimap.update(),this.fpsFrameCount%5==0&&this.checkCrosshairTarget(),this.c4Planted&&this.c4Model){const s=this.c4Position&&this.getC4RemainingTime&&this.getC4RemainingTime()<=10?200:500,i=Math.floor(t/s)%2==0;if(this.c4Light&&(this.c4Light.material.color.setHex(i?16711680:3342336),this.c4Light.material.emissive=this.c4Light.material.color),this.c4Glow){const s=.15*Math.sin(t/300)+.25;this.c4Glow.material.opacity=s,this.c4Glow.scale.set(1+.5*s,1+.5*s,1)}if(this.c4Beam){this.c4Beam.rotation.y+=.02;const s=.05*Math.sin(t/400)+.12;this.c4Beam.material.opacity=s}}let e=0,n=0,o=0,h=0;this.screenShake>.001&&(e=(Math.random()-.5)*this.screenShake*2,n=(Math.random()-.5)*this.screenShake*1.5,o=(Math.random()-.5)*this.screenShake*.02,h=(Math.random()-.5)*this.screenShake*.015,this.camera.position.x+=e,this.camera.position.y+=n,this.camera.rotation.x+=o,this.camera.rotation.y+=h),this.renderer.render(this.scene,this.camera),this.screenShake>.001&&(this.camera.position.x-=e,this.camera.position.y-=n,this.camera.rotation.x-=o,this.camera.rotation.y-=h)}}const game=new PixelCS3D;!function(){if(!(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)||"ontouchstart"in window||navigator.maxTouchPoints>0||document.fullscreenElement)){const t=()=>{const s=document.documentElement;s.requestFullscreen&&!document.fullscreenElement&&s.requestFullscreen().catch(()=>{}),document.removeEventListener("click",t)};setTimeout(()=>{document.addEventListener("click",t,{once:!0})},500)}}();