class MapEditor{constructor(){this.scene=null,this.camera=null,this.renderer=null,this.objects=[],this.selectedObject=null,this.gridHelper=null,this.placementPreview=null,this.currentTool=null,this.cameraDistance=200,this.cameraAngleX=-.5,this.cameraAngleY=.5,this.cameraTarget=new THREE.Vector3(0,0,0),this.isRightMouseDown=0,this.lastMouseX=0,this.lastMouseY=0,this.isLeftMouseDown=0,this.lastPlacedPosition=null,this.isEraserMode=0,this.undoHistory=[],this.maxUndoSteps=50,this.isTestMode=0,this.testYaw=0,this.testPitch=0,this.savedCameraState=null,this.keys={},this.raycaster=new THREE.Raycaster,this.mouse=new THREE.Vector2,this.groundPlane=new THREE.Plane(new THREE.Vector3(0,1,0),0),this.textures={},this.objectTypes={floor:{w:40,h:1,d:40,color:12887412,collision:0,textureType:"floor"},wall:{w:40,h:20,d:2,color:9807270,collision:1,textureType:"brick"},roof:{w:40,h:1,d:40,color:9127187,collision:0,textureType:"concrete",isRoof:1},box:{w:8,h:8,d:8,color:5921370,collision:1,textureType:"metal"},crate:{w:10,h:10,d:10,color:10506797,collision:1,textureType:"wood"},door:{w:8,h:16,d:2,color:6114871,collision:1,textureType:"wood"},bombsite_a:{w:40,h:.5,d:40,color:15158332,collision:0,transparent:1},bombsite_b:{w:40,h:.5,d:40,color:3447003,collision:0,transparent:1},spawn_ct:{w:3,h:15,d:3,color:2719929,collision:0},spawn_t:{w:3,h:15,d:3,color:12597547,collision:0}},this.initTextures(),this.init()}initTextures(){this.textures={wood:this.createWoodTexture(),brick:this.createBrickTexture(),concrete:this.createConcreteTexture(),metal:this.createMetalTexture(),floor:this.createFloorTexture()}}createFloorTexture(t="#c4a574",s="#a68b5b"){const e=document.createElement("canvas");e.width=64,e.height=64;const i=e.getContext("2d");i.fillStyle=t,i.fillRect(0,0,64,64),i.fillStyle=s;for(let t=0;t<4;t++)for(let s=0;s<4;s++)(t+s)%2==0&&i.fillRect(16*t,16*s,16,16);for(let t=0;t<150;t++){const t=64*Math.random(),s=64*Math.random(),e=.08*Math.random();i.fillStyle=`rgba(0,0,0,${e})`,i.fillRect(t,s,1,1)}for(let t=0;t<80;t++){const t=64*Math.random(),s=64*Math.random(),e=.06*Math.random();i.fillStyle=`rgba(255,255,255,${e})`,i.fillRect(t,s,1,1)}const o=new THREE.CanvasTexture(e);return o.wrapS=THREE.RepeatWrapping,o.wrapT=THREE.RepeatWrapping,o.repeat.set(6,6),o}createWoodTexture(t=10506797){const s=document.createElement("canvas");s.width=64,s.height=64;const e=s.getContext("2d"),i=t>>16&255,o=t>>8&255,h=255&t;e.fillStyle=`rgb(${i},${o},${h})`,e.fillRect(0,0,64,64),e.strokeStyle=`rgba(${Math.floor(.7*i)},${Math.floor(.7*o)},${Math.floor(.7*h)}, 0.4)`,e.lineWidth=1;for(let t=0;t<20;t++){const s=3*t+2*Math.random();e.beginPath(),e.moveTo(0,s);for(let t=0;t<64;t+=5)e.lineTo(t,s+2*(Math.random()-.5));e.stroke()}e.strokeStyle="rgba(0,0,0,0.3)",e.lineWidth=2,e.strokeRect(2,2,60,60),e.fillStyle="rgba(80,80,80,0.8)",e.beginPath(),e.arc(8,8,2,0,2*Math.PI),e.fill(),e.beginPath(),e.arc(56,8,2,0,2*Math.PI),e.fill(),e.beginPath(),e.arc(8,56,2,0,2*Math.PI),e.fill(),e.beginPath(),e.arc(56,56,2,0,2*Math.PI),e.fill();const a=new THREE.CanvasTexture(s);return a.wrapS=THREE.RepeatWrapping,a.wrapT=THREE.RepeatWrapping,a.repeat.set(2,2),a}createBrickTexture(t=9807270){const s=document.createElement("canvas");s.width=128,s.height=128;const e=s.getContext("2d"),i=t>>16&255,o=t>>8&255,h=255&t;e.fillStyle=`rgb(${Math.floor(.7*i)},${Math.floor(.7*o)},${Math.floor(.7*h)})`,e.fillRect(0,0,128,128);for(let t=0;t<8;t++){const s=t%2*16;for(let a=-1;a<5;a++){const n=32*a+s,c=16*t,r=30*(Math.random()-.5),l=Math.min(255,Math.max(0,i+r)),d=Math.min(255,Math.max(0,o+.8*r)),u=Math.min(255,Math.max(0,h+.6*r));e.fillStyle=`rgb(${Math.floor(l)},${Math.floor(d)},${Math.floor(u)})`,e.fillRect(n+2,c+2,28,12),e.fillStyle="rgba(255,255,255,0.1)",e.fillRect(n+2,c+2,28,2),e.fillStyle="rgba(0,0,0,0.15)",e.fillRect(n+2,c+16-2-2,28,2)}}e.fillStyle="rgba(0,0,0,0.05)";for(let t=0;t<20;t++){const t=128*Math.random(),s=128*Math.random(),i=8*Math.random()+2;e.beginPath(),e.arc(t,s,i,0,2*Math.PI),e.fill()}const a=new THREE.CanvasTexture(s);return a.wrapS=THREE.RepeatWrapping,a.wrapT=THREE.RepeatWrapping,a.repeat.set(4,4),a}createConcreteTexture(t=8421504){const s=document.createElement("canvas");s.width=64,s.height=64;const e=s.getContext("2d"),i=t>>16&255,o=t>>8&255,h=255&t;e.fillStyle=`rgb(${i},${o},${h})`,e.fillRect(0,0,64,64);for(let t=0;t<500;t++){const t=64*Math.random(),s=64*Math.random(),a=40*Math.random()-20,n=Math.min(255,Math.max(0,i+a)),c=Math.min(255,Math.max(0,o+a)),r=Math.min(255,Math.max(0,h+a));e.fillStyle=`rgb(${Math.floor(n)},${Math.floor(c)},${Math.floor(r)})`,e.fillRect(t,s,1,1)}e.strokeStyle="rgba(0,0,0,0.2)",e.lineWidth=1;for(let t=0;t<3;t++){e.beginPath();let t=64*Math.random(),s=64*Math.random();e.moveTo(t,s);for(let i=0;i<5;i++)t+=15*(Math.random()-.5),s+=10*Math.random(),e.lineTo(t,s);e.stroke()}e.fillStyle="rgba(0,0,0,0.08)";for(let t=0;t<5;t++){const t=64*Math.random(),s=64*Math.random(),i=15*Math.random()+5,o=20*Math.random()+10;e.beginPath(),e.ellipse(t,s,i,o,0,0,2*Math.PI),e.fill()}const a=new THREE.CanvasTexture(s);return a.wrapS=THREE.RepeatWrapping,a.wrapT=THREE.RepeatWrapping,a.repeat.set(6,6),a}createMetalTexture(t=5921370){const s=document.createElement("canvas");s.width=64,s.height=64;const e=s.getContext("2d"),i=t>>16&255,o=t>>8&255,h=255&t;e.fillStyle=`rgb(${i},${o},${h})`,e.fillRect(0,0,64,64);for(let t=0;t<8;t++){const s=8*t;e.fillStyle="rgba(255,255,255,0.1)",e.fillRect(0,s,64,2),e.fillStyle="rgba(0,0,0,0.1)",e.fillRect(0,s+4,64,2)}e.fillStyle="rgba(0,0,0,0.3)";for(let t=0;t<4;t++)for(let s=0;s<4;s++)e.beginPath(),e.arc(8+16*t,8+16*s,2,0,2*Math.PI),e.fill();e.fillStyle="rgba(139, 69, 19, 0.2)";for(let t=0;t<8;t++){const t=64*Math.random(),s=64*Math.random(),i=6*Math.random()+2;e.beginPath(),e.arc(t,s,i,0,2*Math.PI),e.fill()}const a=new THREE.CanvasTexture(s);return a.wrapS=THREE.RepeatWrapping,a.wrapT=THREE.RepeatWrapping,a.repeat.set(4,4),a}createWoodDoorTexture(){const t=document.createElement("canvas");t.width=64,t.height=128;const s=t.getContext("2d");return s.fillStyle="#5D4037",s.fillRect(0,0,64,128),s.strokeStyle="#3E2723",s.lineWidth=4,s.strokeRect(4,4,56,120),s.fillStyle="#4E342E",s.fillRect(8,8,48,50),s.fillRect(8,70,48,50),s.fillStyle="#FFD700",s.beginPath(),s.arc(52,70,4,0,2*Math.PI),s.fill(),new THREE.CanvasTexture(t)}createBarrelTexture(){const t=document.createElement("canvas");t.width=64,t.height=64;const s=t.getContext("2d");s.fillStyle="#2C3E50",s.fillRect(0,0,64,64),s.fillStyle="#1a252f",s.fillRect(0,0,64,6),s.fillRect(0,28,64,8),s.fillRect(0,58,64,6),s.fillStyle="#F39C12",s.fillRect(20,12,24,14),s.fillStyle="#000",s.font="bold 10px Arial",s.fillText("!",29,23),s.fillStyle="rgba(139, 69, 19, 0.3)";for(let t=0;t<5;t++)s.beginPath(),s.arc(64*Math.random(),64*Math.random(),8*Math.random()+2,0,2*Math.PI),s.fill();const e=new THREE.CanvasTexture(t);return e.wrapS=THREE.RepeatWrapping,e.wrapT=THREE.RepeatWrapping,e}createSandbagTexture(){const t=document.createElement("canvas");t.width=64,t.height=64;const s=t.getContext("2d");s.fillStyle="#C9B896",s.fillRect(0,0,64,64),s.strokeStyle="#A89878",s.lineWidth=1;for(let t=0;t<32;t++)s.beginPath(),s.moveTo(2*t,0),s.lineTo(2*t,64),s.stroke(),s.beginPath(),s.moveTo(0,2*t),s.lineTo(64,2*t),s.stroke();s.fillStyle="rgba(0,0,0,0.1)";for(let t=0;t<3;t++)s.beginPath(),s.ellipse(64*Math.random(),64*Math.random(),15,5,Math.random()*Math.PI,0,2*Math.PI),s.fill();const e=new THREE.CanvasTexture(t);return e.wrapS=THREE.RepeatWrapping,e.wrapT=THREE.RepeatWrapping,e}createGraffitiTexture(){const t=document.createElement("canvas");t.width=128,t.height=128;const s=t.getContext("2d");s.fillStyle="#808080",s.fillRect(0,0,128,128);const e=["#E74C3C","#3498DB","#2ECC71","#F39C12","#9B59B6"];for(let t=0;t<3;t++)s.fillStyle=e[Math.floor(Math.random()*e.length)],s.font=`bold ${20+20*Math.random()}px Arial`,s.save(),s.translate(64,64),s.rotate(.5*Math.random()-.25),s.fillText(["CS","GO","!","AWP","GG"][t],-20,40*Math.random()-20),s.restore();for(let t=0;t<50;t++)s.fillStyle=e[Math.floor(Math.random()*e.length)],s.beginPath(),s.arc(128*Math.random(),128*Math.random(),3*Math.random(),0,2*Math.PI),s.fill();return new THREE.CanvasTexture(t)}init(){this.initThree(),this.initGrid(),this.initLights(),this.initEvents(),this.animate()}initThree(){const t=document.getElementById("canvas");this.scene=new THREE.Scene,this.scene.background=new THREE.Color(1710638),this.camera=new THREE.PerspectiveCamera(60,window.innerWidth/window.innerHeight,1,2e3),this.updateCameraPosition(),this.renderer=new THREE.WebGLRenderer({canvas:t,antialias:1}),this.renderer.setSize(t.parentElement.clientWidth,t.parentElement.clientHeight),this.renderer.shadowMap.enabled=1,window.addEventListener("resize",()=>{const s=t.parentElement;this.camera.aspect=s.clientWidth/s.clientHeight,this.camera.updateProjectionMatrix(),this.renderer.setSize(s.clientWidth,s.clientHeight)})}initGrid(){const t=300;this.gridHelper=new THREE.GridHelper(600,60,8947814,7829333),this.gridHelper.material.opacity=.3,this.gridHelper.material.transparent=1,this.scene.add(this.gridHelper);const s=new THREE.PlaneGeometry(600,600),e=this.createFloorTexture();e.repeat.set(60,60);const i=new THREE.MeshLambertMaterial({map:e}),o=new THREE.Mesh(s,i);o.rotation.x=-Math.PI/2,o.position.y=-.1,o.receiveShadow=1,o.userData.isGround=1,this.scene.add(o),this.ground=o;const h=new THREE.LineBasicMaterial({color:15287648}),a=(new THREE.BufferGeometry).setFromPoints([new THREE.Vector3(-300,0,-300),new THREE.Vector3(t,0,-300),new THREE.Vector3(t,0,t),new THREE.Vector3(-300,0,t),new THREE.Vector3(-300,0,-300)]),n=new THREE.Line(a,h);this.scene.add(n),this.border=n}initLights(){const t=new THREE.AmbientLight(16777215,.5);this.scene.add(t);const s=new THREE.DirectionalLight(16777215,.8);s.position.set(100,200,100),s.castShadow=1,s.shadow.mapSize.width=2048,s.shadow.mapSize.height=2048,s.shadow.camera.near=10,s.shadow.camera.far=500,s.shadow.camera.left=-200,s.shadow.camera.right=200,s.shadow.camera.top=200,s.shadow.camera.bottom=-200,this.scene.add(s)}initEvents(){const t=document.getElementById("canvas");t.addEventListener("mousedown",t=>this.onMouseDown(t)),t.addEventListener("mouseup",t=>this.onMouseUp(t)),t.addEventListener("mousemove",t=>this.onMouseMove(t)),t.addEventListener("wheel",t=>this.onWheel(t)),t.addEventListener("contextmenu",t=>t.preventDefault()),document.addEventListener("mousemove",t=>this.onTestMouseMove(t)),document.addEventListener("pointerlockchange",()=>{!document.pointerLockElement&&this.isTestMode&&this.testView()}),document.addEventListener("keydown",t=>this.onKeyDown(t)),document.addEventListener("keyup",t=>this.onKeyUp(t)),document.querySelectorAll(".object-item").forEach(t=>{t.addEventListener("dragstart",t=>{this.isEraserMode&&this.toggleEraserMode(),this.currentTool=t.target.dataset.type,this.createPlacementPreview(this.currentTool)}),t.addEventListener("dragend",()=>{this.removePlacementPreview(),this.currentTool=null}),t.addEventListener("click",()=>{this.isEraserMode&&this.toggleEraserMode(),this.currentTool=t.dataset.type,this.createPlacementPreview(this.currentTool)})}),t.addEventListener("dragover",t=>t.preventDefault()),t.addEventListener("drop",t=>{if(t.preventDefault(),this.currentTool){const s=this.getGroundPosition(t);s&&this.placeObject(this.currentTool,s)}this.removePlacementPreview(),this.currentTool=null}),document.getElementById("newMap").addEventListener("click",()=>this.newMap()),document.getElementById("saveMap").addEventListener("click",()=>this.saveMapAsJson()),document.getElementById("exportCode").addEventListener("click",()=>this.exportCode()),document.getElementById("loadMap").addEventListener("click",()=>this.loadMap()),document.getElementById("loadPreset").addEventListener("click",()=>this.showPresetModal()),document.getElementById("testMap").addEventListener("click",()=>this.testView()),document.getElementById("addWalls").addEventListener("click",()=>this.addBorderWalls()),document.getElementById("rotateMap90").addEventListener("click",()=>this.rotateMapBy90()),document.getElementById("eraserTool").addEventListener("click",()=>this.toggleEraserMode()),document.getElementById("undoBtn").addEventListener("click",()=>this.undo()),document.querySelectorAll(".preset-item").forEach(t=>{t.addEventListener("click",()=>{const s=t.dataset.map;this.loadPresetMap(s),this.closePresetModal()})}),document.getElementById("close-preset-modal").addEventListener("click",()=>this.closePresetModal()),document.getElementById("prop-x").addEventListener("change",t=>this.updateSelectedProperty("x",parseFloat(t.target.value))),document.getElementById("prop-y").addEventListener("change",t=>this.updateSelectedProperty("y",parseFloat(t.target.value))),document.getElementById("prop-z").addEventListener("change",t=>this.updateSelectedProperty("z",parseFloat(t.target.value))),document.getElementById("prop-w").addEventListener("change",t=>this.updateSelectedProperty("w",parseFloat(t.target.value))),document.getElementById("prop-h").addEventListener("change",t=>this.updateSelectedProperty("h",parseFloat(t.target.value))),document.getElementById("prop-d").addEventListener("change",t=>this.updateSelectedProperty("d",parseFloat(t.target.value))),document.getElementById("prop-ry").addEventListener("change",t=>this.updateSelectedProperty("ry",parseFloat(t.target.value))),document.getElementById("prop-color").addEventListener("change",t=>this.updateSelectedProperty("color",t.target.value)),document.getElementById("delete-obj").addEventListener("click",()=>this.deleteSelected()),document.getElementById("duplicate-obj").addEventListener("click",()=>this.duplicateSelected()),this.setupInputWheelAdjust(),document.getElementById("copy-code").addEventListener("click",()=>this.copyCode()),document.getElementById("close-modal").addEventListener("click",()=>this.closeModal()),document.getElementById("cloudSave").addEventListener("click",()=>this.showCloudSaveModal()),document.getElementById("cloudLoad").addEventListener("click",()=>this.showCloudModal()),document.getElementById("cloud-refresh").addEventListener("click",()=>this.loadCloudMapList()),document.getElementById("close-cloud-modal").addEventListener("click",()=>this.closeCloudModal()),document.getElementById("confirm-cloud-save").addEventListener("click",()=>this.confirmCloudSave()),document.getElementById("close-cloud-save-modal").addEventListener("click",()=>this.closeCloudSaveModal()),document.getElementById("mapSize").addEventListener("change",t=>this.updateMapSize(parseInt(t.target.value)||300))}updateMapSize(t){this.scene.remove(this.gridHelper);const s=Math.floor(t/10);this.gridHelper=new THREE.GridHelper(2*t,2*s,8947814,7829333),this.gridHelper.material.opacity=.3,this.gridHelper.material.transparent=1,this.scene.add(this.gridHelper),this.scene.remove(this.ground);const e=new THREE.PlaneGeometry(2*t,2*t),i=this.createFloorTexture();i.repeat.set(t/5,t/5);const o=new THREE.MeshLambertMaterial({map:i});this.ground=new THREE.Mesh(e,o),this.ground.rotation.x=-Math.PI/2,this.ground.position.y=-.1,this.ground.receiveShadow=1,this.ground.userData.isGround=1,this.scene.add(this.ground),this.scene.remove(this.border);const h=new THREE.LineBasicMaterial({color:15287648}),a=(new THREE.BufferGeometry).setFromPoints([new THREE.Vector3(-t,0,-t),new THREE.Vector3(t,0,-t),new THREE.Vector3(t,0,t),new THREE.Vector3(-t,0,t),new THREE.Vector3(-t,0,-t)]);this.border=new THREE.Line(a,h),this.scene.add(this.border)}onMouseDown(t){if(2===t.button)this.isRightMouseDown=1,this.lastMouseX=t.clientX,this.lastMouseY=t.clientY;else if(0===t.button)if(this.isLeftMouseDown=1,this.isEraserMode)this.eraseObjectAt(t);else if(this.currentTool){const s=this.getGroundPosition(t);s&&(this.placeObject(this.currentTool,s),this.lastPlacedPosition=this.snapToGrid(s))}else this.selectObjectAt(t)}onMouseUp(t){2===t.button&&(this.isRightMouseDown=0),0===t.button&&(this.isLeftMouseDown=0,this.lastPlacedPosition=null)}onMouseMove(t){const s=this.getGroundPosition(t);if(s){if(document.getElementById("coords").textContent=`X: ${Math.round(s.x)}, Y: ${Math.round(s.y)}, Z: ${Math.round(s.z)}`,this.placementPreview&&this.currentTool){const t=this.objectTypes[this.currentTool],e=this.snapToGrid(s);this.placementPreview.position.copy(e);const i=t.isRamp?0:t.h/2;this.placementPreview.position.y=i,this.placementPreview.material.color.setHex(t.color),this.placementPreview.material.opacity=.5}if(this.isLeftMouseDown&&this.isEraserMode)this.eraseObjectAt(t);else if(this.isLeftMouseDown&&this.currentTool){const t=this.snapToGrid(s);this.lastPlacedPosition&&t.x===this.lastPlacedPosition.x&&t.z===this.lastPlacedPosition.z||(this.placeObject(this.currentTool,s),this.lastPlacedPosition=t)}}if(this.isRightMouseDown){const s=t.clientX-this.lastMouseX,e=t.clientY-this.lastMouseY;this.cameraAngleY-=.005*s,this.cameraAngleX=Math.max(-1.5,Math.min(-.1,this.cameraAngleX-.005*e)),this.updateCameraPosition(),this.lastMouseX=t.clientX,this.lastMouseY=t.clientY}}onWheel(t){t.preventDefault(),this.cameraDistance=Math.max(50,Math.min(500,this.cameraDistance+.5*t.deltaY)),this.updateCameraPosition()}onKeyDown(t){if(this.keys[t.code]=1,"Delete"!==t.code&&"Backspace"!==t.code||this.deleteSelected(),"KeyR"===t.code&&(this.placementPreview?this.rotatePlacementPreview():this.selectedObject&&this.rotateSelected()),"Escape"===t.code&&(this.deselectObject(),this.clearCurrentTool(),this.isEraserMode&&this.toggleEraserMode()),"KeyZ"===t.code&&(t.ctrlKey||t.metaKey)&&(t.preventDefault(),this.undo()),this.selectedObject&&!this.isTestMode){const s=t.shiftKey?5:1;let e=0;"ArrowUp"===t.code&&(this.selectedObject.position.z-=s,e=1),"ArrowDown"===t.code&&(this.selectedObject.position.z+=s,e=1),"ArrowLeft"===t.code&&(this.selectedObject.position.x-=s,e=1),"ArrowRight"===t.code&&(this.selectedObject.position.x+=s,e=1),"PageUp"===t.code&&(this.selectedObject.position.y+=s,e=1),"PageDown"===t.code&&(this.selectedObject.position.y=Math.max(0,this.selectedObject.position.y-s),e=1),e&&(t.preventDefault(),this.selectedObject.userData.x=this.selectedObject.position.x,this.selectedObject.userData.y=this.selectedObject.position.y,this.selectedObject.userData.z=this.selectedObject.position.z,this.updatePropertyPanel())}}onKeyUp(t){this.keys[t.code]=0}updateCameraPosition(){const t=this.cameraTarget.x+this.cameraDistance*Math.cos(this.cameraAngleX)*Math.sin(this.cameraAngleY),s=this.cameraTarget.y+this.cameraDistance*Math.sin(-this.cameraAngleX),e=this.cameraTarget.z+this.cameraDistance*Math.cos(this.cameraAngleX)*Math.cos(this.cameraAngleY);this.camera.position.set(t,s,e),this.camera.lookAt(this.cameraTarget)}getGroundPosition(t){const s=document.getElementById("canvas").getBoundingClientRect();this.mouse.x=(t.clientX-s.left)/s.width*2-1,this.mouse.y=-(t.clientY-s.top)/s.height*2+1,this.raycaster.setFromCamera(this.mouse,this.camera);const e=new THREE.Vector3;return this.raycaster.ray.intersectPlane(this.groundPlane,e)?e:null}snapToGrid(t,s=2){return new THREE.Vector3(Math.round(t.x/s)*s,0,Math.round(t.z/s)*s)}createPlacementPreview(t){this.removePlacementPreview();const s=this.objectTypes[t];if(!s)return;const e=this.createObjectMesh(t,s,1);e.material.opacity=.5,e.material.transparent=1,this.scene.add(e),this.placementPreview=e}removePlacementPreview(){this.placementPreview&&(this.scene.remove(this.placementPreview),this.placementPreview=null)}clearCurrentTool(){this.removePlacementPreview(),this.currentTool=null}createObjectMesh(t,s,e=0){let i,o,h;if(s.isCylinder)i=new THREE.CylinderGeometry(s.w/2,s.w/2,s.h,16);else if(s.isRamp){const t=new THREE.Shape;t.moveTo(0,0),t.lineTo(s.d,0),t.lineTo(s.d,s.h),t.lineTo(0,0);const e={depth:s.w,bevelEnabled:0};i=new THREE.ExtrudeGeometry(t,e),i.rotateY(Math.PI/2),i.translate(-s.w/2,0,-s.d/2)}else i=new THREE.BoxGeometry(s.w,s.h,s.d);const a=s.textureType;if(a&&!e){let t;if("floor"===a){const e=s.color>>16&255,i=s.color>>8&255,o=255&s.color,h=`rgb(${e},${i},${o})`,a=`rgb(${Math.floor(.87*e)},${Math.floor(.87*i)},${Math.floor(.87*o)})`;t=this.createFloorTexture(h,a),t.repeat.set(s.w/8,s.d/8)}else this.textures[a]&&(t=this.textures[a].clone(),t.needsUpdate=1,"brick"===a||"concrete"===a?t.repeat.set(s.w/20,s.h/10):"wood"===a&&t.repeat.set(s.w/10,s.d/10));t&&(o=new THREE.MeshLambertMaterial({map:t,transparent:s.transparent||0,opacity:s.transparent?.4:1}))}if(o||(o=new THREE.MeshLambertMaterial({color:s.color,transparent:s.transparent||0,opacity:s.transparent?.4:1})),h=new THREE.Mesh(i,o),s.isRamp?h.position.y=0:h.position.y=s.h/2,h.castShadow=1,h.receiveShadow=1,h.userData={type:t,w:s.w,h:s.h,d:s.d,color:s.color,collision:s.collision,isRamp:s.isRamp||0,isCylinder:s.isCylinder||0,isLight:s.isLight||0,textureType:a},s.isLight&&!e){const t=new THREE.PointLight(15844367,1,50);t.position.set(0,0,0),h.add(t)}return h}placeObject(t,s){const e=this.objectTypes[t];if(!e)return;let i=this.snapToGrid(s),o=e.isRamp?0:e.h/2;const h=this.checkOverlapAndFindY(i,e,t);h.hasOverlap&&h.canStack&&(o=h.stackY+(e.isRamp?0:e.h/2));const a=this.createObjectMesh(t,e);a.position.x=i.x,a.position.z=i.z,a.position.y=o,this.placementPreview&&(a.rotation.y=this.placementPreview.rotation.y),this.scene.add(a),this.objects.push(a),this.addToHistory({action:"add",mesh:a,data:this.serializeMesh(a)})}checkOverlapAndFindY(t,s,e){const i=t.x-s.w/2,o=t.x+s.w/2,h=t.z-s.d/2,a=t.z+s.d/2,n=.1;let c=0,r=0,l=0;for(const t of this.objects){const s=t.userData;let d=s.w,u=s.d;const p=t.rotation.y;90===Math.abs(Math.round(THREE.MathUtils.radToDeg(p))%180)&&(d=s.d,u=s.w);const m=t.position.x-d/2,M=t.position.x+d/2,w=t.position.z-u/2,E=t.position.z+u/2;if(i<M-n&&o>m+n&&h<E-n&&a>w+n){const i="floor"===e,o="floor"===s.type;if(i&&o)return{hasOverlap:1,canStack:0,stackY:0};if(!i&&o)continue;if(!i&&!o){c=1,l=1;const e=t.position.y+s.h/2;e>r&&(r=e)}}}return{hasOverlap:c,canStack:l,stackY:r}}checkOverlap(t,s,e){const i=this.checkOverlapAndFindY(t,s,e);return i.hasOverlap&&!i.canStack}serializeMesh(t){return{type:t.userData.type,x:t.position.x,y:t.position.y,z:t.position.z,ry:t.rotation.y,w:t.userData.w,h:t.userData.h,d:t.userData.d,color:t.userData.color}}addToHistory(t){this.undoHistory.push(t),this.undoHistory.length>this.maxUndoSteps&&this.undoHistory.shift()}undo(){if(0===this.undoHistory.length)return;const t=this.undoHistory.pop();if("add"===t.action){const s=this.objects.indexOf(t.mesh);s>-1&&(this.objects.splice(s,1),this.scene.remove(t.mesh),this.selectedObject===t.mesh&&this.deselectObject())}else if("delete"===t.action){const s=t.data,e={w:s.w,h:s.h,d:s.d,color:s.color,collision:this.objectTypes[s.type]?.collision,isRamp:this.objectTypes[s.type]?.isRamp,isCylinder:this.objectTypes[s.type]?.isCylinder,isLight:this.objectTypes[s.type]?.isLight,textureType:this.objectTypes[s.type]?.textureType,transparent:this.objectTypes[s.type]?.transparent},i=this.createObjectMesh(s.type,e);i.position.set(s.x,s.y,s.z),i.rotation.y=s.ry||0,this.scene.add(i),this.objects.push(i)}}toggleEraserMode(){this.isEraserMode=!this.isEraserMode;const t=document.getElementById("eraserTool");this.isEraserMode?(t.classList.add("active"),t.style.background="#e74c3c",this.currentTool=null,this.removePlacementPreview(),document.getElementById("canvas").style.cursor="crosshair"):(t.classList.remove("active"),t.style.background="",document.getElementById("canvas").style.cursor="default")}eraseObjectAt(t){const s=document.getElementById("canvas").getBoundingClientRect();this.mouse.x=(t.clientX-s.left)/s.width*2-1,this.mouse.y=-(t.clientY-s.top)/s.height*2+1,this.raycaster.setFromCamera(this.mouse,this.camera);const e=this.raycaster.intersectObjects(this.objects);if(e.length>0){const t=e[0].object;this.addToHistory({action:"delete",data:this.serializeMesh(t)});const s=this.objects.indexOf(t);s>-1&&this.objects.splice(s,1),this.scene.remove(t),this.selectedObject===t&&this.deselectObject()}}selectObjectAt(t){const s=document.getElementById("canvas").getBoundingClientRect();this.mouse.x=(t.clientX-s.left)/s.width*2-1,this.mouse.y=-(t.clientY-s.top)/s.height*2+1,this.raycaster.setFromCamera(this.mouse,this.camera);const e=this.raycaster.intersectObjects(this.objects);e.length>0?this.selectObject(e[0].object):this.deselectObject()}selectObject(t){this.deselectObject(),this.selectedObject=t,void 0===t.userData.originalColor&&(t.userData.originalColor=t.material.color.getHex()),t.material.emissive=new THREE.Color(4473924),document.getElementById("no-selection").style.display="none",document.getElementById("prop-panel").style.display="block",document.getElementById("prop-type").textContent=this.getTypeName(t.userData.type),document.getElementById("prop-x").value=Math.round(t.position.x),document.getElementById("prop-y").value=Math.round(t.position.y-t.userData.h/2),document.getElementById("prop-z").value=Math.round(t.position.z),document.getElementById("prop-w").value=t.userData.w,document.getElementById("prop-h").value=t.userData.h,document.getElementById("prop-d").value=t.userData.d,document.getElementById("prop-ry").value=Math.round(THREE.MathUtils.radToDeg(t.rotation.y)),document.getElementById("prop-color").value="#"+t.userData.color.toString(16).padStart(6,"0")}deselectObject(){this.selectedObject&&(this.selectedObject.material.emissive=new THREE.Color(0),this.selectedObject=null),document.getElementById("no-selection").style.display="block",document.getElementById("prop-panel").style.display="none"}updatePropertyPanel(){if(!this.selectedObject)return;const t=this.selectedObject;document.getElementById("prop-x").value=Math.round(t.position.x),document.getElementById("prop-y").value=Math.round(t.position.y-t.userData.h/2),document.getElementById("prop-z").value=Math.round(t.position.z)}setupInputWheelAdjust(){[{id:"prop-x",prop:"x",step:1},{id:"prop-y",prop:"y",step:1},{id:"prop-z",prop:"z",step:1},{id:"prop-w",prop:"w",step:1},{id:"prop-h",prop:"h",step:1},{id:"prop-d",prop:"d",step:1},{id:"prop-ry",prop:"ry",step:5}].forEach(({id:t,prop:s,step:e})=>{const i=document.getElementById(t);i&&i.addEventListener("wheel",t=>{if(!this.selectedObject)return;t.preventDefault();const o=t.deltaY>0?-e:e,h=(parseFloat(i.value)||0)+o;i.value=h,this.updateSelectedProperty(s,h)})})}updateSelectedProperty(t,s){if(!this.selectedObject)return;const e=this.selectedObject;switch(t){case"x":e.position.x=s;break;case"y":e.position.y=s+e.userData.h/2;break;case"z":e.position.z=s;break;case"w":case"h":case"d":e.userData[t]=s,this.rebuildMesh(e);break;case"ry":e.rotation.y=THREE.MathUtils.degToRad(s);break;case"color":const i=parseInt(s.replace("#",""),16);e.material.color.setHex(i),e.userData.color=i}}rebuildMesh(t){const s=t.userData;let e;if(s.isCylinder)e=new THREE.CylinderGeometry(s.w/2,s.w/2,s.h,16);else if(s.isRamp){const t=new THREE.Shape;t.moveTo(0,0),t.lineTo(s.d,0),t.lineTo(s.d,s.h),t.lineTo(0,0);const i={depth:s.w,bevelEnabled:0};e=new THREE.ExtrudeGeometry(t,i),e.rotateY(Math.PI/2),e.translate(-s.w/2,0,-s.d/2)}else e=new THREE.BoxGeometry(s.w,s.h,s.d);t.geometry.dispose(),t.geometry=e,t.position.y=s.h/2}deleteSelected(){if(!this.selectedObject)return;this.addToHistory({action:"delete",data:this.serializeMesh(this.selectedObject)});const t=this.objects.indexOf(this.selectedObject);t>-1&&this.objects.splice(t,1),this.scene.remove(this.selectedObject),this.selectedObject=null,document.getElementById("no-selection").style.display="block",document.getElementById("prop-panel").style.display="none"}duplicateSelected(){if(!this.selectedObject)return;const t=this.selectedObject,s=t.userData,e={w:s.w,h:s.h,d:s.d,color:s.color,collision:s.collision,isRamp:s.isRamp,isCylinder:s.isCylinder,isLight:s.isLight},i=this.createObjectMesh(s.type,e);i.position.copy(t.position),i.position.x+=10,i.rotation.copy(t.rotation),this.scene.add(i),this.objects.push(i),this.selectObject(i)}rotateSelected(){this.selectedObject&&(this.selectedObject.rotation.y+=Math.PI/2,this.selectedObject.rotation.y>=2*Math.PI&&(this.selectedObject.rotation.y-=2*Math.PI),document.getElementById("prop-ry").value=Math.round(THREE.MathUtils.radToDeg(this.selectedObject.rotation.y)))}rotatePlacementPreview(){this.placementPreview&&(this.placementPreview.rotation.y+=Math.PI/2,this.placementPreview.rotation.y>=2*Math.PI&&(this.placementPreview.rotation.y-=2*Math.PI))}getTypeName(t){return{floor:"Âú∞Êùø",wall:"Â¢ôÈù¢",roof:"ÊàøÈ°∂",box:"ÁÆ±Â≠ê",crate:"Êú®ÁÆ±",door:"Èó®",bombsite_a:"AÁÇπ",bombsite_b:"BÁÇπ",spawn_ct:"CTÂ§çÊ¥ªÁÇπ",spawn_t:"TÂ§çÊ¥ªÁÇπ"}[t]||t}newMap(){this.objects.length>0&&!confirm("Á°ÆÂÆöË¶ÅÊñ∞Âª∫Âú∞ÂõæÂêóÔºüÂΩìÂâçÂú∞ÂõæÂ∞ÜË¢´Ê∏ÖÁ©∫„ÄÇ")||(this.objects.forEach(t=>this.scene.remove(t)),this.objects=[],this.deselectObject(),document.getElementById("mapName").value="custom_map")}addFullFloor(){const t=parseInt(document.getElementById("mapSize").value)||300,s=this.objectTypes.floor,e=s.w;for(let i=e/2-t;i<=t-e/2;i+=e)for(let o=e/2-t;o<=t-e/2;o+=e){const t=this.createObjectMesh("floor",s);t.position.set(i,s.h/2,o),this.scene.add(t),this.objects.push(t)}}addBorderWalls(){const t=parseInt(document.getElementById("mapSize").value)||300,s=this.objectTypes.wall,e=s.w;for(let i=e/2-t;i<=t-e/2;i+=e){const e=this.createObjectMesh("wall",s);e.position.set(i,s.h/2,-t),e.rotation.y=0,e.userData.ry=0,this.scene.add(e),this.objects.push(e);const o=this.createObjectMesh("wall",s);o.position.set(i,s.h/2,t),o.rotation.y=0,o.userData.ry=0,this.scene.add(o),this.objects.push(o)}for(let i=e/2-t;i<=t-e/2;i+=e){const e=this.createObjectMesh("wall",s);e.position.set(-t,s.h/2,i),e.rotation.y=Math.PI/2,e.userData.ry=Math.PI/2,this.scene.add(e),this.objects.push(e);const o=this.createObjectMesh("wall",s);o.position.set(t,s.h/2,i),o.rotation.y=Math.PI/2,o.userData.ry=Math.PI/2,this.scene.add(o),this.objects.push(o)}}rotateMapBy90(){0!==this.objects.length?(this.objects.forEach(t=>{const s=t.position.x,e=t.position.z;t.position.x=e,t.position.z=-s,t.rotation.y+=Math.PI/2}),this.selectedObject&&(document.getElementById("prop-x").value=Math.round(this.selectedObject.position.x),document.getElementById("prop-z").value=Math.round(this.selectedObject.position.z),document.getElementById("prop-ry").value=Math.round(THREE.MathUtils.radToDeg(this.selectedObject.rotation.y)))):alert("Âú∞Âõæ‰∏≠Ê≤°ÊúâÁâ©‰ª∂ÂèØÊóãËΩ¨")}saveMapAsJson(){const t=document.getElementById("mapName").value||"custom_map",s=document.getElementById("mapDisplayName").value||"Ëá™ÂÆö‰πâÂú∞Âõæ",e=parseInt(document.getElementById("mapSize").value)||300,i=document.getElementById("gameMode"),o=Array.from(i.selectedOptions).map(t=>t.value),h={name:t,displayName:s,gameMode:o.length>0?o:["deathmatch"],mapSize:e,floorColor1:"#c4a574",floorColor2:"#a68b5b",wallColor1:"#95a5a6",wallColor2:"#7f8c8d",skyColor:7058393,objects:[]},a=[],n=[];let c=null,r=null;this.objects.forEach(t=>{const s=t.userData,e={type:s.type,x:Math.round(t.position.x),y:Math.round(t.position.y),z:Math.round(t.position.z),w:s.w,h:s.h,d:s.d,color:s.color,textureType:s.textureType};switch(0!==t.rotation.y&&(e.rotation=parseFloat(t.rotation.y.toFixed(3))),h.objects.push(e),s.type){case"bombsite_a":c={x:e.x,z:e.z,radius:Math.max(e.w,e.d)/2};break;case"bombsite_b":r={x:e.x,z:e.z,radius:Math.max(e.w,e.d)/2};break;case"spawn_ct":a.push({x:e.x,z:e.z});break;case"spawn_t":n.push({x:e.x,z:e.z})}}),h.bombSites={},c&&(h.bombSites.A=c),r&&(h.bombSites.B=r),h.spawnPoints={ct:a,t:n};const l=JSON.stringify(h,null,2),d=new Blob([l],{type:"application/json"}),u=URL.createObjectURL(d),p=document.createElement("a");p.href=u,p.download=`${t}.json`,p.click(),URL.revokeObjectURL(u)}exportCode(){const t=document.getElementById("mapName").value||"custom_map",s=document.getElementById("mapDisplayName").value||"Ëá™ÂÆö‰πâÂú∞Âõæ",e=parseInt(document.getElementById("mapSize").value)||300,i=document.getElementById("gameMode"),o=Array.from(i.selectedOptions).map(t=>t.value),h=o.length>0?o:["deathmatch"],a=[],n=[],c=[];let r=null,l=null;this.objects.forEach(t=>{const s=t.userData,e={x:Math.round(t.position.x),z:Math.round(t.position.z),w:s.w,h:s.h,d:s.d},i=Math.round(t.position.y);switch(i!==Math.round(s.h/2)?e.y=i:e.y=Math.round(s.h/2),0!==t.rotation.y&&(e.rotation=parseFloat(t.rotation.y.toFixed(3))),"floor"!==s.type&&s.color===this.objectTypes[s.type]?.color||(e.color=s.color),s.type){case"bombsite_a":r={x:e.x,z:e.z,radius:Math.max(e.w,e.d)/2};break;case"bombsite_b":l={x:e.x,z:e.z,radius:Math.max(e.w,e.d)/2};break;case"spawn_ct":n.push({x:e.x,z:e.z});break;case"spawn_t":c.push({x:e.x,z:e.z});break;case"floor":e.textureType="floor",a.push(e);break;default:s.textureType&&(e.textureType=s.textureType),a.push(e)}});let d=`    '${t}': {\n`;d+=`        displayName: '${s}',\n`,d+=`        gameMode: [${h.map(t=>`'${t}'`).join(", ")}],\n`,d+="        floorColor1: '#c4a574',\n",d+="        floorColor2: '#a68b5b',\n",d+="        wallColor1: '#95a5a6',\n",d+="        wallColor2: '#7f8c8d',\n",d+="        skyColor: 0x6bb3d9,\n",d+=`        mapSize: ${e},\n`,d+=`        obstacles: ${this.formatObstacles(a)},\n`,h.includes("defuse")&&(r&&l&&(d+="        bombSites: {\n",d+=`            A: { x: ${r.x}, z: ${r.z}, radius: ${r.radius} },\n`,d+=`            B: { x: ${l.x}, z: ${l.z}, radius: ${l.radius} }\n`,d+="        },\n"),(n.length>0||c.length>0)&&(d+="        spawnPoints: {\n",d+=`            ct: ${this.formatSpawnPoints(n)},\n`,d+=`            t: ${this.formatSpawnPoints(c)}\n`,d+="        }\n")),d+="    }",document.getElementById("code-output").value=d,document.getElementById("code-modal").classList.add("active")}formatObstacles(t){if(0===t.length)return"[]";const s=t.map(t=>{const s=[];return s.push(`x: ${t.x}`),void 0!==t.y&&s.push(`y: ${t.y}`),s.push(`z: ${t.z}`),s.push(`w: ${t.w}`),s.push(`h: ${t.h}`),s.push(`d: ${t.d}`),void 0!==t.color&&s.push(`color: 0x${t.color.toString(16).padStart(6,"0")}`),void 0!==t.rotation&&s.push(`rotation: ${t.rotation}`),void 0!==t.textureType&&s.push(`textureType: '${t.textureType}'`),`{${s.join(", ")}}`});return s.length<=2?`[${s.join(", ")}]`:`[\n            ${s.join(",\n            ")}\n        ]`}formatSpawnPoints(t){if(0===t.length)return"[]";const s=t.map(t=>`{x: ${t.x}, z: ${t.z}}`);return s.length<=3?`[${s.join(", ")}]`:`[\n                ${s.join(",\n                ")}\n            ]`}loadMap(){const t=document.createElement("input");t.type="file",t.accept=".json",t.onchange=t=>{const s=t.target.files[0];if(!s)return;const e=new FileReader;e.onload=t=>{try{const s=JSON.parse(t.target.result);this.loadMapData(s)}catch(t){alert("Âä†ËΩΩÂú∞ÂõæÂ§±Ë¥•: "+t.message)}},e.readAsText(s)},t.click()}loadMapData(t){if(this.newMap(),t.name?document.getElementById("mapName").value=t.name:t.mapName&&(document.getElementById("mapName").value=t.mapName),t.displayName&&(document.getElementById("mapDisplayName").value=t.displayName),t.mapSize?(document.getElementById("mapSize").value=t.mapSize,this.updateMapSize(t.mapSize)):t.size&&(document.getElementById("mapSize").value=t.size,this.updateMapSize(t.size)),t.gameMode&&Array.isArray(t.gameMode)){const s=document.getElementById("gameMode");Array.from(s.options).forEach(s=>{s.selected=t.gameMode.includes(s.value)})}t.objects&&Array.isArray(t.objects)?t.objects.forEach(t=>{this.loadObjectNew(t)}):(t.walls&&t.walls.forEach(t=>this.loadObject("wall",t)),t.floors&&t.floors.forEach(t=>this.loadObject("floor",t)),t.boxes&&t.boxes.forEach(t=>this.loadObject(t.type||"box",t)),t.decorations&&t.decorations.forEach(t=>this.loadObject(t.type,t)),t.spawnsCT&&t.spawnsCT.forEach(t=>this.loadObject("spawn_ct",t)),t.spawnsT&&t.spawnsT.forEach(t=>this.loadObject("spawn_t",t)),t.bombSiteA&&this.loadObject("bombsite_a",{x:t.bombSiteA.x,z:t.bombSiteA.z,w:2*t.bombSiteA.radius,d:2*t.bombSiteA.radius}),t.bombSiteB&&this.loadObject("bombsite_b",{x:t.bombSiteB.x,z:t.bombSiteB.z,w:2*t.bombSiteB.radius,d:2*t.bombSiteB.radius}))}loadObjectNew(t){const s=t.type,e=this.objectTypes[s];if(!e)return void console.warn("Êú™Áü•Áâ©‰ª∂Á±ªÂûã:",s);const i={w:t.w||e.w,h:t.h||e.h,d:t.d||e.d,color:void 0!==t.color?t.color:e.color,collision:e.collision,isRamp:e.isRamp,isCylinder:e.isCylinder,isLight:e.isLight,transparent:e.transparent,textureType:e.textureType},o=this.createObjectMesh(s,i);o.position.x=t.x||0,o.position.z=t.z||0,void 0!==t.y?o.position.y=t.y:o.position.y=i.isRamp?0:i.h/2,void 0!==t.rotation&&(o.rotation.y=t.rotation),this.scene.add(o),this.objects.push(o)}loadObject(t,s){const e=this.objectTypes[t];if(!e)return;const i={w:s.w||e.w,h:s.h||e.h,d:s.d||e.d,color:s.color?parseInt(s.color):e.color,collision:e.collision,isRamp:s.isRamp||e.isRamp,isCylinder:s.isCylinder||e.isCylinder,isLight:e.isLight,transparent:e.transparent},o=this.createObjectMesh(t,i);o.position.x=s.x||0,o.position.z=s.z||0,o.position.y=i.h/2,s.ry&&(o.rotation.y=THREE.MathUtils.degToRad(s.ry)),this.scene.add(o),this.objects.push(o)}testView(){this.isTestMode=!this.isTestMode,this.isTestMode?(this.savedCameraState={distance:this.cameraDistance,angleX:this.cameraAngleX,angleY:this.cameraAngleY,target:this.cameraTarget.clone()},this.camera.position.set(0,10,0),this.testYaw=0,this.testPitch=0,document.getElementById("canvas").requestPointerLock(),document.getElementById("testMap").textContent="ÈÄÄÂá∫ÊµãËØï",document.getElementById("help").textContent="WASD: ÁßªÂä® | Èº†Ê†á: ËßÜËßí | ESC: ÈÄÄÂá∫ÊµãËØïÊ®°Âºè"):(document.exitPointerLock(),this.savedCameraState&&(this.cameraDistance=this.savedCameraState.distance,this.cameraAngleX=this.savedCameraState.angleX,this.cameraAngleY=this.savedCameraState.angleY,this.cameraTarget.copy(this.savedCameraState.target),this.updateCameraPosition()),document.getElementById("testMap").textContent="ÊµãËØïËßÜËßí",document.getElementById("help").textContent="WASD: ÁßªÂä® | Èº†Ê†áÂè≥ÈîÆ: ÊóãËΩ¨ËßÜËßí | ÊªöËΩÆ: Áº©Êîæ | Â∑¶ÈîÆ: ÈÄâÊã©/ÊîæÁΩÆ | Delete: Âà†Èô§ | R: ÊóãËΩ¨Áâ©‰ª∂")}onTestMouseMove(t){this.isTestMode&&document.pointerLockElement&&(this.testYaw-=.002*t.movementX,this.testPitch-=.002*t.movementY,this.testPitch=Math.max(-Math.PI/2+.1,Math.min(Math.PI/2-.1,this.testPitch)),this.camera.rotation.order="YXZ",this.camera.rotation.y=this.testYaw,this.camera.rotation.x=this.testPitch)}updateTestMovement(){if(!this.isTestMode)return;const t=new THREE.Vector3;this.keys.KeyW&&(t.z-=1),this.keys.KeyS&&(t.z+=1),this.keys.KeyA&&(t.x-=1),this.keys.KeyD&&(t.x+=1),t.length()>0&&(t.normalize(),t.applyAxisAngle(new THREE.Vector3(0,1,0),this.testYaw),this.camera.position.add(t.multiplyScalar(2)))}copyCode(){document.getElementById("code-output").select(),document.execCommand("copy"),alert("‰ª£Á†ÅÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥ÊùøÔºÅ")}closeModal(){document.getElementById("code-modal").classList.remove("active")}showPresetModal(){document.getElementById("preset-modal").classList.add("active")}closePresetModal(){document.getElementById("preset-modal").classList.remove("active")}async loadPresetMap(t){try{const s=await fetch(`maps/${t}.json`);if(!s.ok)throw new Error("Âú∞ÂõæÊñá‰ª∂‰∏çÂ≠òÂú®");const e=await s.json();this.loadMapData(e)}catch(t){alert("Âä†ËΩΩÈ¢ÑËÆæÂú∞ÂõæÂ§±Ë¥•: "+t.message)}}animate(){if(requestAnimationFrame(()=>this.animate()),this.isTestMode)return this.updateTestMovement(),void this.renderer.render(this.scene,this.camera);this.keys.KeyW&&(this.cameraTarget.z-=3*Math.cos(this.cameraAngleY),this.cameraTarget.x-=3*Math.sin(this.cameraAngleY)),this.keys.KeyS&&(this.cameraTarget.z+=3*Math.cos(this.cameraAngleY),this.cameraTarget.x+=3*Math.sin(this.cameraAngleY)),this.keys.KeyA&&(this.cameraTarget.x-=3*Math.cos(this.cameraAngleY),this.cameraTarget.z+=3*Math.sin(this.cameraAngleY)),this.keys.KeyD&&(this.cameraTarget.x+=3*Math.cos(this.cameraAngleY),this.cameraTarget.z-=3*Math.sin(this.cameraAngleY)),(this.keys.KeyW||this.keys.KeyS||this.keys.KeyA||this.keys.KeyD)&&this.updateCameraPosition(),this.renderer.render(this.scene,this.camera)}getMapData(){const t=document.getElementById("mapName").value||"custom_map",s=document.getElementById("mapDisplayName").value||"Ëá™ÂÆö‰πâÂú∞Âõæ",e=parseInt(document.getElementById("mapSize").value)||300,i=document.getElementById("gameMode"),o=Array.from(i.selectedOptions).map(t=>t.value),h={name:t,displayName:s,gameMode:o.length>0?o:["deathmatch"],mapSize:e,floorColor1:"#c4a574",floorColor2:"#a68b5b",wallColor1:"#95a5a6",wallColor2:"#7f8c8d",skyColor:7058393,objects:[],bombSites:{},spawnPoints:{ct:[],t:[]}},a=[],n=[];let c=null,r=null;return this.objects.forEach(t=>{const s=t.userData,e={type:s.type,x:Math.round(t.position.x),y:Math.round(t.position.y),z:Math.round(t.position.z),w:s.w,h:s.h,d:s.d,color:s.color,textureType:s.textureType};switch(0!==t.rotation.y&&(e.rotation=parseFloat(t.rotation.y.toFixed(3))),h.objects.push(e),s.type){case"bombsite_a":c={x:e.x,z:e.z,radius:Math.max(e.w,e.d)/2};break;case"bombsite_b":r={x:e.x,z:e.z,radius:Math.max(e.w,e.d)/2};break;case"spawn_ct":a.push({x:e.x,z:e.z});break;case"spawn_t":n.push({x:e.x,z:e.z})}}),c&&(h.bombSites.A=c),r&&(h.bombSites.B=r),h.spawnPoints={ct:a,t:n},h}showCloudSaveModal(){const t=this.getMapData();document.getElementById("cloud-save-id").textContent=t.name,document.getElementById("cloud-save-name").textContent=t.displayName,document.getElementById("cloud-save-count").textContent=this.objects.length+" ‰∏™",document.getElementById("cloud-save-status").style.display="none",document.getElementById("cloud-save-modal").classList.add("active")}closeCloudSaveModal(){document.getElementById("cloud-save-modal").classList.remove("active")}async confirmCloudSave(){const t=document.getElementById("cloud-save-status"),s=document.getElementById("confirm-cloud-save"),e=document.getElementById("cloud-save-password").value;if(!e)return t.textContent="‚úó ËØ∑ËæìÂÖ•ÂØÜÁ†Å",t.className="cloud-status error",void(t.style.display="block");t.textContent="Ê≠£Âú®‰øùÂ≠ò...",t.className="cloud-status",t.style.display="block",s.disabled=1;try{const s=this.getMapData();s.thumbnail=this.generateThumbnail(),await MapCloudService.saveMap(s,e),t.textContent="‚úì ‰øùÂ≠òÊàêÂäüÔºÅÊï∞ÊçÆÂêåÊ≠•‰∏≠ÔºåËØ∑Á®çÂêéÂà∑Êñ∞ÂàóË°®",t.className="cloud-status success",setTimeout(()=>{this.closeCloudSaveModal()},1500)}catch(s){t.textContent="‚úó "+s.message,t.className="cloud-status error"}finally{s.disabled=0}}generateThumbnail(){try{const t=this.renderer.domElement.width,s=this.renderer.domElement.height,e=this.camera.position.clone(),i=this.camera.aspect,o=parseInt(document.getElementById("mapSize").value)||300,h=256;this.renderer.setSize(h,h),this.camera.aspect=1,this.camera.updateProjectionMatrix();const a=1.8*o;this.camera.position.set(0,a,.01),this.camera.lookAt(0,0,0),this.renderer.render(this.scene,this.camera);const n=this.renderer.domElement.toDataURL("image/jpeg",.6);return this.renderer.setSize(t,s),this.camera.aspect=i,this.camera.updateProjectionMatrix(),this.camera.position.copy(e),this.updateCameraPosition(),console.log("Áº©Áï•ÂõæÁîüÊàêÊàêÂäüÔºåÂ§ßÂ∞è:",Math.round(n.length/1024),"KB"),n}catch(t){return console.error("ÁîüÊàêÁº©Áï•ÂõæÂ§±Ë¥•:",t),null}}showCloudModal(){document.getElementById("cloud-modal").classList.add("active"),this.loadCloudMapList()}closeCloudModal(){document.getElementById("cloud-modal").classList.remove("active")}async loadCloudMapList(){const t=document.getElementById("cloud-loading"),s=document.getElementById("cloud-error"),e=document.getElementById("cloud-empty"),i=document.getElementById("cloud-list");t.style.display="block",s.style.display="none",e.style.display="none",i.innerHTML="";try{const s=await MapCloudService.listMaps();if(t.style.display="none",0===s.length)return void(e.style.display="block");s.forEach(t=>{const s=document.createElement("div");s.className="cloud-map-item";const e=t.updatedAt?new Date(t.updatedAt).toLocaleString("zh-CN"):"",o=t.likes||0,h=t.thumbnail||"";s.innerHTML=`\n                    ${h?`<div class="cloud-map-thumbnail" data-thumb="${h}"><img src="${h}" alt="Áº©Áï•Âõæ"></div>`:'<div class="cloud-map-thumbnail no-thumb">Êó†È¢ÑËßà</div>'}\n                    <div class="cloud-map-info">\n                        <div class="cloud-map-name">${this.escapeHtml(t.displayName||t.name)}</div>\n                        <div class="cloud-map-id">${this.escapeHtml(t.id)}</div>\n                        ${e?`<div class="cloud-map-time">${e}</div>`:""}\n                    </div>\n                    <div class="cloud-map-actions">\n                        <button class="tool-btn cloud-like-btn ${this.hasLiked(t.id)?"liked":""}" data-id="${this.escapeHtml(t.id)}" ${this.hasLiked(t.id)?"disabled":""}>üëç <span class="like-count">${o}</span></button>\n                        <button class="tool-btn primary cloud-load-btn" data-id="${this.escapeHtml(t.id)}">Âä†ËΩΩ</button>\n                    </div>\n                `,i.appendChild(s)}),i.querySelectorAll(".cloud-load-btn").forEach(t=>{t.addEventListener("click",()=>this.loadCloudMap(t.dataset.id))}),i.querySelectorAll(".cloud-like-btn").forEach(t=>{t.addEventListener("click",()=>this.likeCloudMap(t.dataset.id,t))}),i.querySelectorAll(".cloud-map-thumbnail[data-thumb]").forEach(t=>{t.style.cursor="pointer",t.addEventListener("click",()=>this.showThumbnailPreview(t.dataset.thumb))})}catch(e){t.style.display="none",s.textContent=e.message,s.style.display="block"}}async likeCloudMap(t,s){if(this.hasLiked(t))alert("‰Ω†Â∑≤ÁªèÁÇπËµûËøáËøô‰∏™Âú∞Âõæ‰∫Ü");else try{s.disabled=1;const e=await MapCloudService.likeMap(t),i=s.querySelector(".like-count");i&&(i.textContent=e.likes),this.markAsLiked(t),s.classList.add("liked")}catch(t){alert("ÁÇπËµûÂ§±Ë¥•: "+t.message),s.disabled=0}}hasLiked(t){try{return JSON.parse(localStorage.getItem("likedMaps")||"[]").includes(t)}catch{return 0}}markAsLiked(t){try{const s=JSON.parse(localStorage.getItem("likedMaps")||"[]");s.includes(t)||(s.push(t),localStorage.setItem("likedMaps",JSON.stringify(s)))}catch{}}showThumbnailPreview(t){let s=document.getElementById("thumbnail-preview");s||(s=document.createElement("div"),s.id="thumbnail-preview",s.innerHTML='\n                <div class="thumb-preview-content">\n                    <img src="" alt="Âú∞ÂõæÈ¢ÑËßà">\n                    <button class="thumb-preview-close">‚úï</button>\n                </div>\n            ',s.addEventListener("click",t=>{(t.target===s||t.target.classList.contains("thumb-preview-close"))&&s.classList.remove("active")}),document.body.appendChild(s)),s.querySelector("img").src=t,s.classList.add("active")}async loadCloudMap(t){try{const s=await MapCloudService.getMap(t);this.loadMapData(s),this.closeCloudModal()}catch(t){alert("Âä†ËΩΩÂ§±Ë¥•: "+t.message)}}async deleteCloudMap(t){if(confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§Âú∞Âõæ "${t}" ÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ`))try{await MapCloudService.deleteMap(t),this.loadCloudMapList()}catch(t){alert("Âà†Èô§Â§±Ë¥•: "+t.message)}}escapeHtml(t){const s=document.createElement("div");return s.textContent=t,s.innerHTML}}window.addEventListener("DOMContentLoaded",()=>{window.editor=new MapEditor});